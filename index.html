<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Medical Biochemistry Assistant PRO</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>

        /* QC Accordion Styles */
.qc-card {
    background: var(--bg-card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
    margin-bottom: 15px;
    overflow: hidden;
    width: 100%;
}
.qc-header {
    padding: clamp(15px, 2.5vw, 20px);
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--bg-card);
    transition: background 0.2s;
    flex-wrap: wrap;
    gap: 10px;
}
.qc-header:hover {
    background: var(--bg-input);
}
.qc-header h3 {
    margin: 0;
    font-size: clamp(0.9rem, 2vw, 1rem);
    color: var(--primary);
}
.qc-body {
    display: none; /* Başlangıçta kapalı */
    padding: clamp(15px, 2.5vw, 20px);
    border-top: 1px solid var(--border-color);
    animation: fadeIn 0.3s;
    width: 100%;
}
.qc-header.active {
    background: var(--primary-light);
}
.qc-header.active h3 {
    color: var(--primary-dark);
}
        /* --- THEME --- */
        :root {
            --primary: #0d9488; --primary-dark: #0f766e; --primary-light: #ccfbf1;
            --bg-body: #f3f4f6; --bg-card: #ffffff; --bg-input: #f9fafb;
            --text-main: #111827; --text-light: #6b7280; --border-color: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --danger: #dc2626; --success: #16a34a; --radius: 16px;
            --warning-bg: #fff7ed; --warning-text: #9a3412; --warning-border: #fdba74;
            --header-bg: linear-gradient(135deg, #0d9488, #115e59);
        }
        [data-theme="dark"] {
            --primary: #2dd4bf; --primary-dark: #14b8a6; --primary-light: #134e4a;
            --bg-body: #111827; --bg-card: #1f2937; --bg-input: #374151;
            --text-main: #f9fafb; --text-light: #9ca3af; --border-color: #374151;
            --header-bg: linear-gradient(135deg, #134e4a, #042f2e);
            --warning-bg: #431407; --warning-text: #fed7aa; --warning-border: #9a3412;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg-body); color: var(--text-main); min-height: 100vh; display: flex; flex-direction: column; transition: background 0.3s; width: 100%; }

        /* HEADER */
        header { 
            width: 100%;
            background-color: #fff;
            background-image: linear-gradient(90deg, transparent 79px, #abced4 79px, #abced4 81px, transparent 81px), linear-gradient(#eee .1em, transparent .1em);
            background-size: 100% 1.2em;
            color: #374151; padding: 2.5rem 1rem; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; box-shadow: var(--shadow); text-align: center;
        }
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            text-align: center;
        }
        header h1 { font-size: clamp(1.4rem, 4vw, 1.8rem); font-weight: 900; letter-spacing: 1px; margin-bottom: 5px; color: #111827; text-shadow: 2px 2px 0px #fff; text-align: center; }
        header p { font-size: clamp(0.75rem, 2vw, 0.9rem); text-align: center; }

        /* NAV */
        .nav-tabs { 
            display: flex; 
            justify-content: center; 
            align-items: center;
            gap: 8px; 
            margin: -25px auto 20px auto; 
            background: var(--bg-card); 
            padding: 6px 15px; 
            border-radius: 20px; 
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.15); 
            border: 1px solid var(--border-color); 
            width: 100%;
            max-width: 1400px;
            box-sizing: border-box;
            position: relative; 
            z-index: 10; 
            flex-wrap: wrap;
        }
        
        @media (max-width: 600px) {
            .nav-tabs {
                padding: 6px 10px;
                gap: 6px;
                margin: -15px auto 15px auto;
                width: 100%;
                justify-content: center;
            }
        }
        .nav-btn { background: transparent; border: none; padding: 8px 12px; border-radius: 14px; color: var(--text-light); font-weight: 600; cursor: pointer; font-size: clamp(0.7rem, 1.5vw, 0.8rem); display: flex; align-items: center; gap: 5px; flex-direction: column; transition: all 0.2s; flex-shrink: 0; }
        .nav-btn i { font-size: clamp(1rem, 2.5vw, 1.2rem); margin-bottom: 2px; }
        .nav-btn.active { background-color: var(--primary-light); color: var(--primary-dark); }
        .nav-btn:hover { background-color: var(--bg-input); }
        .nav-btn.wide { padding: 8px 20px; }
        
        /* QC ve Notes sekmeleri - ÇOK DAHA GENİŞ - Responsive */
        .nav-tabs .nav-btn:nth-child(2),
        .nav-tabs .nav-btn:nth-child(4),
        button.nav-btn[onclick*="tab-qc"],
        button.nav-btn[onclick*="tab-notes"] {
            padding-left: 35px !important;
            padding-right: 35px !important;
            padding-top: 8px !important;
            padding-bottom: 8px !important;
            min-width: 130px !important;
            flex-basis: auto !important;
            flex-grow: 0 !important;
            flex-shrink: 0 !important;
        }
        
        /* Tablet ve Desktop (768px+) */
        @media (min-width: 768px) {
            .nav-tabs .nav-btn:nth-child(2),
            .nav-tabs .nav-btn:nth-child(4),
            button.nav-btn[onclick*="tab-qc"],
            button.nav-btn[onclick*="tab-notes"] {
                padding-left: 45px !important;
                padding-right: 45px !important;
                padding-top: 10px !important;
                padding-bottom: 10px !important;
                min-width: 150px !important;
            }
        }
        
        /* Büyük Desktop (1024px+) */
        @media (min-width: 1024px) {
            .nav-tabs .nav-btn:nth-child(2),
            .nav-tabs .nav-btn:nth-child(4),
            button.nav-btn[onclick*="tab-qc"],
            button.nav-btn[onclick*="tab-notes"] {
                padding-left: 55px !important;
                padding-right: 55px !important;
                min-width: 170px !important;
            }
        }
        
        /* Mobil (600px ve altı) */
        @media (max-width: 600px) {
            .nav-tabs .nav-btn:nth-child(2),
            .nav-tabs .nav-btn:nth-child(4),
            button.nav-btn[onclick*="tab-qc"],
            button.nav-btn[onclick*="tab-notes"] {
                padding-left: 15px !important;
                padding-right: 15px !important;
                min-width: 70px !important;
            }
        }
        
        /* Çok küçük ekranlar (480px ve altı) */
        @media (max-width: 480px) {
            .nav-tabs .nav-btn:nth-child(2),
            .nav-tabs .nav-btn:nth-child(4),
            button.nav-btn[onclick*="tab-qc"],
            button.nav-btn[onclick*="tab-notes"] {
                padding-left: 10px !important;
                padding-right: 10px !important;
                min-width: 60px !important;
            }
        }

        /* CONTAINER */
        .container { 
            width: 100%;
            max-width: 1600px;
            margin: 0 auto; 
            padding: 0 clamp(15px, 4vw, 40px) 40px clamp(15px, 4vw, 40px); 
            flex: 1; 
        }
        .section { display: none; width: 100%; } 
        .section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* UI ELEMENTS */
        .calculator-view { 
            background: var(--bg-card); 
            border-radius: var(--radius); 
            padding: clamp(15px, 3vw, 20px); 
            box-shadow: var(--shadow); 
            border: 1px solid var(--border-color); 
            margin-bottom: 20px; 
            display: none; 
            width: 100%;
        }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-weight: 600; font-size: clamp(0.8rem, 1.5vw, 0.85rem); margin-bottom: 5px; }
        .input-group input, .input-group select { width: 100%; padding: clamp(8px, 2vw, 10px); border-radius: 10px; border: 1px solid var(--border-color); background: var(--bg-input); color: var(--text-main); font-size: clamp(0.85rem, 1.5vw, 0.9rem); }
        .calc-input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: clamp(10px, 2vw, 15px); align-items: end; }
        .full-width { grid-column: span 2; }
        
        .btn-action { background: var(--primary); color: white; border: none; padding: clamp(10px, 2vw, 12px); border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; transition: 0.2s; font-size: clamp(0.85rem, 1.5vw, 0.9rem); }
        .btn-action:hover { background: var(--primary-dark); transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .btn-secondary { background: var(--bg-input); color: var(--text-main); border: 1px solid var(--border-color); }
        
        .chart-container { position: relative; height: clamp(300px, 40vh, 400px); width: 100%; margin-top: 20px; background: #fff; padding: 10px; border-radius: 12px; border: 1px solid #ddd; }
        .warning-box { background: var(--warning-bg); color: var(--warning-text); padding: clamp(12px, 2vw, 15px); border-radius: 12px; font-size: clamp(0.8rem, 1.5vw, 0.85rem); margin-top: 15px; border: 1px solid var(--warning-border); }
        
        /* Specific Calc Styles */
        .label-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; flex-wrap: wrap; gap: 5px; }
        .unit-badge { font-size: clamp(0.65rem, 1.3vw, 0.7rem); background: var(--bg-body); color: var(--primary); padding: 2px 6px; border-radius: 6px; cursor: pointer; border: 1px solid var(--primary-light); margin-left: auto; display: inline-flex; align-items: center; gap: 4px; transition: all 0.2s; }
        .unit-badge:hover { background: var(--primary-light); transform: scale(1.05); }
        .mini-result { font-size: clamp(0.85rem, 1.8vw, 0.9rem); font-weight: 600; color: var(--primary); margin-top: 5px; min-height: 1.2em; display: flex; justify-content: space-between; }
        .final-result-box { margin-top: 15px; border-top: 1px solid var(--border-color); padding-top: 10px; grid-column: span 2; font-weight: bold; color: var(--primary-dark); font-size: clamp(0.9rem, 2vw, 1rem); }
        .formula-display { font-size: clamp(0.65rem, 1.3vw, 0.7rem); color: var(--text-light); margin-top: 5px; font-family: monospace; display: block; width: 100%; text-align: right; opacity: 0.8; overflow-x: auto; }

        /* Radio Groups */
        .radio-vertical-group { display: flex; flex-direction: column; gap: clamp(6px, 1.2vw, 8px); margin-bottom: 15px; }
        .radio-option { display: flex; align-items: center; padding: clamp(8px, 1.5vw, 10px); border: 1px solid var(--border-color); border-radius: 10px; background: var(--bg-input); cursor: pointer; transition: all 0.2s; font-size: clamp(0.8rem, 1.5vw, 0.9rem); }
        .radio-option.selected { background: var(--primary-light); border-color: var(--primary); color: var(--primary-dark); font-weight: 600; }
        .radio-circle { width: clamp(14px, 2vw, 16px); height: clamp(14px, 2vw, 16px); border-radius: 50%; border: 2px solid var(--text-light); margin-right: clamp(8px, 1.5vw, 10px); position: relative; flex-shrink: 0; }
        .radio-option.selected .radio-circle { border-color: var(--primary); }
        .radio-option.selected .radio-circle::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: clamp(6px, 1.2vw, 8px); height: clamp(6px, 1.2vw, 8px); background: var(--primary); border-radius: 50%; }

        /* Menu Grid */
        .grid-menu { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: clamp(8px, 1.5vw, 10px); 
            width: 100%;
        }
        .calc-card-mini { 
            background: var(--bg-card); 
            padding: clamp(12px, 2vw, 15px); 
            border-radius: var(--radius); 
            text-align: center; 
            cursor: pointer; 
            border: 1px solid var(--border-color); 
            height: clamp(90px, 12vw, 110px); 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            box-shadow: var(--shadow); 
            transition: all 0.2s;
        }
        .calc-card-mini:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); border-color: var(--primary); }
        .calc-icon { font-size: clamp(1.4rem, 3vw, 1.8rem); color: var(--primary); margin-bottom: 8px; }
        .calc-title { font-size: clamp(0.7rem, 1.3vw, 0.75rem); font-weight: 600; line-height: 1.2; }

        /* Search */
        .search-container { position: relative; background: var(--bg-body); padding-bottom: 10px; z-index: 20; padding-top: 5px; width: 100%; }
        .suggestions-box { position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-card); border: 1px solid var(--border-color); z-index: 999; max-height: 250px; overflow-y: auto; display: none; border-radius: 10px; box-shadow: var(--shadow); }
        .suggestion-item { padding: clamp(10px, 1.5vw, 12px) clamp(12px, 2vw, 15px); border-bottom: 1px solid var(--border-color); cursor: pointer; display: flex; align-items: center; gap: 10px; font-weight: 500; font-size: clamp(0.8rem, 1.5vw, 0.9rem); }
        .suggestion-item:hover { background-color: var(--bg-input); }

        /* Manual Data Table */
        .data-list-container { 
            max-height: 200px; 
            overflow-x: auto;
            overflow-y: auto; 
            border: 1px solid var(--border-color); 
            border-radius: 10px; 
            margin-top: 10px; 
            background: var(--bg-input); 
            width: 100%;
        }
        .data-table { width: 100%; font-size: clamp(0.75rem, 1.5vw, 0.8rem); border-collapse: collapse; min-width: 300px; }
        .data-table th { background: var(--primary-light); padding: clamp(6px, 1.5vw, 8px); text-align: left; position: sticky; top: 0; z-index: 10; font-size: clamp(0.75rem, 1.5vw, 0.8rem); }
        .data-table td { padding: clamp(6px, 1.5vw, 8px); border-bottom: 1px solid var(--border-color); }
        
        /* Table Action Buttons */
        .action-group { display: flex; gap: clamp(4px, 1vw, 8px); justify-content: flex-end; align-items: center; flex-wrap: wrap; }
        .btn-icon { background: none; border: none; cursor: pointer; font-size: clamp(0.8rem, 1.5vw, 0.85rem); padding: 4px; transition: transform 0.2s; }
        .btn-icon:hover { transform: scale(1.2); }
        .btn-edit { color: #f59e0b; }
        .btn-move { color: var(--text-light); }
        .btn-delete { color: var(--danger); }

        /* Journal List */
        .journal-list { 
            max-height: clamp(300px, 50vh, 400px); 
            overflow-y: auto; 
            border: 1px solid var(--border-color); 
            border-radius: 10px; 
            background: var(--bg-card); 
            width: 100%; 
            display: grid;
            grid-template-columns: 1fr;
        }
        @media (max-width: 480px) {
            .journal-list { grid-template-columns: 1fr 1fr; }
            .journal-link { font-size: 0.7rem; padding: 8px; }
        }
        .journal-link { 
            display: block; 
            padding: clamp(10px, 1.5vw, 12px) clamp(12px, 2vw, 15px); 
            border-bottom: 1px solid var(--border-color); 
            color: var(--text-main); 
            text-decoration: none; 
            font-size: clamp(0.8rem, 1.5vw, 0.85rem); 
            font-weight: 500; 
            transition: all 0.2s; 
            height: 100%;
            display: flex;
            align-items: center;
        }
        .journal-link:hover { background-color: var(--primary-light); color: var(--primary-dark); padding-left: clamp(15px, 2.5vw, 20px); }
        .journal-link:last-child { border-bottom: none; }
        .external-link-card { cursor: pointer; transition: transform 0.2s; border: 1px solid var(--border-color); width: 100%; }
        .external-link-card:hover { transform: translateY(-2px); border-color: var(--primary); }

        /* Footer */
        footer { 
            width: 100%;
            padding: 15px clamp(15px, 4vw, 40px); 
            margin-top: auto; 
            border-top: 1px solid var(--border-color); 
            background: var(--bg-card); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            position: relative;
        }
        .footer-content {
            max-width: 1600px;
            width: 100%;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .footer-info {
            flex: 1;
            text-align: center;
        }
        .footer-info p {
            text-align: center;
        }
        .footer-controls {
            position: absolute;
            right: clamp(15px, 4vw, 40px);
        }
        .control-btn { background: var(--bg-input); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border-color); cursor: pointer; transition: all 0.2s; }
        .control-btn:hover { transform: scale(1.1); background: var(--primary-light); }
        .signature-link { text-decoration: none; display: inline-block; transition: transform 0.2s; }
        .signature-link:hover { transform: scale(1.05); }
        .signature-link .signature { cursor: pointer; text-decoration: underline; text-underline-offset: 3px; font-size: clamp(0.7rem, 1.5vw, 0.8rem); font-weight: 700; color: var(--primary); display: block; margin-top: 3px; text-align: center; }

        /* Responsive Design */
        @media (max-width: 480px) { 
            .grid-menu { grid-template-columns: repeat(2, 1fr); gap: 8px; } 
            .calc-card-mini { height: 85px; padding: 10px; }
            .calc-icon { font-size: 1.3rem; }
            .calc-title { font-size: 1rem; }
            .nav-tabs { margin: -15px auto 15px auto; padding: 4px 6px; gap: 3px; width: 96%; justify-content: center; }
            .nav-btn { padding: 6px 10px; font-size: 1rem; gap: 2px; }
            .nav-btn i { font-size: 1.2rem; }
            .nav-btn.wide { padding: 5px 12px; }
            header { padding: 1.5rem 1rem; }
            header h1 { font-size: 1.6rem; }
            header p { font-size: 1rem; }
            .container { padding: 0 10px 25px 10px; }
            .calculator-view { padding: 12px; }
            .chart-container { height: 250px; }
            .input-group label { font-size: 0.95rem; }
            .input-group input, .input-group select { font-size: 1rem; }
            .mini-result { font-size: 1rem; }
            .final-result-box { font-size: 1.1rem; }
            .data-table { font-size: 0.9rem; }
            .data-table th { font-size: 0.9rem; }
        }
        
        @media (min-width: 481px) and (max-width: 768px) { 
            .grid-menu { grid-template-columns: repeat(2, 1fr); } 
            footer { flex-direction: column; gap: 15px; }
            .footer-info { width: 100%; }
            .footer-controls { position: static; margin-top: 10px; }
            footer .footer-content { flex-direction: column; gap: 10px; text-align: center; } 
            .calc-input-grid { grid-template-columns: 1fr; } 
            .full-width { grid-column: span 1; } 
            .nav-tabs { margin: -20px auto 20px auto; padding: 4px 8px; gap: 4px; width: 90%; justify-content: center; }
            .nav-btn { padding: 6px 12px; font-size: 0.95rem; }
            .nav-btn.wide { padding: 6px 15px; }
            header { padding: 2rem 1rem; }
            .container { padding: 0 15px 30px 15px; }
            .chart-container { height: 300px; }
        }
        
        @media (max-width: 480px) {
            footer { flex-direction: column; gap: 15px; }
            .footer-info { width: 100%; }
            .footer-controls { position: static; margin-top: 10px; }
        }
        
        @media (min-width: 769px) and (max-width: 1024px) {
            .container { max-width: 100%; padding: 0 30px 40px 30px; }
            .grid-menu { grid-template-columns: repeat(3, 1fr); }
        }
        
        @media (min-width: 1025px) and (max-width: 1400px) {
            .container { max-width: 1400px; }
        }
        
        @media (min-width: 1401px) {
            .container { max-width: 1600px; }
        }
        
        /* Tablet Landscape and Desktop */
        @media (min-width: 769px) {
            .calc-input-grid { grid-template-columns: 1fr 1fr; }
            .full-width { grid-column: span 2; }
        }
    </style>
</head>
<body>

<header>
    <div class="header-content">
        <h1>BIOCHEMISTRY ASSISTANT</h1>
        <p>Professional Laboratory Tool</p>
    </div>
</header>

<div class="nav-tabs">
    <button class="nav-btn active" onclick="switchTab('tab-calc', this)"><i class="fa-solid fa-calculator"></i> Calc</button>
    <button class="nav-btn wide" onclick="switchTab('tab-qc', this)"><i class="fa-solid fa-chart-line"></i> QC</button>
    <button class="nav-btn" onclick="switchTab('tab-info', this)"><i class="fa-solid fa-book-medical"></i> Guide</button>
    <button class="nav-btn wide" onclick="switchTab('tab-notes', this)"><i class="fa-solid fa-sticky-note"></i> Notes</button>
</div>

<div class="container">
    
    <div id="tab-calc" class="section active">
        <div class="search-container">
            <div style="position:relative;">
                <input type="text" id="calcSearchInput" class="input-group" style="width:100%; padding:15px 15px 15px 40px; border-radius:30px; margin-bottom:0;" placeholder="Search calculator..." onkeyup="showCalcSuggestions()">
                <i class="fa-solid fa-search" style="position:absolute; left:15px; top:50%; transform:translateY(-50%); color:var(--text-light);"></i>
            </div>
            <div id="calcSuggestions" class="suggestions-box"></div>
        </div>
        
        <div id="calc-list-view">
            <div id="calc-menu" class="grid-menu"></div>
        </div>

        <div id="calc-detail-view" style="display: none;">
            <button class="btn-action btn-secondary" onclick="closeCalcDetail()" style="width:auto; margin-bottom:15px;"><i class="fa-solid fa-arrow-left"></i> Back to List</button>
            
            <div id="calc-spot-urine" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">Spot Urine Analysis</h3>
                <div class="calc-input-grid">
                    <div class="input-group full-width"><div class="label-row"><label>Spot Urine Creatinine</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">mg/dL</span></div><input type="number" id="spot-crea" placeholder="Required" oninput="calculateSpotUrine()"></div>
                    <div style="grid-column: span 2; border-top: 1px solid var(--border-color); margin: 5px 0 15px 0;"></div>
                    <div class="input-group"><div class="label-row"><label>Spot Protein</label><span class="unit-badge">mg/dL</span></div><input type="number" id="spot-prot" oninput="calculateSpotUrine()"><div id="res-spot-prot" class="mini-result"></div></div>
                    <div class="input-group"><div class="label-row"><label>Spot Albumin</label><span class="unit-badge">mg/dL</span></div><input type="number" id="spot-alb" oninput="calculateSpotUrine()"><div id="res-spot-alb" class="mini-result"></div></div>
                    <div class="input-group"><div class="label-row"><label>Spot Calcium</label><span class="unit-badge">mg/dL</span></div><input type="number" id="spot-ca" oninput="calculateSpotUrine()"><div id="res-spot-ca" class="mini-result"></div></div>
                    <div class="input-group"><div class="label-row"><label>Spot Sodium</label><span class="unit-badge">mmol/L</span></div><input type="number" id="spot-na" oninput="calculateSpotUrine()"><div id="res-spot-na" class="mini-result"></div></div>
                    <div class="input-group"><div class="label-row"><label>Spot Potassium</label><span class="unit-badge">mmol/L</span></div><input type="number" id="spot-k" oninput="calculateSpotUrine()"><div id="res-spot-k" class="mini-result"></div></div>
                    <div class="input-group"><div class="label-row"><label>Spot Chloride</label><span class="unit-badge">mmol/L</span></div><input type="number" id="spot-cl" oninput="calculateSpotUrine()"><div id="res-spot-cl" class="mini-result"></div></div>
                </div>
            </div>

            <div id="calc-urine24" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">24h Urine Calculation</h3>
                <div class="calc-input-grid">
                    <div class="input-group full-width"><div class="label-row"><label>Urine Volume</label><span class="unit-badge">mL</span></div><input type="number" id="uVol" placeholder="..." oninput="calculateUrineMulti()"></div>
                    <div style="grid-column: span 2; border-top: 1px solid var(--border-color); margin: 5px 0 15px 0;"></div>
                    <div class="input-group"><div class="label-row"><label>Urine Protein</label><span class="unit-badge">mg/dL</span></div><input type="number" id="uProt" oninput="calculateUrineMulti()"><div id="res-uProt" class="mini-result"></div></div>
                    <div class="input-group"><div class="label-row"><label>Urine Albumin</label><span class="unit-badge">mg/dL</span></div><input type="number" id="uAlb" oninput="calculateUrineMulti()"><div id="res-uAlb" class="mini-result"></div></div>
                    <div class="input-group"><div class="label-row"><label>Urine Creatinine</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">mg/dL</span></div><input type="number" id="uCrea" oninput="calculateUrineMulti()"><div id="res-uCrea" class="mini-result"></div></div>
                    <div class="input-group"><div class="label-row"><label>Urine Calcium</label><span class="unit-badge">mg/dL</span></div><input type="number" id="uCa" oninput="calculateUrineMulti()"><div id="res-uCa" class="mini-result"></div></div>
                </div>
            </div>

            <div id="calc-gfr" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">GFR Calculator</h3>
                <div class="calc-input-grid">
                    <div class="input-group full-width">
                        <label style="margin-bottom:5px;">Select Method</label>
                        <select id="gfr-method" onchange="updateGFRInputs()">
                            <option value="2021-crea">2021 CKD-EPI Creatinine (Recommended)</option>
                            <option value="2021-combo">2021 CKD-EPI Creatinine-Cystatin C</option>
                            <option value="2009-crea">2009 CKD-EPI Creatinine</option>
                            <option value="2012-cys">2012 CKD-EPI Cystatin C</option>
                            <option value="2012-combo">2012 CKD-EPI Creatinine-Cystatin C</option>
                            <option value="mdrd">MDRD Study Equation</option>
                            <option value="cockcroft">Cockcroft-Gault</option>
                        </select>
                    </div>

                    <div class="input-group full-width">
                        <label style="margin-bottom:10px;">Gender</label>
                        <div class="radio-vertical-group" style="flex-direction:row;">
                            <div id="btn-gender-female" class="radio-option selected" style="flex:1; justify-content:center;" onclick="setCkdGender('female')">Female</div>
                            <div id="btn-gender-male" class="radio-option" style="flex:1; justify-content:center;" onclick="setCkdGender('male')">Male</div>
                        </div>
                    </div>

                    <div class="input-group full-width" id="grp-race" style="display:none;">
                        <label style="margin-bottom:10px;">Race</label>
                        <div class="radio-vertical-group" style="flex-direction:row;">
                            <div id="btn-race-other" class="radio-option selected" style="flex:1; justify-content:center;" onclick="setCkdRace('other')">Non-Black / Other</div>
                            <div id="btn-race-black" class="radio-option" style="flex:1; justify-content:center;" onclick="setCkdRace('black')">Black</div>
                        </div>
                    </div>

                    <div class="input-group full-width">
                        <div class="label-row"><label>Age</label><span class="unit-badge">Year</span></div>
                        <input type="number" id="gfr-age" oninput="calculateGFR_Selected()">
                    </div>

                    <div class="input-group full-width" id="grp-weight" style="display:none;">
                        <div class="label-row"><label>Weight</label><span class="unit-badge">kg</span></div>
                        <input type="number" id="gfr-weight" oninput="calculateGFR_Selected()">
                    </div>

                    <div class="input-group" id="grp-crea">
                        <div class="label-row"><label>Serum Creatinine</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">mg/dL <i class="fa-solid fa-rotate"></i></span></div>
                        <input type="number" step="0.01" id="gfr-crea" oninput="calculateGFR_Selected()">
                    </div>

                    <div class="input-group" id="grp-cys" style="display:none;">
                        <div class="label-row"><label>Cystatin C</label><span class="unit-badge">mg/L</span></div>
                        <input type="number" step="0.01" id="gfr-cys" oninput="calculateGFR_Selected()">
                    </div>

                    <div id="res-gfr-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-ldl" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">LDL Calculator</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>Total Cholesterol</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">mg/dL <i class="fa-solid fa-rotate"></i></span></div><input type="number" id="ldl-tot" oninput="calculateLDL()"></div>
                    <div class="input-group"><div class="label-row"><label>HDL</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">mg/dL <i class="fa-solid fa-rotate"></i></span></div><input type="number" id="ldl-hdl" oninput="calculateLDL()"></div>
                    <div class="input-group"><div class="label-row"><label>Triglyceride</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">mg/dL <i class="fa-solid fa-rotate"></i></span></div><input type="number" id="ldl-trig" oninput="calculateLDL()"></div>
                    <div id="res-ldl-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-homa" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">HOMA-IR</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>Fasting Glucose</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">mg/dL <i class="fa-solid fa-rotate"></i></span></div><input type="number" id="homa-glu" oninput="calculateHoma()"></div>
                    <div class="input-group"><div class="label-row"><label>Fasting Insulin</label><span class="unit-badge">µIU/mL</span></div><input type="number" id="homa-ins" oninput="calculateHoma()"></div>
                    <div id="res-homa-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-schwartz" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">Schwartz Formula</h3>
                <div class="radio-vertical-group">
                    <div class="radio-option" onclick="setSchwartzK(0.33, this)"><div class="radio-circle"></div><span>Low Birth Weight</span></div>
                    <div class="radio-option" onclick="setSchwartzK(0.45, this)"><div class="radio-circle"></div><span>Term Infant</span></div>
                    <div class="radio-option selected" onclick="setSchwartzK(0.55, this)"><div class="radio-circle"></div><span>Child / Girl</span></div>
                    <div class="radio-option" onclick="setSchwartzK(0.70, this)"><div class="radio-circle"></div><span>Adolescent Boy</span></div>
                </div>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>Serum Creatinine</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">mg/dL</span></div><input type="number" id="sch-crea" oninput="calculateSchwartz()"></div>
                    <div class="input-group"><div class="label-row"><label>Height</label><span class="unit-badge">cm</span></div><input type="number" id="sch-height" oninput="calculateSchwartz()"></div>
                    <div id="res-schwartz-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-fib4" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">FIB-4 Score</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>Age</label></div><input type="number" id="fib-age" oninput="calculateFIB4()"></div>
                    <div class="input-group"><div class="label-row"><label>Platelets</label><span class="unit-badge">10³/µL</span></div><input type="number" id="fib-plt" oninput="calculateFIB4()"></div>
                    <div class="input-group"><div class="label-row"><label>AST</label><span class="unit-badge">U/L</span></div><input type="number" id="fib-ast" oninput="calculateFIB4()"></div>
                    <div class="input-group"><div class="label-row"><label>ALT</label><span class="unit-badge">U/L</span></div><input type="number" id="fib-alt" oninput="calculateFIB4()"></div>
                    <div id="res-fib4-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-corr-na" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">Corrected Sodium</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>Measured Sodium</label><span class="unit-badge">mEq/L</span></div><input type="number" id="na-meas" oninput="calculateCorrNa()"></div>
                    <div class="input-group"><div class="label-row"><label>Glucose</label><span class="unit-badge">mg/dL</span></div><input type="number" id="na-glu" oninput="calculateCorrNa()"></div>
                    <div id="res-na-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-calcium" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">Corrected Calcium</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>Total Calcium</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">mg/dL <i class="fa-solid fa-rotate"></i></span></div><input type="number" id="ca-tot" oninput="calculateCa()"></div>
                    <div class="input-group"><div class="label-row"><label>Albumin</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">g/dL <i class="fa-solid fa-rotate"></i></span></div><input type="number" id="ca-alb" oninput="calculateCa()"></div>
                    <div id="res-ca-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-corr-mg" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">Corrected Magnesium</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>Measured Mg</label><span class="unit-badge">mg/dL</span></div><input type="number" id="mg-meas" oninput="calculateCorrMg()"></div>
                    <div class="input-group"><div class="label-row"><label>Albumin</label><span class="unit-badge">g/dL</span></div><input type="number" id="mg-alb" oninput="calculateCorrMg()"></div>
                    <div id="res-mg-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-anion" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">Serum Anion Gap</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>Na (Sodium)</label><span class="unit-badge">mEq/L</span></div><input type="number" id="ag-na" oninput="calculateAnionGap()"></div>
                    <div class="input-group"><div class="label-row"><label>Cl (Chloride)</label><span class="unit-badge">mEq/L</span></div><input type="number" id="ag-cl" oninput="calculateAnionGap()"></div>
                    <div class="input-group"><div class="label-row"><label>HCO3</label><span class="unit-badge">mEq/L</span></div><input type="number" id="ag-hco3" oninput="calculateAnionGap()"></div>
                    <div id="res-ag-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-osmo" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">Serum Osmolality</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>Na (Sodium)</label><span class="unit-badge">mEq/L</span></div><input type="number" id="osmo-na" oninput="calculateOsmo()"></div>
                    <div class="input-group"><div class="label-row"><label>Glucose</label><span class="unit-badge">mg/dL</span></div><input type="number" id="osmo-glu" oninput="calculateOsmo()"></div>
                    <div class="input-group"><div class="label-row"><label>BUN</label><span class="unit-badge">mg/dL</span></div><input type="number" id="osmo-bun" oninput="calculateOsmo()"></div>
                    <div id="res-osmo-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-saag" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">SAAG</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>Serum Albumin</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">g/dL <i class="fa-solid fa-rotate"></i></span></div><input type="number" id="saag-serum" oninput="calculateSAAG()"></div>
                    <div class="input-group"><div class="label-row"><label>Ascites Albumin</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">g/dL <i class="fa-solid fa-rotate"></i></span></div><input type="number" id="saag-ascites" oninput="calculateSAAG()"></div>
                    <div id="res-saag-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-ph" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">pH Estimation</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>HCO3</label><span class="unit-badge">mmol/L</span></div><input type="number" id="ph-hco3" oninput="calculatePH()"></div>
                    <div class="input-group"><div class="label-row"><label>pCO2</label><span class="unit-badge">mmHg</span></div><input type="number" id="ph-pco2" oninput="calculatePH()"></div>
                    <div id="res-ph-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-mentzer" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">Mentzer Index</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>MCV</label><span class="unit-badge">fL</span></div><input type="number" id="men-mcv" oninput="calculateMentzer()"></div>
                    <div class="input-group"><div class="label-row"><label>RBC</label><span class="unit-badge">10⁶/µL</span></div><input type="number" id="men-rbc" oninput="calculateMentzer()"></div>
                    <div id="res-mentzer-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-albglob" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">Alb/Glob Ratio</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>Albumin</label><span class="unit-badge">g/dL</span></div><input type="number" id="ag-alb" oninput="calculateAlbGlob()"></div>
                    <div class="input-group"><div class="label-row"><label>Total Protein</label><span class="unit-badge">g/dL</span></div><input type="number" id="ag-tp" oninput="calculateAlbGlob()"></div>
                    <div id="res-albglob-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-rbc" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">RBC Indices</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>Hgb</label><span class="unit-badge">g/dL</span></div><input type="number" id="rbc-hgb" oninput="calculateRBCIndices()"></div>
                    <div class="input-group"><div class="label-row"><label>Hct</label><span class="unit-badge">%</span></div><input type="number" id="rbc-hct" oninput="calculateRBCIndices()"></div>
                    <div class="input-group"><div class="label-row"><label>RBC</label><span class="unit-badge">10⁶/µL</span></div><input type="number" id="rbc-count" oninput="calculateRBCIndices()"></div>
                    <div id="res-rbc-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-retic" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">Corrected Reticulocyte</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>Reticulocyte %</label><span class="unit-badge">%</span></div><input type="number" id="ret-pct" oninput="calculateRetic()"></div>
                    <div class="input-group"><div class="label-row"><label>Hct</label><span class="unit-badge">%</span></div><input type="number" id="ret-hct" oninput="calculateRetic()"></div>
                    <div id="res-retic-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-inr" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">INR Calculator</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>PT (Patient)</label><span class="unit-badge">sec</span></div><input type="number" id="inr-pt" oninput="calculateINR()"></div>
                    <div class="input-group"><div class="label-row"><label>PT (Control)</label><span class="unit-badge">sec</span></div><input type="number" id="inr-control" oninput="calculateINR()"></div>
                    <div class="input-group"><div class="label-row"><label>ISI</label><span class="unit-badge">-</span></div><input type="number" id="inr-isi" value="1.0" oninput="calculateINR()"></div>
                    <div id="res-inr-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-bun-crea" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">BUN/Creatinine Ratio</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>BUN</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">mg/dL <i class="fa-solid fa-rotate"></i></span></div><input type="number" id="bc-bun" oninput="calculateBunCrea()"></div>
                    <div class="input-group"><div class="label-row"><label>Creatinine</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">mg/dL <i class="fa-solid fa-rotate"></i></span></div><input type="number" id="bc-crea" oninput="calculateBunCrea()"></div>
                    <div id="res-bun-crea-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-h-ion" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">ABG Validation [H+]</h3>
                <div class="calc-input-grid">
                    <div class="input-group full-width"><div class="label-row"><label>Measured pH</label></div><input type="number" id="h-ph" oninput="calculateHIon()"></div>
                    <div class="input-group"><div class="label-row"><label>pCO2</label><span class="unit-badge">mmHg</span></div><input type="number" id="h-pco2" oninput="calculateHIon()"></div>
                    <div class="input-group"><div class="label-row"><label>HCO3</label><span class="unit-badge">mmol/L</span></div><input type="number" id="h-hco3" oninput="calculateHIon()"></div>
                    <div id="res-h-ion-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-fai" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">FAI (Free Androgen)</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>Total Testosterone</label><span class="unit-badge" onclick="toggleUnit(this)">ng/dL <i class="fa-solid fa-rotate"></i></span></div><input type="number" id="fai-tt" oninput="calculateFAI()"></div>
                    <div class="input-group"><div class="label-row"><label>SHBG</label><span class="unit-badge">nmol/L</span></div><input type="number" id="fai-shbg" oninput="calculateFAI()"></div>
                    <div id="res-fai-final" class="final-result-box"></div>
                    <div class="warning-box"><span class="warning-title"><i class="fa-solid fa-info-circle"></i> INFO:</span> Calculation uses (TT/SHBG)*100. Ensure units are converted if necessary.</div>
                </div>
            </div>

            <div id="calc-fpsa" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">Free PSA %</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>Free PSA</label><span class="unit-badge">ng/mL</span></div><input type="number" id="fpsa-free" oninput="calculateFPSA()"></div>
                    <div class="input-group"><div class="label-row"><label>Total PSA</label><span class="unit-badge">ng/mL</span></div><input type="number" id="fpsa-total" oninput="calculateFPSA()"></div>
                    <div id="res-fpsa-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-ca-ion" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">Est. Ionized Calcium</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>Total Calcium</label><span class="unit-badge">mg/dL</span></div><input type="number" id="cai-ca" oninput="calculateCaIon()"></div>
                    <div class="input-group"><div class="label-row"><label>Total Protein</label><span class="unit-badge">g/dL</span></div><input type="number" id="cai-tp" oninput="calculateCaIon()"></div>
                    <div id="res-ca-ion-final" class="final-result-box"></div>
                    <div style="grid-column: span 2; font-size: 0.75rem; color: var(--text-light); margin-top: 5px; text-align: center;">Ref: 4.4–5.3 mg/dL</div>
                </div>
            </div>

            <div id="calc-a1c" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">HbA1c Converter</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>% (NGSP)</label><span class="unit-badge">%</span></div><input type="number" id="a1c-ngsp" oninput="calculateA1c('ngsp')"></div>
                    <div class="input-group"><div class="label-row"><label>mmol/mol (IFCC)</label><span class="unit-badge">mmol/mol</span></div><input type="number" id="a1c-ifcc" oninput="calculateA1c('ifcc')"></div>
                    <div style="grid-column: span 2; font-size: 0.8rem; color: var(--text-light); margin-top: 15px; text-align: center;"><span class="formula-display">Formula: NGSP = (0.09148 × IFCC) + 2.152</span></div>
                </div>
            </div>

        </div>
    </div>

    <div id="tab-qc" class="section">
    
    <div class="qc-card">
        <div class="qc-header" onclick="toggleQC('qc-lj', this)">
            <h3><i class="fa-solid fa-chart-line"></i> Levey-Jennings Simulator</h3>
            <i class="fa-solid fa-chevron-down"></i>
        </div>
        <div id="qc-lj" class="qc-body">
            <div class="calc-input-grid">
                <div class="input-group"><label>Target (Mean)</label><input type="number" id="lj-mean" value="100"></div>
                <div class="input-group"><label>SD</label><input type="number" id="lj-sd" value="5"></div>
            </div>
            
            <div class="input-group" style="margin-top:15px;">
                <label>Control Limits:</label>
                <div style="display:flex; gap:20px; margin-top:8px;">
                    <label style="display:flex; align-items:center; gap:5px; cursor:pointer;">
                        <input type="radio" name="lj-limits" value="2" checked onchange="updateLJLimits()">
                        <span>±2SD</span>
                    </label>
                    <label style="display:flex; align-items:center; gap:5px; cursor:pointer;">
                        <input type="radio" name="lj-limits" value="3" onchange="updateLJLimits()">
                        <span>±3SD</span>
                    </label>
                </div>
            </div>
            
            <div class="input-group" style="margin-bottom: 15px;">
                <div style="display:flex; gap:10px;">
                    <button class="btn-action btn-secondary" style="flex:1;" onclick="triggerLJExcelInput()">
                        <i class="fa-solid fa-file-excel"></i> Upload Excel
                    </button>
                    <input type="file" id="lj-excel-upload" accept=".xlsx, .xls" style="display:none;" onchange="handleLJExcelUpload(this)">
                    
                    <button class="btn-action btn-secondary" style="flex:1;" onclick="downloadLJTemplate()">
                        <i class="fa-solid fa-download"></i> Template
                    </button>
                </div>
            </div>

            <div class="input-group">
                <div style="display:flex; gap:10px;">
                    <input type="number" id="lj-val" placeholder="Manual Value...">
                    <button class="btn-action" style="width:auto; margin:0;" onclick="addLJPoint()">Add</button>
                </div>
            </div>
            
            <div style="max-height:150px; overflow-y:auto; border:1px solid var(--border-color); margin-bottom:10px; margin-top:10px;">
                <table class="data-table">
                    <thead style="background:var(--primary-light); position:sticky; top:0;"><tr><th>No</th><th>Value</th><th>...</th></tr></thead>
                    <tbody id="lj-data-tbody"></tbody>
                </table>
            </div>
            <div style="text-align:right;"><button class="btn-secondary" style="padding:2px 8px; font-size:0.7rem;" onclick="clearLJData()">Clear</button></div>
            
            <button class="btn-action" onclick="runLeveyJennings()" style="margin-top:15px; margin-bottom:15px;">CALCULATE & PLOT</button>
            
            <div class="chart-container"><canvas id="ljChart"></canvas></div>
            <button class="btn-action btn-secondary" onclick="downloadHighResChart('ljChart')" style="margin-top:10px;"><i class="fa-solid fa-download"></i> Download Chart (HD)</button>
        </div>
    </div>

    <div class="qc-card">
        <div class="qc-header" onclick="toggleQC('qc-pbrtqc', this)">
            <h3><i class="fa-solid fa-chart-area"></i> PBRTQC (EWMA & MA)</h3>
            <i class="fa-solid fa-chevron-down"></i>
        </div>
        <div id="qc-pbrtqc" class="qc-body">
            <div class="calc-input-grid">
                <div class="input-group full-width">
                    <label>Analyte</label>
                    <select id="pbrtqc-analyte" onchange="updatePBRTQCConfig()"></select>
                </div>
                <div class="input-group" id="unit-group" style="display:none;">
                    <label>Unit</label>
                    <select id="pbrtqc-unit" onchange="updatePBRTQCConfig()"></select>
                </div>
            </div>

            <div id="custom-params" style="display:none; background:var(--bg-input); padding:10px; border-radius:10px; margin-bottom:15px;">
                <div class="calc-input-grid">
                    <div class="input-group"><label>CVi (%)</label><input type="number" id="cust-cvi" value="5"></div>
                    <div class="input-group"><label>CVg (%)</label><input type="number" id="cust-cvg" value="10"></div>
                    <div class="input-group"><label>Low Limit</label><input type="number" id="cust-l" value="0"></div>
                    <div class="input-group"><label>High Limit</label><input type="number" id="cust-u" value="100"></div>
                </div>
            </div>

            <div class="input-group">
                <label>Method</label>
                <select id="pbrtqc-method" onchange="togglePBRTQCParams()">
                    <option value="auto">✨ Auto (Optimal)</option>
                    <option value="ewma">EWMA</option>
                    <option value="ma">MA</option>
                </select>
            </div>

            <div id="param-container" style="background:var(--bg-input); padding:10px; border-radius:10px; margin-bottom:15px;">
                <div class="input-group" id="param-mode-group">
                    <label>Parameter Mode</label>
                    <select id="param-mode" onchange="toggleManualParams()">
                        <option value="auto">Auto (From Table)</option>
                        <option value="manual">Manual Entry</option>
                    </select>
                </div>
                
                <div id="manual-params" style="display:none; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div class="ewma-only input-group"><label>Lambda (λ)</label><input type="number" id="manual-lambda" step="0.01"></div>
                    <div class="ewma-only input-group"><label>Limit (L)</label><input type="number" id="manual-l" step="0.1"></div>
                    <div class="ma-only input-group"><label>Window (w)</label><input type="number" id="manual-w" step="1"></div>
                </div>
                <div id="auto-param-display" style="font-size:0.8rem; color:var(--primary); font-weight:bold;"></div>
            </div>

            <div class="input-group">
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <button class="btn-action btn-secondary" style="flex:1;" onclick="triggerExcelInput()">
                        <i class="fa-solid fa-file-excel"></i> Upload Excel
                    </button>
                    
                    <input type="file" id="excel-upload" accept=".xlsx, .xls" style="display:none;" onchange="handleExcelUpload(this)">
                    
                    <button class="btn-action btn-secondary" style="flex:1;" onclick="downloadTemplate()">
                        <i class="fa-solid fa-download"></i> Template
                    </button>
                </div>
                
                <div style="display:flex; gap:10px;">
                    <input type="number" id="single-val-input" placeholder="Enter manual value..." style="flex:1;">
                    <button class="btn-action" style="width:auto; margin:0; padding:0 20px;" onclick="addManualValue()">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                </div>
            </div>

            <div style="max-height:150px; overflow-y:auto; border:1px solid var(--border-color); margin-bottom:10px;">
                <table class="data-table">
                    <thead style="background:var(--primary-light); position:sticky; top:0;"><tr><th>No</th><th>Value</th><th>...</th></tr></thead>
                    <tbody id="manual-data-tbody"></tbody>
                </table>
            </div>
            <div style="text-align:right;"><button class="btn-secondary" style="padding:2px 8px; font-size:0.7rem;" onclick="clearManualData()">Clear</button></div>

            <div style="display:flex; gap:10px; margin-top:10px;">
                <label><input type="checkbox" id="opt-trunc" checked> <span>Truncation (RCV)</span></label>
                <label><input type="checkbox" id="opt-norm" checked> <span>Log Trans.</span></label>
            </div>

            <button class="btn-action" onclick="runPBRTQC()">CALCULATE & PLOT</button>

            <div id="qc-result-area" style="display:none;">
                <div class="chart-container"><canvas id="qcChart"></canvas></div>
                <div id="qc-stats" class="warning-box" style="display:block; margin-top:10px;"></div>
                <button class="btn-action btn-secondary" onclick="downloadHighResChart('qcChart')"><i class="fa-solid fa-download"></i> Download Chart (HD)</button>
            </div>
        </div>
    </div>
</div>

    <div id="tab-info" class="section">
        <div class="calculator-view" style="display:block;">
            <h3>Laboratory Handbook</h3>
            <p>Tube color codes, critical values, and procedures.</p>
            <button class="btn-action" onclick="window.open('https://drive.google.com/drive/folders/1dayFfTfZdNzpzFO80tXyA1vU5qtAsBvP?usp=drive_link')">Google Drive <i class="fa-solid fa-arrow-up-right-from-square"></i></button>
        </div>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;">
            <div class="calculator-view external-link-card" style="display:block; margin:0; padding:15px; text-align:center;" onclick="window.open('https://www.mayocliniclabs.com', '_blank')">
                <i class="fa-solid fa-microscope" style="font-size:2rem; color:var(--primary); margin-bottom:10px;"></i>
                <h4 style="font-size:0.9rem;">Mayo Clinic Labs</h4>
                <span style="font-size:0.7rem; color:var(--text-light);">Test Catalog</span>
            </div>
            <div class="calculator-view external-link-card" style="display:block; margin:0; padding:15px; text-align:center;" onclick="window.open('https://clinical-laboratory-diagnostics.com/', '_blank')">
                <i class="fa-solid fa-book-medical" style="font-size:2rem; color:var(--primary); margin-bottom:10px;"></i>
                <h4 style="font-size:0.9rem;">Clinical Lab Diagnostics</h4>
                <span style="font-size:0.7rem; color:var(--text-light);">Online Textbook</span>
            </div>
        </div>

        <div class="calculator-view" style="display:block; margin-top:15px;">
            <h3 style="color:var(--primary); margin-bottom:15px; border-bottom:1px solid var(--border-color); padding-bottom:10px;">
                <i class="fa-solid fa-newspaper"></i> Journals
            </h3>
            <div id="pubmedJournalWidget" style="display:block; margin-bottom:15px;">
                <div style="display:flex; gap:10px; align-items:center; margin-bottom:6px;">
                    <span style="font-size:0.85rem; color:var(--text-light);">Please select the journals you wish to follow and the number of recent articles to display, then click Lab Digest to continue.</span>
                </div>
                <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px; flex-wrap:nowrap; justify-content:flex-start;">
                    <select id="pubmedCountSelect" class="input-group" style="width:160px; padding:10px; border-radius:8px; height:42px; margin:0;">
                        <option value="5">Last 5</option>
                        <option value="10">Last 10</option>
                        <option value="15">Last 15</option>
                        <option value="20">Last 20</option>
                        <option value="30">Last 30</option>
                    </select>
                    <button class="btn-action" onclick="loadPubMedJournalsLatest()" style="width:auto; margin:0; padding:0 20px; height:42px; display:inline-flex; align-items:center; gap:12px;">
                        <i class="fa-solid fa-flask"></i>
                        <span>Lab Digest</span>
                    </button>
                </div>
                <div id="pubmedJournalResults" style="border:1px solid var(--border-color); border-radius:10px; background:var(--bg-card); padding:10px; max-height:300px; overflow-y:auto;"></div>
            </div>
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                <input id="journalSearchInput" class="input-group" type="text" placeholder="Search journals" style="flex:1; padding:10px; border-radius:8px;" oninput="filterJournalLists()">
            </div>
            <div class="journal-list" id="rssJournalList">
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap; line-height:1;">
                    <button data-journal="Clinical Chemistry" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px; vertical-align:middle;" onclick="toggleFav('Clinical Chemistry', this)"></button>
                    <a href="https://academic.oup.com/clinchem" target="_blank" class="journal-link">Clinical Chemistry</a>
                </div>
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap; line-height:1;">
                    <button data-journal="American Journal of Clinical Pathology" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px; vertical-align:middle;" onclick="toggleFav('American Journal of Clinical Pathology', this)"></button>
                    <a href="https://academic.oup.com/ajcp" target="_blank" class="journal-link">American Journal of Clinical Pathology</a>
                </div>
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap;">
                    <button data-journal="Annals of Clinical Biochemistry" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px;" onclick="toggleFav('Annals of Clinical Biochemistry', this)"></button>
                    <a href="https://journals.sagepub.com/home/acb" target="_blank" class="journal-link">Annals of Clinical Biochemistry</a>
                </div>
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap;">
                    <button data-journal="Annals of Laboratory Medicine" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px;" onclick="toggleFav('Annals of Laboratory Medicine', this)"></button>
                    <a href="https://www.annlabmed.org/main.html" target="_blank" class="journal-link">Annals of Laboratory Medicine</a>
                </div>
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap;">
                    <button data-journal="Biochemia Medica" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px;" onclick="toggleFav('Biochemia Medica', this)"></button>
                    <a href="https://www.biochemia-medica.com/en" target="_blank" class="journal-link">Biochemia Medica</a>
                </div>
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap; line-height:1;">
                    <button data-journal="Clinica Chimica Acta" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px;" onclick="toggleFav('Clinica Chimica Acta', this)"></button>
                    <a href="https://www.sciencedirect.com/journal/clinica-chimica-acta" target="_blank" class="journal-link">Clinica Chimica Acta</a>
                </div>
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap; line-height:1;">
                    <button data-journal="Clinical Laboratory" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px;" onclick="toggleFav('Clinical Laboratory', this)"></button>
                    <a href="https://www.clin-lab-publications.com/" target="_blank" class="journal-link">Clinical Laboratory</a>
                </div>
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap; line-height:1;">
                    <button data-journal="Clinical Chemistry and Laboratory Medicine" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px;" onclick="toggleFav('Clinical Chemistry and Laboratory Medicine', this)"></button>
                    <a href="https://www.degruyterbrill.com/journal/key/cclm/html" target="_blank" class="journal-link">Clinical Chemistry and Laboratory Medicine</a>
                </div>
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap; line-height:1;">
                    <button data-journal="Critical Reviews in Clinical Laboratory Sciences" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px;" onclick="toggleFav('Critical Reviews in Clinical Laboratory Sciences', this)"></button>
                    <a href="https://www.tandfonline.com/journals/ilab20" target="_blank" class="journal-link">Critical Reviews in Clinical Laboratory Sciences</a>
                </div>
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap; line-height:1;">
                    <button data-journal="eJIFCC" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px;" onclick="toggleFav('eJIFCC', this)"></button>
                    <a href="https://pmc.ncbi.nlm.nih.gov/journals/?term=%22EJIFCC%22" target="_blank" class="journal-link">eJIFCC</a>
                </div>
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap; line-height:1;">
                    <button data-journal="International Journal of Analytical Chemistry" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px;" onclick="toggleFav('International Journal of Analytical Chemistry', this)"></button>
                    <a href="https://onlinelibrary.wiley.com/journal/7072" target="_blank" class="journal-link">International Journal of Analytical Chemistry</a>
                </div>
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap; line-height:1;">
                    <button data-journal="Journal of Analytical Toxicology" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px;" onclick="toggleFav('Journal of Analytical Toxicology', this)"></button>
                    <a href="https://academic.oup.com/jat" target="_blank" class="journal-link">Journal of Analytical Toxicology</a>
                </div>
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap; line-height:1;">
                    <button data-journal="Journal of Clinical Laboratory Analysis" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px;" onclick="toggleFav('Journal of Clinical Laboratory Analysis', this)"></button>
                    <a href="https://onlinelibrary.wiley.com/journal/10982825" target="_blank" class="journal-link">Journal of Clinical Laboratory Analysis</a>
                </div>
            </div>
            <h4 style="font-size:0.85rem; color:var(--text-light); margin:10px 0 6px 0;">Also visit journals</h4>
            <div class="journal-list" id="visitJournalList">
                <div style="white-space:nowrap;">
                    <a href="https://www.bslonline.org/main.html" target="_blank" class="journal-link">Biomedical Science Letters</a>
                </div>
                <div style="white-space:nowrap;">
                    <a href="https://jlpm.amegroups.org/" target="_blank" class="journal-link">Journal of Laboratory and Precision Medicine</a>
                </div>
                <div style="white-space:nowrap;">
                    <a href="https://www.degruyterbrill.com/journal/key/labm/html#issues" target="_blank" class="journal-link">Journal of Laboratory Medicine</a>
                </div>
                <div style="white-space:nowrap;">
                    <a href="https://www.sciencedirect.com/journal/labmed-discovery" target="_blank" class="journal-link">LabMed Discovery</a>
                </div>
                <div style="white-space:nowrap;">
                    <a href="https://njlm.net/" target="_blank" class="journal-link">National Journal Laboratory Medicine</a>
                </div>
                <div style="white-space:nowrap;">
                    <a href="https://www.kjcls.org/main.html" target="_blank" class="journal-link">The Korean Journal of Clinical Laboratory Science</a>
                </div>
                <div style="white-space:nowrap;">
                    <a href="https://journals.lww.com/drug-monitoring/pages/default.aspx" target="_blank" class="journal-link">Therapeutic Drug Monitoring</a>
                </div>
                <div style="white-space:nowrap;">
                    <a href="https://tkb.dergisi.org/" target="_blank" class="journal-link">Türk Klinik Biyokimya Dergisi</a>
                </div>
                <div style="white-space:nowrap;">
                    <a href="https://www.degruyterbrill.com/journal/key/tjb/html#issues" target="_blank" class="journal-link">Turkish Journal of Biochemistry</a>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-notes" class="section">
        <div class="calculator-view" style="display:block;">
            <h3>Personal Notes</h3>
            <textarea id="myNotes" style="width:100%; height:300px; padding:10px; border-radius:10px; border:1px solid var(--border-color);" oninput="localStorage.setItem('labNotes', this.value)"></textarea>
        </div>
    </div>

</div>

<footer>
    <div class="footer-info">
        <p style="font-weight:600; margin-bottom:5px;">Medical Biochemistry Lab Assistant</p>
        <p style="opacity:0.7; font-size:0.65rem; margin-bottom:5px;">Content provided here is for general information purposes only.</p>
        <p style="font-size:0.75rem; margin-bottom:8px;">Contact: belginsaraa@gmail.com</p>
        <a href="https://github.com/belqin" target="_blank" class="signature-link">
            <p class="signature">Prepared by: Belgin ŞARA, MD</p>
        </a>
    </div>
    <div class="footer-controls">
        <button class="control-btn" onclick="toggleTheme()" id="themeBtn"><i class="fa-solid fa-moon"></i></button>
    </div>
</footer>

<script>
    Chart.register(ChartDataLabels);

    // --- GLOBAL VARIABLES & SETTINGS ---
    let ckdGender = 'female';
    let ckdRace = 'other';
    let schwartzK = 0.55;
    let pbrtqcData = [];
    let ljData = [];
    let qcChart = null;
    let ljChart = null;

    // --- 1. DATABASE (PBRTQC) ---
    const analyteDB = {
        "Albumin": { cvi: 2.5, cvg: 4.1, units: { "g/L (SI)": {l:37, u:48.8}, "g/dL": {l:3.7, u:4.88} }, opt: { m:'ewma', L:2.7, lam:0.02, w:null } },
        "ALP": { cvi: 6.6, cvg: 35.6, units: { "U/L": {l:30, u:120}, "µkat/L (SI)": {l:0.5, u:2.0} }, opt: { m:'ewma', L:2.5, lam:0.05, w:null } },
        "ALT": { cvi: 11.4, cvg: 35.2, units: { "U/L": {l:0, u:41}, "µkat/L (SI)": {l:0, u:0.68} }, opt: { m:'ewma', L:2.5, lam:0.02, w:null } },
        "AST": { cvi: 8.6, cvg: 19.4, units: { "U/L": {l:0, u:40}, "µkat/L (SI)": {l:0, u:0.67} }, opt: { m:'ewma', L:2.5, lam:0.05, w:null } },
        "BUN": { cvi: 13.3, cvg: 20.6, units: { "mmol/L (SI)": {l:2.5, u:7.1}, "mg/dL": {l:7, u:20} }, opt: { m:'ewma', L:2.5, lam:0.02, w:null } },
        "Calcium": { cvi: 1.8, cvg: 2.7, units: { "mmol/L (SI)": {l:2.19, u:2.64}, "mg/dL": {l:8.8, u:10.6} }, opt: { m:'ewma', L:3.0, lam:0.10, w:25 } },
        "Chloride": { cvi: 1.0, cvg: 1.3, units: { "mmol/L (SI)": {l:99.46, u:109.34}, "mEq/L": {l:99.46, u:109.34} }, opt: { m:'ma', L:null, lam:null, w:10 } },
        "HDL Cholesterol": { cvi: 5.7, cvg: 20.0, units: { "mmol/L (SI)": {l:1.03, u:1.55}, "mg/dL": {l:40, u:60} }, opt: { m:'ewma', L:2.5, lam:0.05, w:null } },
        "LDL Cholesterol": { cvi: 7.7, cvg: 20.2, units: { "mmol/L (SI)": {l:1.3, u:3.4}, "mg/dL": {l:50, u:130} }, opt: { m:'ewma', L:2.5, lam:0.05, w:null } },
        "Total Cholesterol": { cvi: 5.2, cvg: 15.3, units: { "mmol/L (SI)": {l:0, u:5.2}, "mg/dL": {l:0, u:200} }, opt: { m:'ewma', L:2.5, lam:0.05, w:null } },
        "Creatinine": { cvi: 4.4, cvg: 16.2, units: { "µmol/L (SI)": {l:62, u:106}, "mg/dL": {l:0.7, u:1.2} }, opt: { m:'ewma', L:2.5, lam:0.02, w:null } },
        "GGT": { cvi: 8.3, cvg: 45.2, units: { "U/L": {l:0, u:60}, "µkat/L (SI)": {l:0, u:1.0} }, opt: { m:'ewma', L:2.5, lam:0.02, w:null } },
        "Glucose": { cvi: 4.6, cvg: 8.1, units: { "mmol/L (SI)": {l:4.0, u:6.88}, "mg/dL": {l:72, u:124} }, opt: { m:'ewma', L:2.5, lam:0.05, w:null } },
        "Iron": { cvi: 27.6, cvg: 26.7, units: { "µmol/L (SI)": {l:11, u:30}, "µg/dL": {l:60, u:170} }, opt: { m:'ewma', L:2.5, lam:0.02, w:null } },
        "LDH": { cvi: 4.4, cvg: 11.8, units: { "U/L": {l:125, u:220}, "µkat/L (SI)": {l:2.0, u:3.7} }, opt: { m:'ewma', L:2.5, lam:0.05, w:null } },
        "Magnesium": { cvi: 2.6, cvg: 5.9, units: { "mmol/L (SI)": {l:0.66, u:1.07}, "mg/dL": {l:1.6, u:2.6} }, opt: { m:'ewma', L:2.5, lam:0.02, w:null } },
        "Phosphate": { cvi: 7.7, cvg: 10.7, units: { "mmol/L (SI)": {l:0.8, u:1.45}, "mg/dL": {l:2.5, u:4.5} }, opt: { m:'ewma', L:2.5, lam:0.02, w:null } },
        "Potassium": { cvi: 3.9, cvg: 5.3, units: { "mmol/L (SI)": {l:3.5, u:5.1}, "mEq/L": {l:3.5, u:5.1} }, opt: { m:'ewma', L:2.5, lam:0.02, w:null } },
        "Sodium": { cvi: 0.5, cvg: 0.7, units: { "mmol/L (SI)": {l:136, u:145}, "mEq/L": {l:136, u:145} }, opt: { m:'ma', L:null, lam:null, w:10 } },
        "Total Bilirubin": { cvi: 20.2, cvg: 24.6, units: { "µmol/L (SI)": {l:5, u:21}, "mg/dL": {l:0.3, u:1.2} }, opt: { m:'ewma', L:2.5, lam:0.02, w:null } },
        "Total Protein": { cvi: 2.6, cvg: 3.5, units: { "g/L (SI)": {l:64, u:83}, "g/dL": {l:6.4, u:8.3} }, opt: { m:'ewma', L:2.5, lam:0.05, w:null } },
        "Triglycerides": { cvi: 19.7, cvg: 33.1, units: { "mmol/L (SI)": {l:0, u:1.7}, "mg/dL": {l:0, u:150} }, opt: { m:'ewma', L:2.5, lam:0.02, w:null } },
        "Uric Acid": { cvi: 8.1, cvg: 22.4, units: { "µmol/L (SI)": {l:200, u:420}, "mg/dL": {l:3.4, u:7.0} }, opt: { m:'ma', L:null, lam:null, w:75 } },
        "Other": { cvi: 0, cvg: 0, units: {}, opt: {} }
    };

    // --- 2. CALCULATOR LIST ---
    const calculators = [
        {id: 'spot-urine', title: 'Spot Urine Analysis', icon: 'fa-vial'},
        {id: 'urine24', title: '24h Urine', icon: 'fa-flask'},
        {id: 'gfr', title: 'GFR Calculator', icon: 'fa-filter'},
        {id: 'ldl', title: 'LDL Calc', icon: 'fa-heart-pulse'},
        {id: 'homa', title: 'HOMA-IR', icon: 'fa-dna'},
        {id: 'schwartz', title: 'Schwartz Formula', icon: 'fa-child'},
        {id: 'fib4', title: 'FIB-4 Score', icon: 'fa-file-medical'},
        {id: 'calc-corr-na', title: 'Corrected Sodium', icon: 'fa-vial'},
        {id: 'calc-calcium', title: 'Corrected Calcium', icon: 'fa-bone'},
        {id: 'calc-corr-mg', title: 'Corrected Magnesium', icon: 'fa-capsules'},
        {id: 'calc-anion', title: 'Anion Gap', icon: 'fa-battery-half'},
        {id: 'calc-osmo', title: 'Osmolality', icon: 'fa-droplet'},
        {id: 'calc-saag', title: 'SAAG', icon: 'fa-vials'},
        {id: 'calc-ph', title: 'pH Estimation', icon: 'fa-wind'},
        {id: 'calc-mentzer', title: 'Mentzer Index', icon: 'fa-syringe'},
        {id: 'calc-albglob', title: 'Alb/Glob Ratio', icon: 'fa-scale-balanced'},
        {id: 'calc-rbc', title: 'RBC Indices', icon: 'fa-circle-dot'},
        {id: 'calc-retic', title: 'Corrected Reticulocyte', icon: 'fa-chart-line'},
        {id: 'calc-inr', title: 'INR Calc', icon: 'fa-stopwatch'},
        {id: 'calc-bun-crea', title: 'BUN/Creatinine Ratio', icon: 'fa-percentage'},
        {id: 'calc-h-ion', title: 'ABG Validation [H+]', icon: 'fa-vial-circle-check'},
        {id: 'calc-fai', title: 'Free Androgen Index', icon: 'fa-venus-mars'},
        {id: 'calc-fpsa', title: 'Free PSA %', icon: 'fa-mars'},
        {id: 'calc-ca-ion', title: 'Est. Ionized Calcium', icon: 'fa-bone'},
        {id: 'calc-a1c', title: 'HbA1c Converter', icon: 'fa-cube'}
    ];

    // --- 3. INIT ---
    window.onload = function() {
        populateAnalyteSelect();
        updatePBRTQCConfig();
        const saved = localStorage.getItem('labNotes');
        if(saved) document.getElementById('myNotes').value = saved;
        loadTheme();
        renderCalcMenu();
        renderLJData();
        initPubMedJournals();
        initJournalListTicks();
        // Add onclick to all unit badges that don't have it
        document.querySelectorAll('.unit-badge:not([onclick])').forEach(badge => {
            const unitText = badge.textContent.trim().replace(/\s*\(SI\)/g, '').trim();
            // Only add onclick for convertible units
            if (unitText.includes('mg/dL') || unitText.includes('g/dL') || unitText.includes('mmol/L') || unitText.includes('µmol/L') || unitText.includes('g/L')) {
                badge.style.cursor = 'pointer';
                badge.onclick = function() { convertToSI(this); };
                // Add rotate icon if not present
                if (!badge.querySelector('i')) {
                    badge.innerHTML += ' <i class="fa-solid fa-rotate"></i>';
                }
            }
        });
    };

    function toggleTheme() {
        const body = document.body;
        const isDark = body.getAttribute('data-theme') === 'dark';
        body.setAttribute('data-theme', isDark ? '' : 'dark');
        localStorage.setItem('theme', isDark ? 'light' : 'dark');
        document.querySelector('#themeBtn i').className = isDark ? 'fa-solid fa-moon' : 'fa-solid fa-sun';
    }
    function loadTheme() {
        if(localStorage.getItem('theme') === 'dark') document.body.setAttribute('data-theme', 'dark');
    }

    function switchTab(tabId, btn) {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        const activeSection = document.getElementById(tabId);
        activeSection.classList.add('active');

        if (tabId === 'tab-calc') {
            closeCalcDetail();
        } else {
            activeSection.querySelectorAll('.calculator-view').forEach(view => view.style.display = 'block');
        }
        
        const suggestions = document.getElementById('calcSuggestions');
        if(suggestions) suggestions.style.display = 'none';
    }

    // --- 4. CALC MENU ---
    function renderCalcMenu() {
        const menu = document.getElementById('calc-menu');
        menu.innerHTML = '';
        calculators.sort((a,b) => a.title.localeCompare(b.title));
        
        calculators.forEach(calc => {
            const div = document.createElement('div');
            div.className = 'calc-card-mini';
            div.innerHTML = `<i class="fa-solid ${calc.icon} calc-icon"></i><div class="calc-title">${calc.title}</div>`;
            div.onclick = () => openCalc(calc.id);
            menu.appendChild(div);
        });
    }
    function openCalc(id) {
        document.getElementById('calc-list-view').style.display = 'none';
        document.getElementById('calc-detail-view').style.display = 'block';
        document.querySelectorAll('.calculator-view').forEach(e=>e.style.display='none');
        let targetId = id.startsWith('calc-') ? id : 'calc-'+id;
        if(!document.getElementById(targetId)) targetId = id;
        const target = document.getElementById(targetId);
        if(target) {
            target.style.display='block';
            // Add onclick to unit badges in the opened calculator
            setTimeout(() => {
                target.querySelectorAll('.unit-badge:not([onclick])').forEach(badge => {
                    const unitText = badge.textContent.trim().replace(/\s*\(SI\)/g, '').trim();
                    if (unitText.includes('mg/dL') || unitText.includes('g/dL') || unitText.includes('mmol/L') || unitText.includes('µmol/L') || unitText.includes('g/L')) {
                        badge.style.cursor = 'pointer';
                        badge.onclick = function() { convertToSI(this); };
                        if (!badge.querySelector('i')) {
                            badge.innerHTML += ' <i class="fa-solid fa-rotate"></i>';
                        }
                    }
                });
            }, 10);
        }
    }
    function closeCalcDetail() {
        document.querySelectorAll('.calculator-view input').forEach(el => el.value = '');
        document.querySelectorAll('.mini-result, .final-result-box').forEach(el => el.innerHTML = '');
        document.getElementById('calc-detail-view').style.display = 'none';
        document.getElementById('calc-list-view').style.display = 'block';
    }

    // --- 5. CLINICAL CALCS ---
    function toggleUnit(badge) { 
        if (badge.querySelector('i')) {
            badge.querySelector('i').classList.toggle('fa-spin'); 
        }
    }
    
    // Convert to SI unit when clicking on unit badge
    function convertToSI(badge) {
        // Find the input field - it's the next sibling or in the parent input-group
        const inputGroup = badge.closest('.input-group');
        if (!inputGroup) return;
        
        const input = inputGroup.querySelector('input');
        if (!input) return;
        
        // Get current value (can be empty)
        const currentValue = input.value;
        const value = parseFloat(currentValue);
        const hasValue = !isNaN(value) && currentValue !== '';
        
        let newValue, newUnit;
        const badgeText = badge.cloneNode(true);
        if (badgeText.querySelector('i')) badgeText.querySelector('i').remove();
        const currentUnit = badgeText.textContent.trim().replace(/\s*\(SI\)/g, '').trim();
        
        // Get label to determine conversion type
        const label = inputGroup.querySelector('label');
        const labelText = label ? label.textContent.toLowerCase() : '';
        
        // Unit conversion mappings based on label or unit text
        const isSI = currentUnit.includes('(SI)') || currentUnit.includes('SI') || currentUnit.includes('µmol/L') || currentUnit.includes('mmol/L') || currentUnit.includes('g/L');
        
        if (!isSI) {
            // Convert TO SI
            if (currentUnit === 'mg/dL') {
                if (labelText.includes('creatinine')) {
                    newValue = hasValue ? value * 88.4 : undefined;
                    newUnit = 'µmol/L (SI)';
                } else if (labelText.includes('glucose') || labelText.includes('fasting glucose')) {
                    newValue = hasValue ? value * 0.0555 : undefined;
                    newUnit = 'mmol/L (SI)';
                } else if (labelText.includes('cholesterol') || labelText.includes('hdl') || labelText.includes('ldl') || labelText.includes('total cholesterol')) {
                    newValue = hasValue ? value * 0.0259 : undefined;
                    newUnit = 'mmol/L (SI)';
                } else if (labelText.includes('triglyceride')) {
                    newValue = hasValue ? value * 0.0113 : undefined;
                    newUnit = 'mmol/L (SI)';
                } else if (labelText.includes('calcium') || labelText.includes('total calcium')) {
                    newValue = hasValue ? value * 0.25 : undefined;
                    newUnit = 'mmol/L (SI)';
                } else if (labelText.includes('bun')) {
                    newValue = hasValue ? value * 0.357 : undefined;
                    newUnit = 'mmol/L (SI)';
                }
            } else if (currentUnit === 'g/dL') {
                if (labelText.includes('albumin')) {
                    newValue = hasValue ? value * 10 : undefined;
                    newUnit = 'g/L (SI)';
                }
            }
        } else {
            // Convert FROM SI back to conventional
            if (currentUnit.includes('µmol/L')) {
                newValue = hasValue ? value / 88.4 : undefined;
                newUnit = 'mg/dL';
            } else if (currentUnit.includes('mmol/L')) {
                if (labelText.includes('creatinine')) {
                    newValue = hasValue ? value / 88.4 : undefined;
                    newUnit = 'mg/dL';
                } else if (labelText.includes('glucose')) {
                    newValue = hasValue ? value / 0.0555 : undefined;
                    newUnit = 'mg/dL';
                } else if (labelText.includes('cholesterol') || labelText.includes('hdl') || labelText.includes('ldl')) {
                    newValue = hasValue ? value / 0.0259 : undefined;
                    newUnit = 'mg/dL';
                } else if (labelText.includes('triglyceride')) {
                    newValue = hasValue ? value / 0.0113 : undefined;
                    newUnit = 'mg/dL';
                } else if (labelText.includes('calcium')) {
                    newValue = hasValue ? value / 0.25 : undefined;
                    newUnit = 'mg/dL';
                } else if (labelText.includes('bun')) {
                    newValue = hasValue ? value / 0.357 : undefined;
                    newUnit = 'mg/dL';
                } else {
                    // Generic mmol/L to mg/dL (for unknown types)
                    newValue = hasValue ? value / 0.0555 : undefined;
                    newUnit = 'mg/dL';
                }
            } else if (currentUnit.includes('g/L')) {
                newValue = hasValue ? value / 10 : undefined;
                newUnit = 'g/dL';
            }
        }
        
        // Always update unit badge, even if no value conversion
        if (newUnit) {
            // Update input value if conversion was possible
            if (newValue !== undefined && hasValue) {
                input.value = newValue.toFixed(newValue % 1 === 0 ? 0 : (Math.abs(newValue) < 0.01 ? 4 : 2));
            }
            
            // Update badge text while preserving onclick
            const icon = badge.querySelector('i');
            badge.textContent = newUnit;
            if (icon) {
                badge.appendChild(icon);
            } else {
                // Add rotate icon if not present
                const rotateIcon = document.createElement('i');
                rotateIcon.className = 'fa-solid fa-rotate';
                badge.appendChild(rotateIcon);
            }
            
            // Ensure onclick handler is preserved
            badge.onclick = function() { convertToSI(this); };
            badge.style.cursor = 'pointer';
            
            // Trigger calculation if there's an oninput handler and value exists
            if (hasValue && newValue !== undefined) {
                const event = new Event('input', { bubbles: true });
                input.dispatchEvent(event);
            }
        }
    }

    function calculateSpotUrine() { const crea=parseFloat(document.getElementById('spot-crea').value); if(!crea) return; const map={'spot-prot':1000,'spot-alb':1000,'spot-ca':1000,'spot-na':100,'spot-k':100,'spot-cl':100}; const units={'spot-prot':'mg/g','spot-alb':'mg/g','spot-ca':'mg/g','spot-na':'mmol/g','spot-k':'mmol/g','spot-cl':'mmol/g'}; for(const[id,f]of Object.entries(map)){const v=parseFloat(document.getElementById(id).value);if(!isNaN(v))document.getElementById('res-'+id).innerHTML=`${((v/crea)*f).toFixed(2)} ${units[id]}`;} }
    function calculateUrineMulti() { const vol=parseFloat(document.getElementById('uVol').value); if(!vol) return; ['uProt','uAlb','uCrea','uCa'].forEach(id=>{const v=parseFloat(document.getElementById(id).value);if(!isNaN(v))document.getElementById('res-'+id).innerHTML=`${((v*vol)/100).toFixed(2)} mg/day`;}); }
    function calculateLDL() { const t=parseFloat(document.getElementById('ldl-tot').value), h=parseFloat(document.getElementById('ldl-hdl').value), tr=parseFloat(document.getElementById('ldl-trig').value); if(t&&h&&tr) document.getElementById('res-ldl-final').innerText = `LDL: ${(t-h-(tr/5)).toFixed(0)} mg/dL`; }
    function calculateHoma() { const g=parseFloat(document.getElementById('homa-glu').value), i=parseFloat(document.getElementById('homa-ins').value); if(g&&i) document.getElementById('res-homa-final').innerText=`HOMA-IR: ${((g*i)/405).toFixed(2)}`; }
    function setSchwartzK(k,b){ schwartzK=k; document.querySelectorAll('#calc-schwartz .radio-option').forEach(x=>x.classList.remove('selected')); b.classList.add('selected'); calculateSchwartz(); }
    function calculateSchwartz(){ const h=parseFloat(document.getElementById('sch-height').value), c=parseFloat(document.getElementById('sch-crea').value); if(h&&c) document.getElementById('res-schwartz-final').innerText=`GFR: ${((schwartzK*h)/c).toFixed(1)} mL/min`; }
    function calculateFIB4(){ const a=parseFloat(document.getElementById('fib-age').value), ast=parseFloat(document.getElementById('fib-ast').value), alt=parseFloat(document.getElementById('fib-alt').value), p=parseFloat(document.getElementById('fib-plt').value); if(a&&ast&&alt&&p) document.getElementById('res-fib4-final').innerText=`FIB-4: ${((a*ast)/(p*Math.sqrt(alt))).toFixed(2)}`; }
    function calculateCorrNa(){ const n=parseFloat(document.getElementById('na-meas').value), g=parseFloat(document.getElementById('na-glu').value); if(n&&g) document.getElementById('res-na-final').innerText=`Corrected Na: ${(n+1.6*((g-100)/100)).toFixed(1)}`; }
    function calculateCa(){ const c=parseFloat(document.getElementById('ca-tot').value), a=parseFloat(document.getElementById('ca-alb').value); if(c&&a) document.getElementById('res-ca-final').innerText=`Corrected Ca: ${(c+0.8*(4.0-a)).toFixed(2)}`; }
    function calculateCorrMg(){ const m=parseFloat(document.getElementById('mg-meas').value), a=parseFloat(document.getElementById('mg-alb').value); if(m&&a) document.getElementById('res-mg-final').innerText=`Corrected Mg: ${(m+0.05*(4.0-a)).toFixed(2)}`; }
    function calculateAnionGap(){ const n=parseFloat(document.getElementById('ag-na').value), c=parseFloat(document.getElementById('ag-cl').value), h=parseFloat(document.getElementById('ag-hco3').value); if(n&&c&&h) document.getElementById('res-ag-final').innerText=`Anion Gap: ${(n-(c+h)).toFixed(1)}`; }
    function calculateOsmo(){ const n=parseFloat(document.getElementById('osmo-na').value), g=parseFloat(document.getElementById('osmo-glu').value), b=parseFloat(document.getElementById('osmo-bun').value); if(n&&g&&b) document.getElementById('res-osmo-final').innerText=`Osmolality: ${((2*n)+(g/18)+(b/2.8)).toFixed(0)}`; }
    function calculateSAAG(){ const s=parseFloat(document.getElementById('saag-serum').value), a=parseFloat(document.getElementById('saag-ascites').value); if(s&&a) document.getElementById('res-saag-final').innerText=`SAAG: ${(s-a).toFixed(2)}`; }
    function calculatePH(){ const h=parseFloat(document.getElementById('ph-hco3').value), p=parseFloat(document.getElementById('ph-pco2').value); if(h&&p) document.getElementById('res-ph-final').innerText=`pH: ${(6.1+Math.log10(h/(0.03*p))).toFixed(3)}`; }
    function calculateMentzer(){ const m=parseFloat(document.getElementById('men-mcv').value), r=parseFloat(document.getElementById('men-rbc').value); if(m&&r) document.getElementById('res-mentzer-final').innerText=`Mentzer: ${(m/r).toFixed(1)}`; }
    function calculateAlbGlob(){ const a=parseFloat(document.getElementById('ag-alb').value), t=parseFloat(document.getElementById('ag-tp').value); if(a&&t) document.getElementById('res-albglob-final').innerText=`A/G: ${(a/(t-a)).toFixed(2)}`; }
    function calculateRBCIndices(){ const h=parseFloat(document.getElementById('rbc-hgb').value), hc=parseFloat(document.getElementById('rbc-hct').value), r=parseFloat(document.getElementById('rbc-count').value); if(h&&hc&&r) document.getElementById('res-rbc-final').innerHTML=`MCV: ${(hc/r*10).toFixed(1)}<br>MCH: ${(h/r*10).toFixed(1)}<br>MCHC: ${(h/hc*100).toFixed(1)}`; }
    function calculateRetic(){ const r=parseFloat(document.getElementById('ret-pct').value), h=parseFloat(document.getElementById('ret-hct').value); if(r&&h) document.getElementById('res-retic-final').innerText=`Corrected: ${(r*(h/45)).toFixed(1)}%`; }
    function calculateINR(){ const p=parseFloat(document.getElementById('inr-pt').value), c=parseFloat(document.getElementById('inr-control').value), i=parseFloat(document.getElementById('inr-isi').value); if(p&&c&&i) document.getElementById('res-inr-final').innerText=`INR: ${Math.pow((p/c),i).toFixed(2)}`; }
    function calculateBunCrea(){ const b=parseFloat(document.getElementById('bc-bun').value), c=parseFloat(document.getElementById('bc-crea').value); if(b&&c) document.getElementById('res-bun-crea-final').innerText=`Ratio: ${(b/c).toFixed(1)}`; }
    function calculateHIon(){ const p=parseFloat(document.getElementById('h-pco2').value), h=parseFloat(document.getElementById('h-hco3').value); if(p&&h) document.getElementById('res-h-ion-final').innerText=`[H+]: ${(24*(p/h)).toFixed(1)} nmol/L`; }
    function calculateFAI(){ const t=parseFloat(document.getElementById('fai-tt').value), s=parseFloat(document.getElementById('fai-shbg').value); if(t&&s) document.getElementById('res-fai-final').innerText=`FAI: ${((t/s)*100).toFixed(1)}`; }
    function calculateFPSA(){ const f=parseFloat(document.getElementById('fpsa-free').value), t=parseFloat(document.getElementById('fpsa-total').value); if(f&&t) document.getElementById('res-fpsa-final').innerText=`% Free: ${((f/t)*100).toFixed(1)}`; }
    function calculateCaIon(){ const c=parseFloat(document.getElementById('cai-ca').value), t=parseFloat(document.getElementById('cai-tp').value); if(c&&t) document.getElementById('res-ca-ion-final').innerText=`Ca++: ${(((c*6)-(t/3))/(t+6)).toFixed(2)}`; }
    function calculateA1c(s){ if(s==='ngsp'){ const v=parseFloat(document.getElementById('a1c-ngsp').value); if(v) document.getElementById('a1c-ifcc').value=((v-2.152)/0.09148).toFixed(1); } else { const v=parseFloat(document.getElementById('a1c-ifcc').value); if(v) document.getElementById('a1c-ngsp').value=((0.09148*v)+2.152).toFixed(1); } }
    
   // --- GFR FUNCTIONS (UPDATED) ---
    
    // Helper to switch gender UI (Separated from Race)
    function setCkdGender(g){ 
        ckdGender=g; 
        document.getElementById('btn-gender-female').classList.toggle('selected', g==='female');
        document.getElementById('btn-gender-male').classList.toggle('selected', g==='male');
        calculateGFR_Selected(); 
    }

    // Helper to switch race UI (Separated from Gender)
    function setCkdRace(r){ 
        ckdRace=r; 
        document.getElementById('btn-race-other').classList.toggle('selected', r==='other');
        document.getElementById('btn-race-black').classList.toggle('selected', r==='black');
        calculateGFR_Selected(); 
    }

    function updateGFRInputs(){ 
        const m = document.getElementById('gfr-method').value;
        
        // Creatinine visibility
        const needsCrea = ['2021-crea', '2021-combo', '2009-crea', '2012-combo', 'mdrd', 'cockcroft'].includes(m);
        document.getElementById('grp-crea').style.display = needsCrea ? 'block' : 'none';
        
        // Cystatin C visibility
        const needsCys = ['2021-combo', '2012-cys', '2012-combo'].includes(m);
        document.getElementById('grp-cys').style.display = needsCys ? 'block' : 'none';
        
        // Race visibility (Only 2009 CKD-EPI, MDRD and 2012 Combo use race adjustment)
        const needsRace = ['2009-crea', 'mdrd', '2012-combo'].includes(m);
        document.getElementById('grp-race').style.display = needsRace ? 'block' : 'none';

        // Weight visibility (Only Cockcroft-Gault)
        document.getElementById('grp-weight').style.display = (m === 'cockcroft') ? 'block' : 'none';

        calculateGFR_Selected(); 
    }
// --- EKSİK OLAN FONKSİYON ---
function getVal(id) {
    const element = document.getElementById(id);
    if (!element) return 0;
    const value = parseFloat(element.value);
    return isNaN(value) ? 0 : value;
}
    function calculateGFR_Selected(){ 
        const m = document.getElementById('gfr-method').value;
        const scr = getVal('gfr-crea', 'creatinine'); // getVal converts to mg/dL
        const cys = getVal('gfr-cys'); 
        const age = getVal('gfr-age');
        const weight = getVal('gfr-weight'); // For Cockcroft
        const isF = ckdGender === 'female';
        const isBlack = ckdRace === 'black';

        if(!age) { document.getElementById('res-gfr-final').innerText = ''; return; }

        let gfr = 0;
        const min = Math.min;
        const max = Math.max;

        // --- 1. 2021 CKD-EPI Creatinine (No Race) ---
        if(m === '2021-crea' && scr) {
            let k = isF ? 0.7 : 0.9;
            let a = isF ? -0.241 : -0.302;
            let s = isF ? 1.012 : 1;
            gfr = 142 * Math.pow(min(scr/k, 1), a) * Math.pow(max(scr/k, 1), -1.2) * Math.pow(0.9938, age) * s;
        }
        
        // --- 2. 2021 CKD-EPI Creatinine-Cystatin C (No Race) ---
        else if(m === '2021-combo' && scr && cys) {
            let k = isF ? 0.7 : 0.9;
            let a = isF ? -0.219 : -0.144; // Alpha for Crea
            let s = isF ? 1.012 : 1;
            gfr = 135 * Math.pow(min(scr/k, 1), a) * Math.pow(max(scr/k, 1), -0.544) 
                      * Math.pow(min(cys/0.8, 1), -0.323) * Math.pow(max(cys/0.8, 1), -0.778)
                      * Math.pow(0.9961, age) * s;
        }

        // --- 3. 2009 CKD-EPI Creatinine (With Race) ---
        else if(m === '2009-crea' && scr) {
            let k = isF ? 0.7 : 0.9;
            let a = isF ? -0.329 : -0.411;
            let s = isF ? 1.018 : 1;
            let r = isBlack ? 1.159 : 1;
            gfr = 141 * Math.pow(min(scr/k, 1), a) * Math.pow(max(scr/k, 1), -1.209) * Math.pow(0.993, age) * s * r;
        }

        // --- 4. 2012 CKD-EPI Cystatin C (No Race) ---
        else if(m === '2012-cys' && cys) {
            let s = isF ? 0.932 : 1;
            gfr = 133 * Math.pow(min(cys/0.8, 1), -0.499) * Math.pow(max(cys/0.8, 1), -1.328) * Math.pow(0.996, age) * s;
        }

        // --- 5. 2012 CKD-EPI Creatinine-Cystatin C (With Race) ---
        // Note: The 2012 combo originally included a race multiplier for Black (1.08).
        else if(m === '2012-combo' && scr && cys) {
            let k = isF ? 0.7 : 0.9;
            let a = isF ? -0.248 : -0.207;
            let s = isF ? 0.969 : 1;
            let r = isBlack ? 1.08 : 1; 
            
            gfr = 135 * Math.pow(min(scr/k, 1), a) * Math.pow(max(scr/k, 1), -0.601) 
                      * Math.pow(min(cys/0.8, 1), -0.375) * Math.pow(max(cys/0.8, 1), -0.711) 
                      * Math.pow(0.9952, age) * s * r;
        }

        // --- 6. MDRD (4-variable) ---
        else if(m === 'mdrd' && scr) {
            let s = isF ? 0.742 : 1;
            let r = isBlack ? 1.212 : 1;
            gfr = 175 * Math.pow(scr, -1.154) * Math.pow(age, -0.203) * s * r;
        }

        // --- 7. Cockcroft-Gault (Returns mL/min, not normalized to 1.73m2) ---
        else if(m === 'cockcroft' && scr && weight) {
            // Formula: ((140 - age) * weight) / (72 * scr) [* 0.85 if female]
            let s = isF ? 0.85 : 1;
            gfr = ((140 - age) * weight) / (72 * scr) * s;
        }

        // Result Display
        const resBox = document.getElementById('res-gfr-final');
        if(gfr > 0 && isFinite(gfr)) {
            let unit = (m === 'cockcroft') ? 'mL/min' : 'mL/min/1.73m²';
            resBox.innerText = `Result: ${gfr.toFixed(1)} ${unit}`;
        } else {
            resBox.innerText = '';
        }
    }

    function showCalcSuggestions(){ const inp=document.getElementById('calcSearchInput'), q=inp.value.toLowerCase(), box=document.getElementById('calcSuggestions'); box.innerHTML=''; if(!q.length){box.style.display='none'; return;} const m=calculators.filter(c=>c.title.toLowerCase().includes(q)); if(m.length){ m.forEach(c=>{ const d=document.createElement('div'); d.className='suggestion-item'; d.innerHTML=`<i class="fa-solid ${c.icon}" style="color:var(--primary)"></i> ${c.title}`; d.onclick=()=>{openCalc(c.id);box.style.display='none';inp.value='';}; box.appendChild(d); }); box.style.display='block'; } else box.style.display='none'; }


    // --- 8. LEVEY-JENNINGS ---
    function addLJPoint() {
        const val = parseFloat(document.getElementById('lj-val').value);
        if(!isNaN(val)) {
            ljData.push(val);
            renderLJData();
            document.getElementById('lj-val').value = '';
        }
    }
    
    function runLeveyJennings() {
        if (ljData.length === 0) {
            alert("Please add at least one data point.");
            return;
        }
        const mean = parseFloat(document.getElementById('lj-mean').value);
        const sd = parseFloat(document.getElementById('lj-sd').value);
        if (isNaN(mean) || isNaN(sd)) {
            alert("Please enter valid Mean and SD values.");
            return;
        }
        drawLJChart(mean, sd);
    }
    
    function editLJValue(index) {
        const currentVal = ljData[index];
        const newVal = prompt("Enter new value:", currentVal);
        if (newVal !== null) {
            const parsed = parseFloat(newVal);
            if (!isNaN(parsed)) {
                ljData[index] = parsed;
                renderLJData();
            } else {
                alert("Please enter a valid number.");
            }
        }
    }
    
    function moveLJValue(index, direction) {
        if (direction === 'up' && index < ljData.length - 1) {
            [ljData[index], ljData[index + 1]] = [ljData[index + 1], ljData[index]];
            renderLJData();
        } else if (direction === 'down' && index > 0) {
            [ljData[index], ljData[index - 1]] = [ljData[index - 1], ljData[index]];
            renderLJData();
        }
    }
    
    function removeLJValue(index) {
        if(confirm("Are you sure you want to delete this value?")) {
            ljData.splice(index, 1);
            renderLJData();
        }
    }
    
    function clearLJData() {
        if(confirm("Clear all data?")) {
            ljData = [];
            renderLJData();
            if(ljChart) {
                ljChart.destroy();
                ljChart = null;
            }
        }
    }
    
    function renderLJData() {
        const tbody = document.getElementById('lj-data-tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        
        for(let i = ljData.length - 1; i >= 0; i--) {
            const tr = document.createElement('tr');
            const showUp = i < ljData.length - 1 ? 'visible' : 'hidden';
            const showDown = i > 0 ? 'visible' : 'hidden';
            
            tr.innerHTML = `
                <td>${i + 1}</td>
                <td style="font-weight:bold; color:var(--primary);">${ljData[i]}</td>
                <td>
                    <div class="action-group">
                        <button class="btn-icon btn-move" onclick="moveLJValue(${i}, 'up')" style="visibility:${showUp}" title="Move Up"><i class="fa-solid fa-arrow-up"></i></button>
                        <button class="btn-icon btn-move" onclick="moveLJValue(${i}, 'down')" style="visibility:${showDown}" title="Move Down"><i class="fa-solid fa-arrow-down"></i></button>
                        <button class="btn-icon btn-edit" onclick="editLJValue(${i})" title="Edit"><i class="fa-solid fa-pen"></i></button>
                        <button class="btn-icon btn-delete" onclick="removeLJValue(${i})" title="Delete"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </td>`;
            tbody.appendChild(tr);
        }
        if (ljData.length === 0) tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#999; padding:10px;">No data.</td></tr>';
    }
    function drawLJChart(mean, sd) {
        const ctx = document.getElementById('ljChart').getContext('2d');
        if(ljChart) ljChart.destroy();
        const labels = ljData.map((_, i) => i + 1);
        
        // Get selected limit (2SD or 3SD)
        const limitRadio = document.querySelector('input[name="lj-limits"]:checked');
        const limitSD = limitRadio ? parseInt(limitRadio.value) : 2;
        
        // Calculate all limits
        const upperLimit = mean + limitSD * sd;
        const lowerLimit = mean - limitSD * sd;
        const upper3SD = mean + 3 * sd;
        const lower3SD = mean - 3 * sd;
        const upper2SD = mean + 2 * sd;
        const lower2SD = mean - 2 * sd;
        const upper1SD = mean + sd;
        const lower1SD = mean - sd;
        
        // Determine point colors based on values (using selected limit)
        const pointColors = ljData.map((val, index) => {
            // Check if exactly on limit
            const onUpperLimit = Math.abs(val - upperLimit) < 0.01;
            const onLowerLimit = Math.abs(val - lowerLimit) < 0.01;
            
            if (onUpperLimit || onLowerLimit) {
                return '#dc2626'; // Red - on limit
            } else if (val < lowerLimit || val > upperLimit) {
                return '#dc2626'; // Red - outside selected limits
            } else {
                // Within selected limits
                if (val >= lower1SD && val <= upper1SD) {
                    return '#16a34a'; // Green - within 1SD
                } else {
                    return '#f59e0b'; // Yellow - outside 1SD but within selected limits
                }
            }
        });
        
        // Border colors same as point colors
        const pointBorderColors = pointColors;
        
        const datasets = [
            { 
                label: 'Control Value', 
                data: ljData, 
                borderColor: '#0d9488', 
                backgroundColor: pointColors,
                pointBackgroundColor: pointColors,
                pointBorderColor: pointBorderColors,
                pointBorderWidth: 2,
                tension: 0.1, 
                pointRadius: 4, 
                pointHoverRadius: 6 
            },
            { label: '+3SD', data: Array(labels.length).fill(upper3SD), borderColor:'#dc2626', borderDash:[5,5], pointRadius:0, borderWidth:2 },
            { label: '-3SD', data: Array(labels.length).fill(lower3SD), borderColor:'#dc2626', borderDash:[5,5], pointRadius:0, borderWidth:2 },
            { label: '+2SD', data: Array(labels.length).fill(upper2SD), borderColor:'#dc2626', borderDash:[5,5], pointRadius:0, borderWidth:2 },
            { label: '-2SD', data: Array(labels.length).fill(lower2SD), borderColor:'#dc2626', borderDash:[5,5], pointRadius:0, borderWidth:2 },
            { label: '+1SD', data: Array(labels.length).fill(upper1SD), borderColor:'#f59e0b', borderDash:[3,3], pointRadius:0, borderWidth:1 },
            { label: '-1SD', data: Array(labels.length).fill(lower1SD), borderColor:'#f59e0b', borderDash:[3,3], pointRadius:0, borderWidth:1 },
            { label: 'Mean', data: Array(labels.length).fill(mean), borderColor:'#16a34a', pointRadius:0, borderWidth:2 }
        ];
        
        // ... (drawLJChart fonksiyonunun üst kısımları aynı kalacak) ...

        // ... (drawLJChart fonksiyonunun üst kısımları aynı kalacak) ...

        ljChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        left: 10,
                        right: 25,
                        top: 25,
                        bottom: 10
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'nearest',
                    axis: 'x'
                },
                scales: {
                    x: { 
                        title: { 
                            display: true, 
                            text: 'Observation Number', 
                            font: {weight:'bold'},
                            padding: { top: 10 } // Eksen başlığı ile değerler arasına boşluk
                        },
                        ticks: {
                            display: true,
                            padding: 5
                        },
                        grid: {
                            display: false
                        }
                    },
                    y: { 
                        title: { 
                            display: true, 
                            text: 'Control Value', 
                            font: {weight:'bold'},
                            padding: { bottom: 15 } // Y Eksen başlığı ile sayılar arasına boşluk (Kesişmeyi önler)
                        },
                        ticks: {
                            mirror: false, // Değerlerin grafik içine girmesini engeller
                            display: true,
                            padding: 10, // Sayılar ile eksen çizgisi arasına mesafe
                            crossAlign: 'far'
                        },
                        grid: {
                            drawOnChartArea: true,
                            drawBorder: true
                        }
                    }
                },
                plugins: {
                    // ChartDataLabels eklentisini bu grafik için kapatıyoruz
                    // Böylece değerler çizgi üzerinde tekrar yazmaz, sadece eksende görünür
                    datalabels: { 
                        display: false 
                    },
                    tooltip: {
                        enabled: true,
                        filter: function(tooltipItem) {
                            // Sadece Control Value (0. index) için tooltip göster
                            return tooltipItem.datasetIndex === 0;
                        },
                        callbacks: {
                            label: function(context) {
                                if(context.datasetIndex === 0) {
                                    const val = context.raw;
                                    const sdDiff = (val - mean) / sd;
                                    let sdText = '';
                                    
                                    if (Math.abs(sdDiff) < 0.01) {
                                        sdText = 'Mean (0 SD)';
                                    } else {
                                        const absSD = Math.abs(sdDiff);
                                        const sign = sdDiff > 0 ? '+' : '-';
                                        sdText = `${sign}${absSD.toFixed(2)} SD`;
                                    }
                                    
                                    return `Control Value: ${val.toFixed(2)} (${sdText})`;
                                }
                                return '';
                            }
                        }
                    },
                    legend: {
                        display: true,
                        // ... (legend ayarları aynı kalacak) ...
                        labels: {
                            generateLabels: function(chart) {
                                // ... (eski kodunuzdaki generateLabels içeriği buraya gelecek) ...
                                const defaultLabels = Chart.defaults.plugins.legend.labels.generateLabels.call(this, chart);
                                const groupedLabels = [];
                                const processed = new Set();
                                
                                defaultLabels.forEach((label, idx) => {
                                    if (processed.has(idx)) return;
                                    const text = label.text;
                                    
                                    if (text === '+3SD' || text === '-3SD') {
                                        const plusLabel = defaultLabels.find(l => l.text === '+3SD');
                                        const minusLabel = defaultLabels.find(l => l.text === '-3SD');
                                        if (plusLabel && minusLabel) {
                                            groupedLabels.push({ ...plusLabel, text: '±3SD', datasetIndex: plusLabel.datasetIndex, hidden: plusLabel.hidden || minusLabel.hidden });
                                            processed.add(defaultLabels.indexOf(plusLabel));
                                            processed.add(defaultLabels.indexOf(minusLabel));
                                        }
                                    }
                                    else if (text === '+2SD' || text === '-2SD') {
                                        const plusLabel = defaultLabels.find(l => l.text === '+2SD');
                                        const minusLabel = defaultLabels.find(l => l.text === '-2SD');
                                        if (plusLabel && minusLabel) {
                                            groupedLabels.push({ ...plusLabel, text: '±2SD', datasetIndex: plusLabel.datasetIndex, hidden: plusLabel.hidden || minusLabel.hidden });
                                            processed.add(defaultLabels.indexOf(plusLabel));
                                            processed.add(defaultLabels.indexOf(minusLabel));
                                        }
                                    }
                                    else if (text === '+1SD' || text === '-1SD') {
                                        const plusLabel = defaultLabels.find(l => l.text === '+1SD');
                                        const minusLabel = defaultLabels.find(l => l.text === '-1SD');
                                        if (plusLabel && minusLabel) {
                                            groupedLabels.push({ ...plusLabel, text: '±1SD', datasetIndex: plusLabel.datasetIndex, hidden: plusLabel.hidden || minusLabel.hidden });
                                            processed.add(defaultLabels.indexOf(plusLabel));
                                            processed.add(defaultLabels.indexOf(minusLabel));
                                        }
                                    }
                                    else if (!processed.has(idx)) {
                                        groupedLabels.push(label);
                                        processed.add(idx);
                                    }
                                });
                                return groupedLabels;
                            }
                        },
                        // ... (onClick fonksiyonu aynı kalacak) ...
                        onClick: function(e, legendItem, legend) {
                            const chart = legend.chart;
                            const text = legendItem.text;
                            if (text === '±3SD') {
                                const plusMeta = chart.getDatasetMeta(chart.data.datasets.findIndex(d => d.label === '+3SD'));
                                const minusMeta = chart.getDatasetMeta(chart.data.datasets.findIndex(d => d.label === '-3SD'));
                                const newState = !plusMeta.hidden;
                                plusMeta.hidden = newState; minusMeta.hidden = newState;
                            } else if (text === '±2SD') {
                                const plusMeta = chart.getDatasetMeta(chart.data.datasets.findIndex(d => d.label === '+2SD'));
                                const minusMeta = chart.getDatasetMeta(chart.data.datasets.findIndex(d => d.label === '-2SD'));
                                const newState = !plusMeta.hidden;
                                plusMeta.hidden = newState; minusMeta.hidden = newState;
                            } else if (text === '±1SD') {
                                const plusMeta = chart.getDatasetMeta(chart.data.datasets.findIndex(d => d.label === '+1SD'));
                                const minusMeta = chart.getDatasetMeta(chart.data.datasets.findIndex(d => d.label === '-1SD'));
                                const newState = !plusMeta.hidden;
                                plusMeta.hidden = newState; minusMeta.hidden = newState;
                            } else {
                                const index = legendItem.datasetIndex;
                                const meta = chart.getDatasetMeta(index);
                                meta.hidden = meta.hidden === null ? !chart.data.datasets[index].hidden : null;
                            }
                            chart.update();
                        }
                    }
                }
            }
        });

// ... (Kalan kodlar aynı) ...
    }
    
    function updateLJLimits() {
        // If chart exists, redraw it with new limits
        if (ljChart && ljData.length > 0) {
            const mean = parseFloat(document.getElementById('lj-mean').value);
            const sd = parseFloat(document.getElementById('lj-sd').value);
            if (!isNaN(mean) && !isNaN(sd)) {
                drawLJChart(mean, sd);
            }
        }
    }

    // --- 9. PBRTQC LOGIC ---
    function populateAnalyteSelect() {
        const sel = document.getElementById('pbrtqc-analyte');
        sel.innerHTML = "";
        Object.keys(analyteDB).sort().forEach(k => {
            if(k !== 'Other') {
                const opt = document.createElement('option');
                opt.value = k; opt.text = k;
                sel.add(opt);
            }
        });
        const opt = document.createElement('option');
        opt.value = 'Other'; 
        opt.text = "Other (Custom)";
        sel.add(opt);
    }

    function updatePBRTQCConfig() {
        const analyte = document.getElementById('pbrtqc-analyte').value;
        const unitDiv = document.getElementById('unit-group');
        const unitSel = document.getElementById('pbrtqc-unit');
        const methodSel = document.getElementById('pbrtqc-method');
        const paramModeSel = document.getElementById('param-mode');
        const customParams = document.getElementById('custom-params');

        if (analyte === 'Other') {
            unitDiv.style.display = 'none'; 
            customParams.style.display = 'block'; 
            
            methodSel.querySelector('option[value="auto"]').style.display = 'none';
            methodSel.value = 'ewma';

            paramModeSel.querySelector('option[value="auto"]').style.display = 'none';
            paramModeSel.value = 'manual';
            
        } else {
            unitDiv.style.display = 'none'; // Unit selection hidden
            customParams.style.display = 'none';
            
            methodSel.querySelector('option[value="auto"]').style.display = 'block';
            paramModeSel.querySelector('option[value="auto"]').style.display = 'block';

            // Set default unit (first unit in the list)
            unitSel.innerHTML = "";
            const units = analyteDB[analyte].units;
            const unitKeys = Object.keys(units);
            unitKeys.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u; opt.text = u;
                unitSel.add(opt);
            });
            // Set default to first unit
            if (unitKeys.length > 0) {
                unitSel.value = unitKeys[0];
            }
        }
        togglePBRTQCParams();
    }

    function togglePBRTQCParams() {
        const method = document.getElementById('pbrtqc-method').value;
        const paramContainer = document.getElementById('param-container');
        if(method === 'auto') paramContainer.style.display = 'none';
        else {
            paramContainer.style.display = 'block';
            toggleManualParams();
        }
    }

    function toggleManualParams() {
        const method = document.getElementById('pbrtqc-method').value;
        const mode = document.getElementById('param-mode').value;
        const manualDiv = document.getElementById('manual-params');
        const autoInfo = document.getElementById('auto-param-display');
        
        if (mode === 'manual') {
            manualDiv.style.display = 'grid';
            autoInfo.style.display = 'none';
            const ewmaEls = document.querySelectorAll('.ewma-only');
            const maEls = document.querySelectorAll('.ma-only');
            ewmaEls.forEach(e => e.style.display = method === 'ewma' ? 'block' : 'none');
            maEls.forEach(e => e.style.display = method === 'ma' ? 'block' : 'none');
        } else {
            manualDiv.style.display = 'none';
            autoInfo.style.display = 'block';
            const analyte = document.getElementById('pbrtqc-analyte').value;
            const db = analyteDB[analyte].opt;
            if(method === 'ewma') autoInfo.innerText = `Auto: λ=${db.lam}, L=${db.L}`;
            else if(method === 'ma') autoInfo.innerText = `Auto: w=${db.w || 50}`;
        }
    }

    function triggerExcelInput() {
        const fileInput = document.getElementById('excel-upload');
        if(fileInput) {
            fileInput.value = '';
            fileInput.click();
        }
    }

    function handleExcelUpload(input) {
        if (!input.files || input.files.length === 0) return;

        const file = input.files[0];
        const reader = new FileReader();

        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const json = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                const newValues = json.flat().map(n => parseFloat(n)).filter(n => !isNaN(n));

                if (newValues.length > 0) {
                    pbrtqcData = newValues;
                    alert(`${pbrtqcData.length} data points loaded successfully.`);
                    renderData();
                } else {
                    alert("Error: No valid numeric data found in Excel.");
                }
            } catch (error) {
                console.error(error);
                alert("File read error!");
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function addManualValue() {
        const input = document.getElementById('single-val-input');
        const val = parseFloat(input.value);
        if(!isNaN(val)) {
            pbrtqcData.push(val);
            input.value = ''; input.focus();
            renderData();
        }
    }

    function editManualValue(index) {
        const currentVal = pbrtqcData[index];
        const newVal = prompt("Enter new value:", currentVal);
        if (newVal !== null) {
            const parsed = parseFloat(newVal);
            if (!isNaN(parsed)) {
                pbrtqcData[index] = parsed;
                renderData();
            } else {
                alert("Please enter a valid number.");
            }
        }
    }

    function moveManualValue(index, direction) {
        if (direction === 'up' && index < pbrtqcData.length - 1) {
            [pbrtqcData[index], pbrtqcData[index + 1]] = [pbrtqcData[index + 1], pbrtqcData[index]];
            renderData();
        } else if (direction === 'down' && index > 0) {
            [pbrtqcData[index], pbrtqcData[index - 1]] = [pbrtqcData[index - 1], pbrtqcData[index]];
            renderData();
        }
    }

    function removeManualValue(index) {
        if(confirm("Are you sure you want to delete this value?")) {
            pbrtqcData.splice(index, 1);
            renderData();
        }
    }

    function clearManualData() { 
        if(confirm("Clear all data?")) {
            pbrtqcData=[]; 
            renderData(); 
        }
    }
    
    function renderData() {
        const tbody = document.getElementById('manual-data-tbody');
        tbody.innerHTML = '';
        
        for(let i = pbrtqcData.length - 1; i >= 0; i--) {
            const tr = document.createElement('tr');
            const showUp = i < pbrtqcData.length - 1 ? 'visible' : 'hidden';
            const showDown = i > 0 ? 'visible' : 'hidden';

            tr.innerHTML = `
                <td>${i + 1}</td>
                <td style="font-weight:bold; color:var(--primary);">${pbrtqcData[i]}</td>
                <td>
                    <div class="action-group">
                        <button class="btn-icon btn-move" onclick="moveManualValue(${i}, 'up')" style="visibility:${showUp}" title="Move Up"><i class="fa-solid fa-arrow-up"></i></button>
                        <button class="btn-icon btn-move" onclick="moveManualValue(${i}, 'down')" style="visibility:${showDown}" title="Move Down"><i class="fa-solid fa-arrow-down"></i></button>
                        <button class="btn-icon btn-edit" onclick="editManualValue(${i})" title="Edit"><i class="fa-solid fa-pen"></i></button>
                        <button class="btn-icon btn-delete" onclick="removeManualValue(${i})" title="Delete"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </td>`;
            tbody.appendChild(tr);
        }
        if (pbrtqcData.length === 0) tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#999; padding:10px;">No data.</td></tr>';
    }

    function downloadTemplate() {
        if (typeof XLSX === 'undefined') return alert("Excel library not loaded.");
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet([["Values"], [10.5], [11.2], [10.8], [9.9], [10.1]]);
        XLSX.utils.book_append_sheet(wb, ws, "Data");
        XLSX.writeFile(wb, "PBRTQC_Template.xlsx");
    }

    function runPBRTQC() {
        if(pbrtqcData.length < 5) return alert("At least 5 data points required.");
        
        const analyte = document.getElementById('pbrtqc-analyte').value;
        const methodVal = document.getElementById('pbrtqc-method').value;
        
        let cvi, cvg, ltl, utl, lambda, L, w, method;

        if (analyte === 'Other') {
            cvi = parseFloat(document.getElementById('cust-cvi').value);
            cvg = parseFloat(document.getElementById('cust-cvg').value);
            ltl = parseFloat(document.getElementById('cust-l').value);
            utl = parseFloat(document.getElementById('cust-u').value);
            method = methodVal; 
            lambda = parseFloat(document.getElementById('manual-lambda').value);
            L = parseFloat(document.getElementById('manual-l').value);
            w = parseInt(document.getElementById('manual-w').value);
        } else {
            const db = analyteDB[analyte];
            cvi = db.cvi; cvg = db.cvg;
            const unitKey = document.getElementById('pbrtqc-unit').value;
            ltl = db.units[unitKey].l; utl = db.units[unitKey].u;
            
            if(methodVal === 'auto') method = db.opt.m; else method = methodVal;
            
            const mode = document.getElementById('param-mode').value;
            if(mode === 'auto') {
                lambda = db.opt.lam; L = db.opt.L; w = db.opt.w || 50;
            } else {
                lambda = parseFloat(document.getElementById('manual-lambda').value);
                L = parseFloat(document.getElementById('manual-l').value);
                w = parseInt(document.getElementById('manual-w').value);
            }
        }

        let data = [...pbrtqcData];
        let logs = `<b>${analyte}</b>`;

        let paramStr = "";
        if(method === 'ewma') paramStr = `EWMA (λ=${lambda}, L=${L})`;
        else paramStr = `MA (w=${w})`;
        logs += `<br><small style="color:var(--text-light)">Used Parameters: ${paramStr}</small><br>`;

        if(document.getElementById('opt-trunc').checked) {
            const mu0 = data.reduce((a,b)=>a+b, 0) / data.length; 
            const term1 = Math.pow(cvg, 2);
            const term2 = 1.25 * Math.pow(cvi, 2);
            const rcvPercent = 2.76 * Math.sqrt(term1 + term2); 

            const low = mu0 * (1 - (rcvPercent / 100));  
            const high = mu0 * (1 + (rcvPercent / 100)); 
            
            const initialCount = data.length; 
            data = data.filter(v => v >= low && v <= high);
            const excludedCount = initialCount - data.length; 
            
            if(excludedCount > 0) {
                logs += `<span style="color:var(--danger)">RCV (%${rcvPercent.toFixed(1)}) Truncation:<br>Limits: ${low.toFixed(2)} - ${high.toFixed(2)}<br><b>${excludedCount} excluded.</b></span><br>`;
            } else {
                logs += `<span style="color:var(--success)">RCV (%${rcvPercent.toFixed(1)}) Truncation: No data loss.</span><br>`;
            }

            if(data.length === 0) return alert("Error: No data left after truncation!");
        }

        let processed = [...data];
        let isLog = false;
        if(document.getElementById('opt-norm').checked) {
            processed = data.map(x => Math.log(x));
            isLog = true;
            logs += "Log Transformation Applied.<br>";
        }

        const mean = processed.reduce((a,b)=>a+b,0)/processed.length;
        const sd = Math.sqrt(processed.reduce((a,b)=>a+Math.pow(b-mean,2),0)/(processed.length-1));
        
        let res=[], ucl=[], lcl=[], cl=[];

        if(method === 'ewma') {
            let z = mean; 
            processed.forEach((val, i) => {
                let t = i+1;
                z = lambda*val + (1-lambda)*z;
                res.push(z);
                let factor = Math.sqrt( (lambda/(2-lambda)) * (1 - Math.pow(1-lambda, 2*t)) );
                ucl.push(mean + L*sd*factor);
                lcl.push(mean - L*sd*factor);
                cl.push(mean);
            });
        } else { // MA
            for(let i=0; i<processed.length; i++) {
                let subset = [];
                let start = Math.max(0, i-w+1);
                for(let k=start; k<=i; k++) subset.push(processed[k]);
                let subMean = subset.reduce((a,b)=>a+b,0)/subset.length;
                res.push(subMean);
                let limit = 3 * (sd/Math.sqrt(subset.length));
                ucl.push(mean+limit); lcl.push(mean-limit); cl.push(mean);
            }
        }

        if(isLog) {
            res = res.map(Math.exp); ucl = ucl.map(Math.exp); lcl = lcl.map(Math.exp); cl = cl.map(Math.exp);
        }

        const xTitle = 'Observation Number';
        const yTitle = method.toUpperCase() === 'EWMA' ? 'EWMA' : 'MA';

        drawQCChart(res, ucl, lcl, cl, method.toUpperCase(), data, xTitle, yTitle);
        
        document.getElementById('qc-result-area').style.display = 'block';
        document.getElementById('qc-stats').innerHTML = logs;
    }

    function drawQCChart(data, ucl, lcl, cl, label, rawData, xTitle, yTitle) {
        const ctx = document.getElementById('qcChart').getContext('2d');
        if(qcChart) qcChart.destroy();
        
        const pointColors = data.map((v, i) => (v > ucl[i] || v < lcl[i]) ? '#dc2626' : '#16a34a');

        qcChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map((_, i) => i+1),
                datasets: [
                    {
                        label: label, 
                        data: data, 
                        borderColor: '#2563eb', 
                        pointBackgroundColor: pointColors,
                        pointBorderColor: pointColors, 
                        pointRadius: 4, 
                        borderWidth: 1.5, 
                        fill: false,
                        datalabels: { display: false }
                    },
                    { label: 'UCL', data: ucl, borderColor: '#dc2626', borderDash: [5,5], pointRadius:0, borderWidth:1, datalabels:{display:false} },
                    { label: 'LCL', data: lcl, borderColor: '#dc2626', borderDash: [5,5], pointRadius:0, borderWidth:1, datalabels:{display:false} },
                    { label: 'CL', data: cl, borderColor: '#16a34a', pointRadius:0, borderWidth:1, datalabels:{display:false} }
                ]
            },
            options: {
                responsive: true, 
                maintainAspectRatio: false,
                scales: {
                    x: { title: { display: true, text: xTitle, font: {weight:'bold'} } },
                    y: { title: { display: true, text: yTitle, font: {weight:'bold'} } }
                },
                plugins: {
                    datalabels: { display: false },
                    tooltip: {
                        enabled: true, 
                        callbacks: {
                            label: function(context) {
                                if(context.datasetIndex === 0) {
                                    return [
                                        `Result: ${context.raw.toFixed(2)}`, 
                                        `Raw Data: ${rawData[context.dataIndex]}`
                                    ];
                                }
                                return context.dataset.label;
                            }
                        }
                    }
                }
            }
        });
    }

    function downloadHighResChart(chartId) {
        const chart = Chart.getChart(chartId);
        if (!chart) {
            alert("Chart not found. Please generate the chart first.");
            return;
        }
        
        try {
            const originalWidth = chart.canvas.width;
            const originalHeight = chart.canvas.height;
            const scaleFactor = 6; 
            
            // Temporarily increase canvas size
            chart.canvas.width = originalWidth * scaleFactor;
            chart.canvas.height = originalHeight * scaleFactor;
            chart.resize();
            chart.update('none'); // Don't animate
            
            // Wait for chart to update
            setTimeout(() => {
                const link = document.createElement('a');
                link.download = `Chart_600DPI_${Date.now()}.png`;
                link.href = chart.canvas.toDataURL('image/png', 1.0);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Restore original size
                chart.canvas.width = originalWidth;
                chart.canvas.height = originalHeight;
                chart.resize();
                chart.update('none');
            }, 100);
        } catch (error) {
            console.error("Error downloading chart:", error);
            alert("Error downloading chart. Please try again.");
        }
    }

    // --- YENİ EKLENEN FONKSİYONLAR ---

    // 1. Akordeon Açma/Kapama Fonksiyonu
    function toggleQC(id, header) {
        const target = document.getElementById(id);
        const isCurrentlyOpen = target.style.display === 'block' || (target.style.display === '' && window.getComputedStyle(target).display === 'block');
        
        // Eğer tıklanan accordion açıksa, onu kapat
        if (isCurrentlyOpen) {
            target.style.display = 'none';
            header.classList.remove('active');
            const chevron = header.querySelector('i.fa-chevron-down');
            if (chevron) chevron.style.transform = 'rotate(0deg)';
        } else {
            // Açıksa, diğerlerini kapat ve bunu aç
            document.querySelectorAll('.qc-body').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.qc-header').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.qc-header i.fa-chevron-down').forEach(el => el.style.transform = 'rotate(0deg)');
            
            target.style.display = 'block';
            header.classList.add('active');
            const chevron = header.querySelector('i.fa-chevron-down');
            if (chevron) chevron.style.transform = 'rotate(180deg)';
        }
    }

    // 2. Levey-Jennings için Excel ve Template Fonksiyonları
    function triggerLJExcelInput() {
        const fileInput = document.getElementById('lj-excel-upload');
        if(fileInput) {
            fileInput.value = '';
            fileInput.click();
        }
    }

    function downloadLJTemplate() {
        if (typeof XLSX === 'undefined') return alert("Excel library not loaded.");
        const wb = XLSX.utils.book_new();
        // Basit bir şablon, rastgele verilerle
        const ws = XLSX.utils.aoa_to_sheet([["QC_Values"], [98], [102], [99], [101], [100]]);
        XLSX.utils.book_append_sheet(wb, ws, "LJ_Data");
        XLSX.writeFile(wb, "LJ_Template.xlsx");
    }

    function handleLJExcelUpload(input) {
        if (!input.files || input.files.length === 0) return;

        const file = input.files[0];
        const reader = new FileReader();

        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const json = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                
                // İlk satır başlık olabilir diye filtreleyip sadece sayıları alıyoruz
                const newValues = json.flat().map(n => parseFloat(n)).filter(n => !isNaN(n));

                if (newValues.length > 0) {
                    // Mevcut verilerin üzerine mi eklesin yoksa sıfırlasın mı? 
                    // Genelde sıfırdan yüklemek istenir, ama eklemek istersen ljData.push(...newValues) yap.
                    ljData = newValues;
                    renderLJData();
                    alert(`${ljData.length} data points loaded to Levey-Jennings. Click "CALCULATE & PLOT" to generate the chart.`);
                } else {
                    alert("Error: No valid numeric data found in Excel.");
                }
            } catch (error) {
                console.error(error);
                alert("File read error!");
            }
        };
        reader.readAsArrayBuffer(file);
    }
    
    function formatXMLDate(node) {
        if (!node) return '';
        const y = node.querySelector('Year') ? node.querySelector('Year').textContent : '';
        const m = node.querySelector('Month') ? node.querySelector('Month').textContent : '';
        const d = node.querySelector('Day') ? node.querySelector('Day').textContent : '';
        const medline = node.querySelector('MedlineDate') ? node.querySelector('MedlineDate').textContent : '';
        if (medline) return medline;
        let s = '';
        if (y) s += y;
        if (m) s += (s ? ' ' : '') + m;
        if (d) s += ' ' + d;
        return s;
    }
    function formatAuthorsFromArticle(article) {
        const arr = Array.from(article.querySelectorAll('AuthorList > Author')).map(a => {
            const collective = a.querySelector('CollectiveName') ? a.querySelector('CollectiveName').textContent : '';
            if (collective) return collective.trim();
            const fore = a.querySelector('ForeName') ? a.querySelector('ForeName').textContent : '';
            const last = a.querySelector('LastName') ? a.querySelector('LastName').textContent : '';
            return (fore + (fore && last ? ' ' : '') + last).trim();
        }).filter(Boolean);
        return arr.join(', ');
    }
    async function fetchTextWithProxy(url) {
        try {
            const r = await fetch(url);
            if (!r.ok) throw new Error('direct');
            return await r.text();
        } catch {
            const r2 = await fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent(url));
            if (!r2.ok) throw new Error('proxy');
            return await r2.text();
        }
    }
    function renderRSS(xmlText, res) {
        const parser = new DOMParser();
        const xml = parser.parseFromString(xmlText, 'application/xml');
        const items = Array.from(xml.querySelectorAll('item'));
        if (!items.length) { res.innerHTML = '<div style="padding:8px; font-size:0.85rem;">No items</div>'; return; }
        const list = document.createElement('div');
        items.forEach(it => {
            const titleEl = it.querySelector('title');
            const linkEl = it.querySelector('link');
            const dateEl = it.querySelector('pubDate');
            const title = titleEl ? titleEl.textContent : '';
            const link = linkEl ? linkEl.textContent : '';
            const date = dateEl ? dateEl.textContent : '';
            const a = document.createElement('a');
            a.href = link;
            a.target = '_blank';
            a.className = 'journal-link';
            a.textContent = title + (date ? ' (' + date + ')' : '');
            list.appendChild(a);
        });
        res.innerHTML = '';
        res.appendChild(list);
    }
    function getFavJournals() {
        return JSON.parse(localStorage.getItem('favJournals') || '[]');
    }
    function setFavJournals(arr) {
        localStorage.setItem('favJournals', JSON.stringify(arr));
    }
    function toggleFav(name, el) {
        const stored = getFavJournals();
        const idx = stored.indexOf(name);
        if (idx > -1) {
            stored.splice(idx,1);
            el.className = 'btn-action btn-secondary';
            el.textContent = '';
        } else {
            stored.push(name);
            el.className = 'btn-action';
            el.textContent = '✓';
        }
        setFavJournals(stored);
        initJournalListTicks();
    }
    function initJournalListTicks() {
        const stored = getFavJournals();
        document.querySelectorAll('button[data-journal]').forEach(btn => {
            const name = btn.getAttribute('data-journal');
            if (stored.includes(name)) {
                btn.className = 'btn-action';
                btn.textContent = '✓';
            } else {
                btn.className = 'btn-action btn-secondary';
                btn.textContent = '';
            }
        });
    }
    function filterJournalLists() {
        const q = (document.getElementById('journalSearchInput') ? document.getElementById('journalSearchInput').value : '').toLowerCase().trim();
        ['rssJournalList','visitJournalList'].forEach(id => {
            const container = document.getElementById(id);
            if (!container) return;
            container.querySelectorAll('div').forEach(row => {
                const t = row.textContent.toLowerCase();
                row.style.display = q ? (t.includes(q) ? '' : 'none') : '';
            });
        });
    }
    function initPubMedJournals() {
        const sel = document.getElementById('favJournalSelect');
        if (!sel) return;
        const defaultFavJournals = ['Clinical Chemistry','The Journal of Applied Laboratory Medicine','Laboratory Medicine'];
        const stored = JSON.parse(localStorage.getItem('favJournals') || '[]');
        const journals = (stored.length ? stored : defaultFavJournals);
        sel.innerHTML = '';
        journals.forEach(j => {
            const opt = document.createElement('option');
            opt.value = j;
            opt.textContent = j;
            opt.selected = true;
            sel.appendChild(opt);
        });
    }
    async function loadPubMedJournalsLatest() {
        const res = document.getElementById('pubmedJournalResults');
        const countSel = document.getElementById('pubmedCountSelect');
        if (!res || !countSel) return;
        const defaultFavJournals = ['Clinical Chemistry','The Journal of Applied Laboratory Medicine','Laboratory Medicine'];
        const storedFavs = JSON.parse(localStorage.getItem('favJournals') || '[]');
        const journals = storedFavs.length ? storedFavs : defaultFavJournals;
        const retmax = parseInt(countSel.value || '10', 10);
        const cachePrefix = "pubmed_cache_";
        const currentCacheKey = cachePrefix + journals.join('_') + "_" + retmax;
        const now = new Date().getTime();
        Object.keys(localStorage).forEach(key => {
            if (key.startsWith(cachePrefix) && key !== currentCacheKey) {
                localStorage.removeItem(key);
            }
        });
        const cachedData = JSON.parse(localStorage.getItem(currentCacheKey));
        if (cachedData && (now - cachedData.timestamp < 1800000)) {
            renderPubMedList(cachedData.articles, res);
            return;
        }
        res.innerHTML = '<div style="padding:8px; font-size:0.85rem;">Fetching latest articles...</div>';
        try {
            const rssMap = {
                'Advances in Laboratory Medicine': 'https://pubmed.ncbi.nlm.nih.gov/rss/search/1z52wgQGrymR2X9hFvtFn2eMNt_ZPOBcHce7z9ZDAilDuOJkxd/?limit=15&utm_campaign=pubmed-2&fc=20260120051449',
                'Annals of Clinical Biochemistry': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/0324055/?limit=15&name=Ann%20Clin%20Biochem&utm_campaign=journals',
                'Annals of Laboratory Medicine': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/101571172/?limit=15&name=Ann%20Lab%20Med&utm_campaign=journals',
                'Biochemia Medica': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/9610305/?limit=15&name=Biochem%20Med%20%28Zagreb%29&utm_campaign=journals',
                'Clinica Chimica Acta': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/1302422/?limit=15&name=Clin%20Chim%20Acta&utm_campaign=journals',
                'Clinical Chemistry and Laboratory Medicine': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/9806306/?limit=15&name=Clin%20Chem%20Lab%20Med&utm_campaign=journals',
                'Clinical Chemistry': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/9421549/?limit=15&name=Clin%20Chem&utm_campaign=journals',
                'American Journal of Clinical Pathology': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/0370470/?limit=15&name=Am%20J%20Clin%20Pathol&utm_campaign=journals',
                'Critical Reviews in Clinical Laboratory Sciences': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/8914816/?limit=15&name=Crit%20Rev%20Clin%20Lab%20Sci&utm_campaign=journals',
                'eJIFCC': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/101092742/?limit=15&name=EJIFCC&utm_campaign=journals',
                'International Journal of Analytical Chemistry': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/101519424/?limit=15&name=Int%20J%20Anal%20Chem&utm_campaign=journals',
                'Journal of Analytical Toxicology': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/7705085/?limit=15&name=J%20Anal%20Toxicol&utm_campaign=journals',
                'Journal of Clinical Laboratory Analysis': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/8801384/?limit=15&name=J%20Clin%20Lab%20Anal&utm_campaign=journals',
                'Laboratory Medicine': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/0250641/?limit=15&name=Lab%20Med&utm_campaign=journals',
                'Clinical Laboratory': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/9705611/?limit=15&name=Clin%20Lab&utm_campaign=journals',
                'Applied Biochemistry and Biotechnology': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/8208561/?limit=15&name=Appl%20Biochem%20Biotechnol&utm_campaign=journals',
                'Indian Journal of Clinical Biochemistry': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/8708303/?limit=15&name=Indian%20J%20Clin%20Biochem&utm_campaign=journals',
                'Journal of Laboratory Automation': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/101558509/?limit=15&name=J%20Lab%20Autom&utm_campaign=journals',
                'Chemistry and Physics of Lipids': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/0067206/?limit=15&name=Chem%20Phys%20Lipids&utm_campaign=journals',
                'Biological Trace Element Research': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/7911509/?limit=15&name=Biol%20Trace%20Elem%20Res&utm_campaign=journals',
                'Clinical and Experimental Medicine': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/100973405/?limit=15&name=Clin%20Exp%20Med&utm_campaign=journals',
                'Annals of Clinical & Laboratory Science': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/0410247/?limit=15&name=Ann%20Clin%20Lab%20Sci&utm_campaign=journals',
                'Practical Laboratory Medicine': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/101690848/?limit=15&name=Pract%20Lab%20Med&utm_campaign=journals',
                'Scandinavian Journal of Clinical and Laboratory Investigation': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/2984789R/?limit=15&name=Scand%20J%20Clin%20Lab%20Invest%20Suppl&utm_campaign=journals',
                'The Journal of Applied Laboratory Medicine': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/101693884/?limit=15&name=J%20Appl%20Lab%20Med&utm_campaign=journals'
            };
            const journalPromises = journals.map(async (j) => {
                const items = [];
                const rss = rssMap[j];
                try {
                    if (rss) {
                        let url = rss.replace(/limit=\\d+/i, 'limit=' + retmax);
                        if (!url.includes('limit=')) url += (url.includes('?') ? '&' : '?') + 'limit=' + retmax;
                        const txt = await fetchTextWithProxy(url);
                        const xml = new DOMParser().parseFromString(txt, 'application/xml');
                        Array.from(xml.querySelectorAll('item')).slice(0, retmax).forEach(it => {
                            const link = it.querySelector('link')?.textContent || '';
                            const rawDate = it.querySelector('pubDate')?.textContent || '';
                            const dateParts = rawDate.split(' ');
                            const cleanDate = dateParts.length > 3 ? `${dateParts[1]} ${dateParts[2]} ${dateParts[3]}` : rawDate;
                            items.push({
                                title: it.querySelector('title')?.textContent || '',
                                link: link,
                                journal: j,
                                date: cleanDate,
                                pmid: link.match(/pubmed\\.ncbi\\.nlm\\.nih\\.gov\\/(\\d+)/)?.[1] || it.querySelector('guid')?.textContent?.match(/(\\d+)/)?.[1]
                            });
                        });
                    } else {
                        const term = `\"${j}\"[jour]`;
                        const s = await fetch(`https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&retmode=json&sort=pub+date&retmax=${retmax}&term=${encodeURIComponent(term)}`);
                        const sjson = await s.json();
                        const ids = sjson.esearchresult?.idlist || [];
                        if (ids.length) {
                            const f = await fetch(`https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=pubmed&retmode=xml&id=${ids.join(',')}`);
                            const xmlText = await f.text();
                            const xml = new DOMParser().parseFromString(xmlText, 'application/xml');
                            Array.from(xml.querySelectorAll('PubmedArticle')).forEach(a => {
                                const pmid = a.querySelector('PMID')?.textContent || '';
                                const pubDateNode = a.querySelector('ArticleDate[DateType="Electronic"]') || a.querySelector('JournalIssue > PubDate');
                                items.push({
                                    title: a.querySelector('ArticleTitle')?.textContent || '',
                                    link: pmid ? `https://pubmed.ncbi.nlm.nih.gov/${pmid}/` : '',
                                    journal: j,
                                    date: formatXMLDate(pubDateNode),
                                    authors: formatAuthorsFromArticle(a),
                                    pmid: pmid
                                });
                            });
                        }
                    }
                } catch (e) {}
                return items;
            });
            const resultsArray = await Promise.all(journalPromises);
            let allItems = resultsArray.flat();
            const pmidsToFetch = Array.from(new Set(allItems.filter(x => !x.authors && x.pmid).map(x => x.pmid)));
            if (pmidsToFetch.length) {
                const f2 = await fetch(`https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=pubmed&retmode=xml&id=${pmidsToFetch.join(',')}`);
                if (f2.ok) {
                    const xml2 = new DOMParser().parseFromString(await f2.text(), 'application/xml');
                    const authorMap = {};
                    Array.from(xml2.querySelectorAll('PubmedArticle')).forEach(a => {
                        const pmid = a.querySelector('PMID')?.textContent;
                        if (pmid) authorMap[pmid] = formatAuthorsFromArticle(a);
                    });
                    allItems.forEach(it => { if (!it.authors && authorMap[it.pmid]) it.authors = authorMap[it.pmid]; });
                }
            }
            localStorage.setItem(currentCacheKey, JSON.stringify({
                timestamp: now,
                articles: allItems
            }));
            renderPubMedList(allItems, res);
        } catch (err) {
            res.innerHTML = '<div style="padding:8px; font-size:0.85rem;">Failed to load.</div>';
        }
    }
    function renderPubMedList(articles, container) {
        if (!articles.length) { container.innerHTML = '<div style="padding:8px; font-size:0.85rem;">No items found.</div>'; return; }
        container.innerHTML = '';
        const listDiv = document.createElement('div');
        articles.forEach(it => {
            const a = document.createElement('a');
            a.href = it.link;
            a.target = '_blank';
            a.className = 'journal-link';
            const authorPart = it.authors ? ` — ${it.authors}` : '';
            a.textContent = `${it.title}${authorPart} — ${it.date} — ${it.journal}`;
            listDiv.appendChild(a);
        });
        container.appendChild(listDiv);
    }
    
</script>
</body>
</html>
