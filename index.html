<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes">
    <title>Medical Biochemistry Assistant PRO</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.4.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        

        /* QC Accordion Styles */
.qc-card {
    background: var(--bg-card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
    margin-bottom: 15px;
    overflow: hidden;
    width: 100%;
}
.qc-header {
    padding: clamp(15px, 2.5vw, 20px);
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--bg-card);
    transition: background 0.2s;
    flex-wrap: wrap;
    gap: 10px;
}
.qc-header:hover {
    background: var(--bg-input);
}
.qc-header h3 {
    margin: 0;
    font-size: clamp(0.9rem, 2vw, 1rem);
    color: var(--primary);
}
.qc-body {
    display: none;
    padding: clamp(15px, 2.5vw, 20px);
    border-top: 1px solid var(--border-color);
    animation: fadeIn 0.3s;
    width: 100%;
}
.qc-header.active {
    background: var(--primary-light);
}
.qc-header.active h3 {
    color: var(--primary-dark);
}
        /* --- THEME --- */
        :root {
            --primary: #0d9488; --primary-dark: #0f766e; --primary-light: #ccfbf1;
            --bg-body: #f3f4f6; --bg-card: #ffffff; --bg-input: #f9fafb;
            --text-main: #111827; --text-light: #6b7280; --border-color: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --danger: #dc2626; --success: #16a34a; --radius: 16px;
            --warning-bg: #fff7ed; --warning-text: #9a3412; --warning-border: #fdba74;
            --header-bg: linear-gradient(135deg, #0d9488, #115e59);
        }
        [data-theme="dark"] {
            --primary: #2dd4bf; --primary-dark: #14b8a6; --primary-light: #134e4a;
            --bg-body: #111827; --bg-card: #1f2937; --bg-input: #374151;
            --text-main: #f9fafb; --text-light: #9ca3af; --border-color: #374151;
            --header-bg: linear-gradient(135deg, #134e4a, #042f2e);
            --warning-bg: #431407; --warning-text: #fed7aa; --warning-border: #9a3412;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg-body); color: var(--text-main); min-height: 100vh; display: flex; flex-direction: column; transition: background 0.3s; width: 100%; }

        /* HEADER */
        header { 
            width: 100%;
            background-color: #fff;
            background-image: linear-gradient(90deg, transparent 79px, #abced4 79px, #abced4 81px, transparent 81px), linear-gradient(#eee .1em, transparent .1em);
            background-size: 100% 1.2em;
            color: #374151; padding: 2.5rem 1rem; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; box-shadow: var(--shadow); text-align: center;
        }
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            text-align: center;
        }
        header h1 { font-size: clamp(1.4rem, 4vw, 1.8rem); font-weight: 900; letter-spacing: 1px; margin-bottom: 5px; color: #111827; text-shadow: 2px 2px 0px #fff; text-align: center; }
        header p { font-size: clamp(0.75rem, 2vw, 0.9rem); text-align: center; }

        /* NAV */
        .nav-tabs { 
            display: flex; 
            justify-content: center; 
            align-items: center;
            gap: 8px; 
            margin: -25px auto 20px auto; 
            background: var(--bg-card); 
            padding: 6px 15px; 
            border-radius: 20px; 
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.15); 
            border: 1px solid var(--border-color); 
            width: fit-content; 
            min-width: fit-content;
            max-width: 100%;
            position: relative; 
            z-index: 10; 
            flex-wrap: wrap;
        }
        
        @media (max-width: 600px) {
            .nav-tabs {
                padding: 6px 10px;
                gap: 6px;
            }
        }
        .nav-btn { background: transparent; border: none; padding: 8px 12px; border-radius: 14px; color: var(--text-light); font-weight: 600; cursor: pointer; font-size: clamp(0.7rem, 1.5vw, 0.8rem); display: flex; align-items: center; gap: 5px; flex-direction: column; transition: all 0.2s; flex-shrink: 0; }
        .nav-btn i { font-size: clamp(1rem, 2.5vw, 1.2rem); margin-bottom: 2px; }
        .nav-btn.active { background-color: var(--primary-light); color: var(--primary-dark); }
        .nav-btn:hover { background-color: var(--bg-input); }
        .nav-btn.wide { padding: 8px 20px; }
        
        /* QC ve Notes sekmeleri */
        .nav-tabs .nav-btn:nth-child(2),
        .nav-tabs .nav-btn:nth-child(4),
        button.nav-btn[onclick*="tab-qc"],
        button.nav-btn[onclick*="tab-notes"] {
            padding-left: 35px !important;
            padding-right: 35px !important;
            padding-top: 8px !important;
            padding-bottom: 8px !important;
            min-width: 130px !important;
            flex-basis: auto !important;
            flex-grow: 0 !important;
            flex-shrink: 0 !important;
        }
        
        /* Tablet ve Desktop (768px+) */
@media (min-width: 768px) {
    .nav-btn {
        padding: 12px 20px !important;
        gap: 8px !important;
    }

    .nav-btn i {
        font-size: 1.6rem !important;
        margin-bottom: 4px !important;
    }

    .nav-btn span, 
    .nav-btn {
        font-size: 1rem !important;
        font-weight: 700 !important;
    }

    .nav-tabs .nav-btn:nth-child(2),
    .nav-tabs .nav-btn:nth-child(4) {
        min-width: 180px !important;
    }
}
        
        /* Büyük Desktop (1024px+) */
        @media (min-width: 1024px) {
            .nav-tabs .nav-btn:nth-child(2),
            .nav-tabs .nav-btn:nth-child(4),
            button.nav-btn[onclick*="tab-qc"],
            button.nav-btn[onclick*="tab-notes"] {
                padding-left: 55px !important;
                padding-right: 55px !important;
                min-width: 170px !important;
            }
        }
        
        /* Mobil (600px ve altı) */
        @media (max-width: 600px) {
            .nav-tabs .nav-btn:nth-child(2),
            .nav-tabs .nav-btn:nth-child(4),
            button.nav-btn[onclick*="tab-qc"],
            button.nav-btn[onclick*="tab-notes"] {
                padding-left: 25px !important;
                padding-right: 25px !important;
                min-width: 100px !important;
            }
        }
        
        /* Çok küçük ekranlar (480px ve altı) */
        @media (max-width: 480px) {
    /* Mevcut nav-btn kodların */
    .nav-tabs .nav-btn:nth-child(2),
    .nav-tabs .nav-btn:nth-child(4),
    button.nav-btn[onclick*="tab-qc"],
    button.nav-btn[onclick*="tab-notes"] {
        padding-left: 20px !important;
        padding-right: 20px !important;
        min-width: 90px !important;
    }

    .qc-header h3 {
        font-size: 0.9rem !important;
        font-weight: 600 !important;
    }

    .qc-header {
        padding: 12px 15px !important;
    }

    /* Taşmayı önleyen ve hizalayan yeni kısım */
    .calc-input-grid { 
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
        gap: 8px !important; 
        width: 100% !important;
        box-sizing: border-box !important;
    }

    .input-group {
        width: 100% !important;
        min-width: 0 !important; 
    }

    .input-group input {
        width: 100% !important;
        box-sizing: border-box !important; 
    }

    .unit-badge {
        font-size: 0.65rem !important; 
        padding: 2px 4px !important;
    }

    .calculator-view {
        padding: 12px !important;
        width: 100% !important;
        box-sizing: border-box !important;
    }
}


    .calc-input-grid { 
        display: grid !important;
        grid-template-columns: 1fr 1fr !important; 
        gap: 10px !important; 
    }

    .input-group {
        width: 100% !important;
    }

    .input-group input {
        width: 100% !important;
        box-sizing: border-box !important;
    }
    /* --------------------------------------------------------- */

        /* CONTAINER */
        .container { 
            width: 100%;
            max-width: 1600px;
            margin: 0 auto; 
            padding: 0 clamp(15px, 4vw, 40px) 40px clamp(15px, 4vw, 40px); 
            flex: 1; 
        }
        .section { display: none; width: 100%; } 
        .section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* UI ELEMENTS */
        .calculator-view { 
            background: var(--bg-card); 
            border-radius: var(--radius); 
            padding: clamp(15px, 3vw, 20px); 
            box-shadow: var(--shadow); 
            border: 1px solid var(--border-color); 
            margin-bottom: 20px; 
            display: none; 
            width: 100%;
        }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-weight: 600; font-size: clamp(0.8rem, 1.5vw, 0.85rem); margin-bottom: 5px; }
        .input-group input, .input-group select { width: 100%; padding: clamp(8px, 2vw, 10px); border-radius: 10px; border: 1px solid var(--border-color); background: var(--bg-input); color: var(--text-main); font-size: clamp(0.85rem, 1.5vw, 0.9rem); }
        .calc-input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: clamp(10px, 2vw, 15px); align-items: start; }
        .full-width { grid-column: span 2; }
        
        .btn-action { background: var(--primary); color: white; border: none; padding: clamp(10px, 2vw, 12px); border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; transition: 0.2s; font-size: clamp(0.85rem, 1.5vw, 0.9rem); }
        .btn-action:hover { background: var(--primary-dark); transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .btn-secondary { background: var(--bg-input); color: var(--text-main); border: 1px solid var(--border-color); }
        
        .chart-container { 
    position: relative; 
    height: clamp(450px, 65vh, 700px); 
    width: 100%; 
    margin-top: 20px; 
    background: #fff; 
    padding: 10px; 
    border-radius: 12px; 
    border: 1px solid #ddd; 
    overflow: auto; 
    -webkit-overflow-scrolling: touch;
    touch-action: pan-x pan-y;
    overscroll-behavior: contain;
}
        .chart-container canvas {
    width: 100% !important;
    height: 100% !important;
    min-width: 0;
}
        /* Specific Calc Styles */
        .label-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    width: 100%;
    min-height: 1.5em; 
}

.label-row label {
    white-space: nowrap; 
    overflow: hidden;
    text-overflow: ellipsis; 
    font-size: clamp(0.7rem, 2vw, 0.85rem);
    margin-bottom: 0;
}
        .unit-badge { font-size: clamp(0.65rem, 1.3vw, 0.7rem); background: var(--bg-body); color: var(--primary); padding: 2px 6px; border-radius: 6px; cursor: pointer; border: 1px solid var(--primary-light); margin-left: auto; display: inline-flex; align-items: center; gap: 4px; transition: all 0.2s; }
        .unit-badge:hover { background: var(--primary-light); transform: scale(1.05); }
        .mini-result { font-size: clamp(0.85rem, 1.8vw, 0.9rem); font-weight: 600; color: var(--primary); margin-top: 5px; min-height: 1.2em; display: flex; justify-content: space-between; }
        .final-result-box { margin-top: 15px; border-top: 1px solid var(--border-color); padding-top: 10px; grid-column: span 2; font-weight: bold; color: var(--primary-dark); font-size: clamp(0.9rem, 2vw, 1rem); }
        .formula-display { font-size: clamp(0.65rem, 1.3vw, 0.7rem); color: var(--text-light); margin-top: 5px; font-family: monospace; display: block; width: 100%; text-align: right; opacity: 0.8; overflow-x: auto; }

        /* Radio Groups */
        .radio-vertical-group { display: flex; flex-direction: column; gap: clamp(6px, 1.2vw, 8px); margin-bottom: 15px; }
        .radio-option { display: flex; align-items: center; padding: clamp(8px, 1.5vw, 10px); border: 1px solid var(--border-color); border-radius: 10px; background: var(--bg-input); cursor: pointer; transition: all 0.2s; font-size: clamp(0.8rem, 1.5vw, 0.9rem); }
        .radio-option.selected { background: var(--primary-light); border-color: var(--primary); color: var(--primary-dark); font-weight: 600; }
        .radio-circle { width: clamp(14px, 2vw, 16px); height: clamp(14px, 2vw, 16px); border-radius: 50%; border: 2px solid var(--text-light); margin-right: clamp(8px, 1.5vw, 10px); position: relative; flex-shrink: 0; }
        .radio-option.selected .radio-circle { border-color: var(--primary); }
        .radio-option.selected .radio-circle::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: clamp(6px, 1.2vw, 8px); height: clamp(6px, 1.2vw, 8px); background: var(--primary); border-radius: 50%; }

        /* Menu Grid */
        .grid-menu { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: clamp(8px, 1.5vw, 10px); 
            width: 100%;
        }
        .calc-card-mini { 
            background: var(--bg-card); 
            padding: clamp(12px, 2vw, 15px); 
            border-radius: var(--radius); 
            text-align: center; 
            cursor: pointer; 
            border: 1px solid var(--border-color); 
            height: clamp(90px, 12vw, 110px); 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            box-shadow: var(--shadow); 
            transition: all 0.2s;
        }
        .calc-card-mini:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); border-color: var(--primary); }
        .calc-icon { font-size: clamp(1.4rem, 3vw, 1.8rem); color: var(--primary); margin-bottom: 8px; }
        .calc-title { font-size: clamp(0.7rem, 1.3vw, 0.75rem); font-weight: 600; line-height: 1.2; }

        /* Search */
        .search-container { position: relative; background: var(--bg-body); padding-bottom: 10px; z-index: 20; padding-top: 5px; width: 100%; }
        .suggestions-box { position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-card); border: 1px solid var(--border-color); z-index: 999; max-height: 250px; overflow-y: auto; display: none; border-radius: 10px; box-shadow: var(--shadow); }
        .suggestion-item { padding: clamp(10px, 1.5vw, 12px) clamp(12px, 2vw, 15px); border-bottom: 1px solid var(--border-color); cursor: pointer; display: flex; align-items: center; gap: 10px; font-weight: 500; font-size: clamp(0.8rem, 1.5vw, 0.9rem); }
        .suggestion-item:hover { background-color: var(--bg-input); }

        /* Manual Data Table */
        .data-list-container { 
            max-height: 200px; 
            overflow-x: auto;
            overflow-y: auto; 
            border: 1px solid var(--border-color); 
            border-radius: 10px; 
            margin-top: 10px; 
            background: var(--bg-input); 
            width: 100%;
        }
        .data-table { width: 100%; font-size: clamp(0.75rem, 1.5vw, 0.8rem); border-collapse: collapse; min-width: 300px; }
        .data-table th { background: var(--primary-light); padding: clamp(6px, 1.5vw, 8px); text-align: left; position: sticky; top: 0; z-index: 10; font-size: clamp(0.75rem, 1.5vw, 0.8rem); }
        .data-table td { padding: clamp(6px, 1.5vw, 8px); border-bottom: 1px solid var(--border-color); }
        
        /* Table Action Buttons */
        .action-group { display: flex; gap: clamp(4px, 1vw, 8px); justify-content: flex-end; align-items: center; flex-wrap: wrap; }
        .btn-icon { background: none; border: none; cursor: pointer; font-size: clamp(0.8rem, 1.5vw, 0.85rem); padding: 4px; transition: transform 0.2s; }
        .btn-icon:hover { transform: scale(1.2); }
        .btn-edit { color: #f59e0b; }
        .btn-move { color: var(--text-light); }
        .btn-delete { color: var(--danger); }

        /* Journal List */
        .journal-list { max-height: clamp(300px, 50vh, 400px); overflow-y: auto; border: 1px solid var(--border-color); border-radius: 10px; background: var(--bg-card); width: 100%; }
        .journal-link { display: block; padding: clamp(10px, 1.5vw, 12px) clamp(12px, 2vw, 15px); border-bottom: 1px solid var(--border-color); color: var(--text-main); text-decoration: none; font-size: clamp(0.8rem, 1.5vw, 0.85rem); font-weight: 500; transition: all 0.2s; line-height: 1.2; }
        .journal-link:hover { background-color: var(--primary-light); color: var(--primary-dark); padding-left: clamp(15px, 2.5vw, 20px); }
        .journal-link:last-child { border-bottom: none; }
        .journal-list > div {
    display: flex;
    align-items: center; 
    gap: 10px;           
    padding: 8px 12px;   
    border-bottom: 1px solid var(--border-color);
}
        .journal-list .journal-link {
    display: inline-block;
    line-height: 1;      
    padding: 0;
    margin: 0;
    text-decoration: none;}
        .journal-list .btn-action, 
.journal-list .btn-secondary {
    width: 20px;
    height: 20px;
    flex-shrink: 0;      
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    font-size: 0.8rem;
    cursor: pointer;
}
        .external-link-card { cursor: pointer; transition: transform 0.2s; border: 1px solid var(--border-color); width: 100%; }
        .external-link-card:hover { transform: translateY(-2px); border-color: var(--primary); }

        /* Footer */
        footer { 
            width: 100%;
            padding: 15px clamp(15px, 4vw, 40px); 
            margin-top: auto; 
            border-top: 1px solid var(--border-color); 
            background: var(--bg-card); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            position: relative;
        }
        .footer-content {
            max-width: 1600px;
            width: 100%;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .footer-info {
            flex: 1;
            text-align: center;
        }
        .footer-info p {
            text-align: center;
        }
        .footer-controls {
            position: absolute;
            right: clamp(15px, 4vw, 40px);
        }
        .control-btn { background: var(--bg-input); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border-color); cursor: pointer; transition: all 0.2s; }
        .control-btn:hover { transform: scale(1.1); background: var(--primary-light); }
        .signature-link { text-decoration: none; display: inline-block; transition: transform 0.2s; }
        .signature-link:hover { transform: scale(1.05); }
        .signature-link .signature { cursor: pointer; text-decoration: underline; text-underline-offset: 3px; font-size: clamp(0.7rem, 1.5vw, 0.8rem); font-weight: 700; color: var(--primary); display: block; margin-top: 3px; text-align: center; }

        /* Responsive Design */
       @media (max-width: 480px) { 
            .grid-menu { grid-template-columns: repeat(2, 1fr); gap: 8px; } 
            .calc-card-mini { height: 85px; padding: 10px; }
            .calc-icon { font-size: 1.3rem; }
            .calc-title { font-size: 0.65rem; }
            .nav-tabs { margin: -15px auto 15px auto; padding: 4px 6px; gap: 3px; }
            .info-links-grid { grid-template-columns: repeat(2, 1fr); }
            html { font-size: 18px; }
            body, p, span, div, label, input, select {
        font-size: 14px !important;
    }
    header h1 {
        font-size: 1.5rem !important;
    }

    h3 {
        font-size: 1.1rem !important;
    }
           .nav-btn {
        font-size: 12px !important; 
    }

    /* Liste öğeleri (Journal links) */
    .journal-link {
        font-size: 14px !important;
    }

    /* Hesaplayıcı sonuç kutuları */
    .mini-result, .final-result-box {
        font-size: 14px !important;
    }
}
            .input-group label { font-size: 0.9rem; }
            .input-group input, .input-group select { font-size: 0.95rem; }
            .btn-action { font-size: 0.95rem; }
            .nav-btn { padding: 5px 8px; font-size: 0.65rem; gap: 2px; }
            .nav-btn i { font-size: 0.9rem; }
            .nav-btn.wide { padding: 5px 12px; }
            header { padding: 1.5rem 1rem; }
            .container { padding: 0 10px 25px 10px; }
            .calculator-view { padding: 12px; }
            .chart-container { height: 400px; }
        
        
        @media (min-width: 481px) and (max-width: 768px) { 
            .grid-menu { grid-template-columns: repeat(2, 1fr); } 
            footer { flex-direction: column; gap: 15px; }
            .footer-info { width: 100%; }
            .footer-controls { position: static; margin-top: 10px; }
            footer .footer-content { flex-direction: column; gap: 10px; text-align: center; } 
            .calc-input-grid { grid-template-columns: 1fr; } 
            .full-width { grid-column: span 1; } 
            .nav-tabs { margin: -20px 15px 20px 15px; padding: 4px 8px; gap: 4px; }
            .nav-btn { padding: 6px 10px; font-size: 0.7rem; }
            .nav-btn.wide { padding: 6px 15px; }
            header { padding: 2rem 1rem; }
            .container { padding: 0 15px 30px 15px; }
            .chart-container { height: clamp(300px, 50vh, 420px); }
        }
        
        @media (max-width: 480px) {
            footer { flex-direction: column; gap: 15px; }
            .footer-info { width: 100%; }
            .footer-controls { position: static; margin-top: 10px; }
        }
        
        @media (min-width: 769px) and (max-width: 1024px) {
            .container { max-width: 100%; padding: 0 30px 40px 30px; }
            .grid-menu { grid-template-columns: repeat(3, 1fr); }
        }
        
        @media (min-width: 1025px) and (max-width: 1400px) {
            .container { max-width: 1400px; }
        }
        
        @media (min-width: 1401px) {
            .container { max-width: 1600px; }
        }
        
        /* Tablet Landscape and Desktop */
        @media (min-width: 769px) {
            .calc-input-grid { grid-template-columns: 1fr 1fr; }
            .full-width { grid-column: span 2; }
        }

        /* Dış Bağlantı Kartları Konteynırı */
.external-links-grid {
    display: grid;
    
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
    gap: 10px;
    margin-top: 15px;
    width: 100%;
}

.external-link-card {
    background: var(--bg-card);
    border-radius: var(--radius);
    padding: 2px !important;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid var(--border-color);
    display: flex !important;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    min-height: 80px;
}

.external-link-card:hover {
    transform: translateY(-2px);
    border-color: var(--primary);
    box-shadow: var(--shadow);
}

.external-link-card i {
    font-size: 1.4rem !important; 
    color: var(--primary);
    margin-bottom: 6px !important;
}

.external-link-card h4 {
    font-size: 0.75rem !important;
    margin: 0;
    line-height: 1.1;
    display: -webkit-box;
    -webkit-line-clamp: 2; 
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.external-link-card span {
    font-size: 0.65rem !important; 
    color: var(--text-light);
    margin-top: 3px;
}

/* Mobil için ekstra küçültme */
@media (max-width: 480px) {
    .external-links-grid {
        grid-template-columns: repeat(3, 1fr); 
        gap: 3px;
    }
    .external-link-card {
        min-height: 80px;
        padding: 3px !important;
    }
    .external-link-card i {
        font-size: 1.1rem !important;
    }
}
    </style>
</head>
<body>

<header>
    <div class="header-content">
        <h1>MEDICAL BIOCHEMISTRY ASSISTANT</h1>
        <p>Professional Laboratory Tool</p>
    </div>
</header>

<div class="nav-tabs">
    <button class="nav-btn active" onclick="switchTab('tab-calc', this)"><i class="fa-solid fa-calculator"></i> Calc</button>
    <button class="nav-btn wide" onclick="switchTab('tab-qc', this)"><i class="fa-solid fa-chart-line"></i> QC</button>
    <button class="nav-btn" onclick="switchTab('tab-info', this)"><i class="fa-solid fa-book-medical"></i> Guide</button>
    <button class="nav-btn wide" onclick="switchTab('tab-notes', this)"><i class="fa-solid fa-sticky-note"></i> Notes</button>
</div>

<div class="container">
    
    <div id="tab-calc" class="section active">
        <div class="search-container">
            <div style="position:relative;">
                <input type="text" id="calcSearchInput" class="input-group" style="width:100%; padding:15px 15px 15px 40px; border-radius:30px; margin-bottom:0;" placeholder="Search calculator..." onkeyup="showCalcSuggestions()">
                <i class="fa-solid fa-search" style="position:absolute; left:15px; top:50%; transform:translateY(-50%); color:var(--text-light);"></i>
            </div>
            <div id="calcSuggestions" class="suggestions-box"></div>
        </div>
        
        <div id="calc-list-view">
            <div id="calc-menu" class="grid-menu"></div>
        </div>

        <div id="calc-detail-view" style="display: none;">
            <button class="btn-action btn-secondary" onclick="closeCalcDetail()" style="width:auto; margin-bottom:15px;"><i class="fa-solid fa-arrow-left"></i> Back to List</button>
            
            <div id="calc-spot-urine" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">Spot Urine Analysis</h3>
                <div class="calc-input-grid">
                    <div class="input-group full-width"><div class="label-row"><label>Spot Urine Creatinine</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">mg/dL</span></div><input type="number" id="spot-crea" placeholder="Required" oninput="calculateSpotUrine()"></div>
                    <div style="grid-column: span 2; border-top: 1px solid var(--border-color); margin: 5px 0 15px 0;"></div>
                    <div class="input-group"><div class="label-row"><label>Spot Albumin</label><span class="unit-badge">mg/dL</span></div><input type="number" id="spot-alb" oninput="calculateSpotUrine()"><div id="res-spot-alb" class="mini-result"></div></div>
                    <div class="input-group"><div class="label-row"><label>Spot Amylase</label><span class="unit-badge">U/L</span></div><input type="number" id="spot-amy" oninput="calculateSpotUrine()"></div>
                    <div class="input-group"><div class="label-row"><label>Spot BUN</label><span class="unit-badge">mg/dL</span></div><input type="number" id="spot-bun" oninput="calculateSpotUrine()"></div>
                    <div class="input-group"><div class="label-row"><label>Spot Calcium</label><span class="unit-badge">mg/dL</span></div><input type="number" id="spot-ca" oninput="calculateSpotUrine()"><div id="res-spot-ca" class="mini-result"></div></div>
                    <div class="input-group"><div class="label-row"><label>Spot Chloride</label><span class="unit-badge">mEq/L</span></div><input type="number" id="spot-cl" oninput="calculateSpotUrine()"><div id="res-spot-cl" class="mini-result"></div></div>
                    <div class="input-group"><div class="label-row"><label>Spot Copper</label><span class="unit-badge">µg/L</span></div><input type="number" id="spot-cu" oninput="calculateSpotUrine()"></div>
                    <div class="input-group"><div class="label-row"><label>Spot Phosphorus</label><span class="unit-badge">mg/dL</span></div><input type="number" id="spot-p" oninput="calculateSpotUrine()"></div>
                    <div class="input-group"><div class="label-row"><label>Spot Potassium</label><span class="unit-badge">mEq/L</span></div><input type="number" id="spot-k" oninput="calculateSpotUrine()"><div id="res-spot-k" class="mini-result"></div></div>
                    <div class="input-group"><div class="label-row"><label>Spot Protein</label><span class="unit-badge">mg/dL</span></div><input type="number" id="spot-prot" oninput="calculateSpotUrine()"><div id="res-spot-prot" class="mini-result"></div></div>
                    <div class="input-group"><div class="label-row"><label>Spot Sodium</label><span class="unit-badge">mEq/L</span></div><input type="number" id="spot-na" oninput="calculateSpotUrine()"><div id="res-spot-na" class="mini-result"></div></div>
                </div>
            </div>

            <div id="calc-dilution" class="calculator-view">
    <h3 style="margin-bottom: 20px; color: var(--primary); border-bottom: 2px solid #f1f5f9; padding-bottom: 10px;">
        <i class="fas fa-vial" style="margin-right:10px;"></i>Manual Dilution Planner
    </h3>
    
    <div class="calc-input-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; align-items: start;">
        <div class="input-group full-width" style="grid-column: span 2; background: rgba(var(--primary-rgb), 0.05); padding: 15px; border-radius: var(--radius); border: 1px solid var(--border-color);">
            <div class="label-row">
                <label style="font-weight: 700;">Minimum Sample Volume to Use</label>
                <span class="unit-badge">µL</span>
            </div>
            <input type="number" id="dil-min-sample" value="50" oninput="calculateDilution()" placeholder="e.g. 100">
            <p style="font-size: 0.75rem; color: var(--text-light); margin-top: 5px;">Recipe adjusts to ensure at least this amount of sample is used.</p>
        </div>

        <div class="input-group full-width" style="grid-column: span 2;">
            <label>Select Dilution Ratio <span style="font-weight: normal; font-size: 0.8rem; color: var(--text-light);">(Choose the ratio you want to perform)</span></label>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px;">
                <button class="btn-outline" onclick="setDilution(5)">1/5</button>
                <button class="btn-outline" onclick="setDilution(10)">1/10</button>
                <button class="btn-outline" onclick="setDilution(20)">1/20</button>
                <button class="btn-outline" onclick="setDilution(25)">1/25</button>
                <button class="btn-outline" onclick="setDilution(50)">1/50</button>
                <button class="btn-outline" onclick="setDilution(100)">1/100</button>
            </div>
        </div>

        <div class="input-group">
            <div class="label-row">
                <label style="height: 34px; display: flex; align-items: center;">Custom Ratio (1/X)</label>
            </div>
            <input type="number" id="dil-custom-ratio" placeholder="Enter X value" oninput="calculateDilution()">
            <span style="font-size: 0.7rem; color: var(--text-light); display: block; margin-top: 4px;">(If not listed above)</span>
        </div>

        <div class="input-group">
            <div class="label-row">
                <label style="height: 34px; display: flex; align-items: center;">Instrument Reading</label>
            </div>
            <input type="number" id="dil-raw-value" placeholder="Result from device" oninput="calculateDilution()">
            <span style="font-size: 0.7rem; color: var(--text-light); display: block; margin-top: 4px;">(Enter to see final result)</span>
        </div>
        
        <div id="res-dilution-final" class="final-result-box" style="display: none; grid-column: span 2;"></div>
    </div>
</div>

            <div id="calc-urine24" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">24h Urine Calculation</h3>
                <div class="calc-input-grid">
                    <div class="input-group" style="grid-column: 1 / -1;"><div class="label-row"><label>Urine Volume</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">mL <i class="fa-solid fa-rotate"></i></span></div><input type="number" id="uVol" placeholder="..." oninput="calculateUrineMulti()"></div>
                    <div style="grid-column: span 2; border-top: 1px solid var(--border-color); margin: 5px 0 15px 0;"></div>
                    <div class="input-group"><div class="label-row"><label>Urine Albumin</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">mg/dL <i class="fa-solid fa-rotate"></i></span></div><input type="number" id="uAlb" oninput="calculateUrineMulti()"><div id="res-uAlb" class="mini-result"></div></div>
                    <div class="input-group"><div class="label-row"><label>Urine Amylase</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">U/L <i class="fa-solid fa-rotate"></i></span></div><input type="number" id="uAmy" oninput="calculateUrineMulti()"><div id="res-uAmy" class="mini-result"></div></div>
                    <div class="input-group"><div class="label-row"><label>Urine BUN</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">mg/dL <i class="fa-solid fa-rotate"></i></span></div><input type="number" id="uBun" oninput="calculateUrineMulti()"><div id="res-uBun" class="mini-result"></div></div>
                    <div class="input-group"><div class="label-row"><label>Urine Calcium</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">mg/dL <i class="fa-solid fa-rotate"></i></span></div><input type="number" id="uCa" oninput="calculateUrineMulti()"><div id="res-uCa" class="mini-result"></div></div>
                    <div class="input-group"><div class="label-row"><label>Urine Chloride</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">mEq/L <i class="fa-solid fa-rotate"></i></span></div><input type="number" id="uCl" oninput="calculateUrineMulti()"><div id="res-uCl" class="mini-result"></div></div>
                    <div class="input-group"><div class="label-row"><label>Urine Copper</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">µg/L <i class="fa-solid fa-rotate"></i></span></div><input type="number" id="uCu" oninput="calculateUrineMulti()"><div id="res-uCu" class="mini-result"></div></div>
                    <div class="input-group"><div class="label-row"><label>Urine Creatinine</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">mg/dL <i class="fa-solid fa-rotate"></i></span></div><input type="number" id="uCrea" oninput="calculateUrineMulti()"><div id="res-uCrea" class="mini-result"></div></div>
                    <div class="input-group"><div class="label-row"><label>Urine Phosphorus</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">mg/dL <i class="fa-solid fa-rotate"></i></span></div><input type="number" id="uP" oninput="calculateUrineMulti()"><div id="res-uP" class="mini-result"></div></div>
                    <div class="input-group"><div class="label-row"><label>Urine Potassium</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">mEq/L <i class="fa-solid fa-rotate"></i></span></div><input type="number" id="uK" oninput="calculateUrineMulti()"><div id="res-uK" class="mini-result"></div></div>
                    <div class="input-group"><div class="label-row"><label>Urine Protein</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">mg/dL <i class="fa-solid fa-rotate"></i></span></div><input type="number" id="uProt" oninput="calculateUrineMulti()"><div id="res-uProt" class="mini-result"></div></div>
                </div>
            </div>

            <div id="calc-gfr" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">GFR Calculator</h3>
                <div class="calc-input-grid">
                    <div class="input-group full-width">
                        <label style="margin-bottom:5px;">Select Method</label>
                        <select id="gfr-method" onchange="updateGFRInputs()">
                            <option value="2021-crea">2021 CKD-EPI Creatinine (Recommended)</option>
                            <option value="2021-combo">2021 CKD-EPI Creatinine-Cystatin C</option>
                            <option value="2009-crea">2009 CKD-EPI Creatinine</option>
                            <option value="2012-cys">2012 CKD-EPI Cystatin C</option>
                            <option value="2012-combo">2012 CKD-EPI Creatinine-Cystatin C</option>
                            <option value="mdrd">MDRD Study Equation</option>
                            <option value="cockcroft">Cockcroft-Gault</option>
                        </select>
                    </div>

                    <div class="input-group full-width">
                        <label style="margin-bottom:10px;">Gender</label>
                        <div class="radio-vertical-group" style="flex-direction:row;">
                            <div id="btn-gender-female" class="radio-option selected" style="flex:1; justify-content:center;" onclick="setCkdGender('female')">Female</div>
                            <div id="btn-gender-male" class="radio-option" style="flex:1; justify-content:center;" onclick="setCkdGender('male')">Male</div>
                        </div>
                    </div>

                    <div class="input-group full-width" id="grp-race" style="display:none;">
                        <label style="margin-bottom:10px;">Race</label>
                        <div class="radio-vertical-group" style="flex-direction:row;">
                            <div id="btn-race-other" class="radio-option selected" style="flex:1; justify-content:center;" onclick="setCkdRace('other')">Non-Black / Other</div>
                            <div id="btn-race-black" class="radio-option" style="flex:1; justify-content:center;" onclick="setCkdRace('black')">Black</div>
                        </div>
                    </div>

                    <div class="input-group full-width">
                        <div class="label-row"><label>Age</label><span class="unit-badge">Year</span></div>
                        <input type="number" id="gfr-age" oninput="calculateGFR_Selected()">
                    </div>

                    <div class="input-group full-width" id="grp-weight" style="display:none;">
                        <div class="label-row"><label>Weight</label><span class="unit-badge">kg</span></div>
                        <input type="number" id="gfr-weight" oninput="calculateGFR_Selected()">
                    </div>

                    <div class="input-group" id="grp-crea">
                        <div class="label-row"><label>Serum Creatinine</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">mg/dL <i class="fa-solid fa-rotate"></i></span></div>
                        <input type="number" step="0.01" id="gfr-crea" oninput="calculateGFR_Selected()">
                    </div>

                    <div class="input-group" id="grp-cys" style="display:none;">
                        <div class="label-row"><label>Cystatin C</label><span class="unit-badge">mg/L</span></div>
                        <input type="number" step="0.01" id="gfr-cys" oninput="calculateGFR_Selected()">
                    </div>

                    <div id="res-gfr-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-ldl" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">LDL Calculator</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>Total Cholesterol</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">mg/dL <i class="fa-solid fa-rotate"></i></span></div><input type="number" id="ldl-tot" oninput="calculateLDL()"></div>
                    <div class="input-group"><div class="label-row"><label>HDL</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">mg/dL <i class="fa-solid fa-rotate"></i></span></div><input type="number" id="ldl-hdl" oninput="calculateLDL()"></div>
                    <div class="input-group"><div class="label-row"><label>Triglyceride</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">mg/dL <i class="fa-solid fa-rotate"></i></span></div><input type="number" id="ldl-trig" oninput="calculateLDL()"></div>
                    <div id="res-ldl-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-homa" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">HOMA-IR</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>Fasting Glucose</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">mg/dL <i class="fa-solid fa-rotate"></i></span></div><input type="number" id="homa-glu" oninput="calculateHoma()"></div>
                    <div class="input-group"><div class="label-row"><label>Fasting Insulin</label><span class="unit-badge">µIU/mL</span></div><input type="number" id="homa-ins" oninput="calculateHoma()"></div>
                    <div id="res-homa-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-schwartz" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">Schwartz Formula</h3>
                <div class="radio-vertical-group">
                    <div class="radio-option" onclick="setSchwartzK(0.33, this)"><div class="radio-circle"></div><span>Low Birth Weight</span></div>
                    <div class="radio-option" onclick="setSchwartzK(0.45, this)"><div class="radio-circle"></div><span>Term Infant</span></div>
                    <div class="radio-option selected" onclick="setSchwartzK(0.55, this)"><div class="radio-circle"></div><span>Child / Girl</span></div>
                    <div class="radio-option" onclick="setSchwartzK(0.70, this)"><div class="radio-circle"></div><span>Adolescent Boy</span></div>
                </div>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>Serum Creatinine</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">mg/dL</span></div><input type="number" id="sch-crea" oninput="calculateSchwartz()"></div>
                    <div class="input-group"><div class="label-row"><label>Height</label><span class="unit-badge">cm</span></div><input type="number" id="sch-height" oninput="calculateSchwartz()"></div>
                    <div id="res-schwartz-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-fib4" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">FIB-4 Score</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>Age</label><span class="unit-badge">Year</span></div><input type="number" id="fib-age" oninput="calculateFIB4()"></div>
                    <div class="input-group"><div class="label-row"><label>Platelets</label><span class="unit-badge">10³/µL</span></div><input type="number" id="fib-plt" oninput="calculateFIB4()"></div>
                    <div class="input-group"><div class="label-row"><label>AST</label><span class="unit-badge">U/L</span></div><input type="number" id="fib-ast" oninput="calculateFIB4()"></div>
                    <div class="input-group"><div class="label-row"><label>ALT</label><span class="unit-badge">U/L</span></div><input type="number" id="fib-alt" oninput="calculateFIB4()"></div>
                    <div id="res-fib4-final" class="final-result-box"></div>
                </div>
            </div>

           <div id="calc-serial-planner" class="calculator-view">
    <h3 style="margin-bottom: 20px; color: var(--primary); border-bottom: 2px solid #f1f5f9; padding-bottom: 10px;">
        <i class="fas fa-magic" style="margin-right:10px;"></i>Smart Dilution Planner
    </h3>
    
    <div class="calc-input-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div class="input-group">
            <div class="label-row"><label>Stock Concentration (C1)</label></div>
            <input type="number" id="plan-stock-c" placeholder="e.g. 1000" oninput="planSerialDilution()">
            <div style="font-style: italic; font-size: 0.75rem; color: #64748b; mt-4px;">Enter the starting concentration of your source solution.</div>
        </div>

        <div class="input-group">
            <div class="label-row">
                <label>Target Concentration (C2)</label>
                <small style="color:#94a3b8; font-weight:normal; margin-left:5px;">(Optional)</small>
            </div>
            <input type="number" id="plan-target-c" placeholder="e.g. 0.5" oninput="planSerialDilution()">
            <div style="font-style: italic; font-size: 0.75rem; color: #64748b; mt-4px;">The system will find the best path to reach this value.</div>
        </div>

        <div class="input-group full-width" style="grid-column: span 2;">
            <label id="factor-label" style="font-weight: 700; font-size: 0.85rem; margin-bottom: 10px; display: block;">Select Dilution Factor (1:X)</label>
            <div id="factor-button-grid" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
                <button class="factor-btn" onclick="selectFactor(2)">1:2</button>
                <button class="factor-btn" onclick="selectFactor(5)">1:5</button>
                <button class="factor-btn active" onclick="selectFactor(10)">1:10</button>
                <button class="factor-btn" onclick="selectFactor(15)">1:15</button>
                <button class="factor-btn" onclick="selectFactor(20)">1:20</button>
                <button class="factor-btn" onclick="selectFactor(25)">1:25</button>
                <button class="factor-btn" onclick="selectFactor(30)">1:30</button>
                <button class="factor-btn" onclick="selectFactor(50)">1:50</button>
                <button class="factor-btn" onclick="selectFactor(100)">1:100</button>
                <button class="factor-btn" onclick="enableCustomX()">1:X</button>
            </div>

            <div id="custom-x-wrapper" style="display: none; margin-top: 10px; padding: 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                <label style="font-size: 0.75rem; font-weight: bold;">Custom X Value:</label>
                <input type="number" id="plan-custom-x" placeholder="e.g. 12" oninput="planSerialDilution()">
            </div>
        </div>

        <div class="input-group full-width" style="grid-column: span 2;">
            <div class="label-row"><label>Transfer Volume (Sample Amount)</label><span class="unit-badge">µL</span></div>
            <input type="number" id="plan-transfer-v" placeholder="Default: 100 µL" oninput="planSerialDilution()">
            <div style="font-style: italic; font-size: 0.75rem; color: #64748b; mt-4px;">Volume to be pipetted from the previous tube in each step.</div>
            <p style="font-size: 0.7rem; color: #94a3b8; margin-top: 5px;">*If blank, 100 µL is used automatically.</p>
        </div>

        <input type="hidden" id="selected-factor" value="10">
        <input type="hidden" id="proj-steps" value="5">
        
        <div id="res-plan-final" class="final-result-box" style="display: none; grid-column: span 2;"></div>
    </div>
</div>

            <div id="calc-corr-na" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">Corrected Sodium</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>Measured Sodium</label><span class="unit-badge">mEq/L</span></div><input type="number" id="na-meas" oninput="calculateCorrNa()"></div>
                    <div class="input-group"><div class="label-row"><label>Glucose</label><span class="unit-badge">mg/dL</span></div><input type="number" id="na-glu" oninput="calculateCorrNa()"></div>
                    <div id="res-na-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-calcium" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">Corrected Calcium</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>Total Calcium</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">mg/dL <i class="fa-solid fa-rotate"></i></span></div><input type="number" id="ca-tot" oninput="calculateCa()"></div>
                    <div class="input-group"><div class="label-row"><label>Albumin</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">g/dL <i class="fa-solid fa-rotate"></i></span></div><input type="number" id="ca-alb" oninput="calculateCa()"></div>
                    <div id="res-ca-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-corr-mg" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">Corrected Magnesium</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>Measured Mg</label><span class="unit-badge">mg/dL</span></div><input type="number" id="mg-meas" oninput="calculateCorrMg()"></div>
                    <div class="input-group"><div class="label-row"><label>Albumin</label><span class="unit-badge">g/dL</span></div><input type="number" id="mg-alb" oninput="calculateCorrMg()"></div>
                    <div id="res-mg-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-anion" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">Serum Anion Gap</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>Na (Sodium)</label><span class="unit-badge">mEq/L</span></div><input type="number" id="ag-na" oninput="calculateAnionGap()"></div>
                    <div class="input-group"><div class="label-row"><label>Cl (Chloride)</label><span class="unit-badge">mEq/L</span></div><input type="number" id="ag-cl" oninput="calculateAnionGap()"></div>
                    <div class="input-group"><div class="label-row"><label>HCO3</label><span class="unit-badge">mEq/L</span></div><input type="number" id="ag-hco3" oninput="calculateAnionGap()"></div>
                    <div class="input-group"><div class="label-row"><label>Albumin</label><span class="unit-badge">g/dL</span></div><input type="number" id="ag-alb" oninput="calculateAnionGap()"></div>
                    <div id="res-ag-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-osmo" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">Serum Osmolality</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>Na (Sodium)</label><span class="unit-badge">mEq/L</span></div><input type="number" id="osmo-na" oninput="calculateOsmo()"></div>
                    <div class="input-group"><div class="label-row"><label>Glucose</label><span class="unit-badge">mg/dL</span></div><input type="number" id="osmo-glu" oninput="calculateOsmo()"></div>
                    <div class="input-group"><div class="label-row"><label>BUN</label><span class="unit-badge">mg/dL</span></div><input type="number" id="osmo-bun" oninput="calculateOsmo()"></div>
                    <div id="res-osmo-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-fena" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">Fractional Excretion of Sodium (FENa)</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>Serum Sodium</label><span class="unit-badge">mEq/L</span></div><input type="number" id="fena-sna" oninput="calculateFENa()"></div>
                    <div class="input-group"><div class="label-row"><label>Serum Creatinine</label><span class="unit-badge">mg/dL</span></div><input type="number" id="fena-screa" oninput="calculateFENa()"></div>
                    <div class="input-group"><div class="label-row"><label>Urine Sodium</label><span class="unit-badge">mEq/L</span></div><input type="number" id="fena-una" oninput="calculateFENa()"></div>
                    <div class="input-group"><div class="label-row"><label>Urine Creatinine</label><span class="unit-badge">mg/dL</span></div><input type="number" id="fena-ucrea" oninput="calculateFENa()"></div>
                    <div id="res-fena-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-saag" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">SAAG</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>Serum Albumin</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">g/dL <i class="fa-solid fa-rotate"></i></span></div><input type="number" id="saag-serum" oninput="calculateSAAG()"></div>
                    <div class="input-group"><div class="label-row"><label>Ascites Albumin</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">g/dL <i class="fa-solid fa-rotate"></i></span></div><input type="number" id="saag-ascites" oninput="calculateSAAG()"></div>
                    <div id="res-saag-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-ph" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">pH Estimation</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>HCO3</label><span class="unit-badge">mmol/L</span></div><input type="number" id="ph-hco3" oninput="calculatePH()"></div>
                    <div class="input-group"><div class="label-row"><label>pCO2</label><span class="unit-badge">mmHg</span></div><input type="number" id="ph-pco2" oninput="calculatePH()"></div>
                    <div id="res-ph-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-mentzer" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">Mentzer Index</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>MCV</label><span class="unit-badge">fL</span></div><input type="number" id="men-mcv" oninput="calculateMentzer()"></div>
                    <div class="input-group"><div class="label-row"><label>RBC</label><span class="unit-badge">10⁶/µL</span></div><input type="number" id="men-rbc" oninput="calculateMentzer()"></div>
                    <div id="res-mentzer-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-albglob" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">Alb/Glob Ratio</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>Albumin</label><span class="unit-badge">g/dL</span></div><input type="number" id="albglob-alb" oninput="calculateAlbGlob()"></div>
                    <div class="input-group"><div class="label-row"><label>Total Protein</label><span class="unit-badge">g/dL</span></div><input type="number" id="albglob-tp" oninput="calculateAlbGlob()"></div>
                    <div id="res-albglob-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-rbc" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">RBC Indices</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>Hgb</label><span class="unit-badge">g/dL</span></div><input type="number" id="rbc-hgb" oninput="calculateRBCIndices()"></div>
                    <div class="input-group"><div class="label-row"><label>Hct</label><span class="unit-badge">%</span></div><input type="number" id="rbc-hct" oninput="calculateRBCIndices()"></div>
                    <div class="input-group"><div class="label-row"><label>RBC</label><span class="unit-badge">10⁶/µL</span></div><input type="number" id="rbc-count" oninput="calculateRBCIndices()"></div>
                    <div id="res-rbc-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-retic" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">Corrected Reticulocyte</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>Reticulocyte %</label><span class="unit-badge">%</span></div><input type="number" id="ret-pct" oninput="calculateRetic()"></div>
                    <div class="input-group"><div class="label-row"><label>Hct</label><span class="unit-badge">%</span></div><input type="number" id="ret-hct" oninput="calculateRetic()"></div>
                    <div class="input-group"><div class="label-row"><label>Normal Hct</label><span class="unit-badge">%</span></div><input type="number" id="ret-hct-normal" value="45" oninput="calculateRetic()"></div>
                    <div id="res-retic-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-inr" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">INR Calculator</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>PT (Patient)</label><span class="unit-badge">sec</span></div><input type="number" id="inr-pt" oninput="calculateINR()"></div>
                    <div class="input-group"><div class="label-row"><label>PT (Control)</label><span class="unit-badge">sec</span></div><input type="number" id="inr-control" oninput="calculateINR()"></div>
                    <div class="input-group"><div class="label-row"><label>ISI</label><span class="unit-badge">-</span></div><input type="number" id="inr-isi" value="1.0" oninput="calculateINR()"></div>
                    <div id="res-inr-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-bun-crea" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">BUN/Creatinine Ratio</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>BUN</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">mg/dL <i class="fa-solid fa-rotate"></i></span></div><input type="number" id="bc-bun" oninput="calculateBunCrea()"></div>
                    <div class="input-group"><div class="label-row"><label>Creatinine</label><span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">mg/dL <i class="fa-solid fa-rotate"></i></span></div><input type="number" id="bc-crea" oninput="calculateBunCrea()"></div>
                    <div id="res-bun-crea-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-h-ion" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">ABG Validation [H+]</h3>
                <div class="calc-input-grid">
                    <div class="input-group full-width"><div class="label-row"><label>Measured pH</label></div><input type="number" id="h-ph" oninput="calculateHIon()"></div>
                    <div class="input-group"><div class="label-row"><label>pCO2</label><span class="unit-badge">mmHg</span></div><input type="number" id="h-pco2" oninput="calculateHIon()"></div>
                    <div class="input-group"><div class="label-row"><label>HCO3</label><span class="unit-badge">mmol/L</span></div><input type="number" id="h-hco3" oninput="calculateHIon()"></div>
                    <div id="res-h-ion-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-fai" class="calculator-view">
    <h3 style="margin-bottom: 20px; color: var(--primary);">Free & Bioavailable Testosterone Calculator</h3>
    <div class="calc-input-grid">
        <div class="input-group">
            <div class="label-row">
                <label>Total Testosterone</label>
                <span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">ng/dL <i class="fa-solid fa-rotate"></i></span>
            </div>
            <input type="number" id="fai-tt" oninput="calculateFAI()">
        </div>
        <div class="input-group">
            <div class="label-row">
                <label>SHBG</label>
                <span class="unit-badge">nmol/L</span>
            </div>
            <input type="number" id="fai-shbg" oninput="calculateFAI()">
        </div>
        <div class="input-group">
            <div class="label-row">
                <label>Albumin</label>
                <span class="unit-badge" onclick="convertToSI(this)" style="cursor:pointer;">g/dL <i class="fa-solid fa-rotate"></i></span>
            </div>
            <input type="number" id="fai-alb" oninput="calculateFAI()">
        </div>
        <div id="res-fai-final" class="final-result-box"></div>
    </div>
</div>

            <div id="calc-fpsa" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">Free PSA %</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>Free PSA</label><span class="unit-badge">ng/mL</span></div><input type="number" id="fpsa-free" oninput="calculateFPSA()"></div>
                    <div class="input-group"><div class="label-row"><label>Total PSA</label><span class="unit-badge">ng/mL</span></div><input type="number" id="fpsa-total" oninput="calculateFPSA()"></div>
                    <div id="res-fpsa-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-ca-ion" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">Est. Ionized Calcium</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>Total Calcium</label><span class="unit-badge">mg/dL</span></div><input type="number" id="cai-ca" oninput="calculateCaIon()"></div>
                    <div class="input-group"><div class="label-row"><label>Total Protein</label><span class="unit-badge">g/dL</span></div><input type="number" id="cai-tp" oninput="calculateCaIon()"></div>
                    <div id="res-ca-ion-final" class="final-result-box"></div>
                    <div style="grid-column: span 2; font-size: 0.75rem; color: var(--text-light); margin-top: 5px; text-align: center;">Ref: 4.4–5.3 mg/dL</div>
                </div>
            </div>

            <div id="calc-igg-index" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">IgG Index</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>IgG CSF</label><span class="unit-badge">mg/dL</span></div><input type="number" id="igg-csf" oninput="calculateIgGIndex()"></div>
                    <div class="input-group"><div class="label-row"><label>Albumin Serum</label><span class="unit-badge">g/dL</span></div><input type="number" id="alb-serum" oninput="calculateIgGIndex()"></div>
                    <div class="input-group"><div class="label-row"><label>IgG Serum</label><span class="unit-badge">mg/dL</span></div><input type="number" id="igg-serum" oninput="calculateIgGIndex()"></div>
                    <div class="input-group"><div class="label-row"><label>Albumin CSF</label><span class="unit-badge">mg/dL</span></div><input type="number" id="alb-csf" oninput="calculateIgGIndex()"></div>
                    <div id="res-igg-index-final" class="final-result-box"></div>
                </div>
            </div>

            <div id="calc-transferrin" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">Transferrin Saturation</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>Serum Iron</label><span class="unit-badge">µg/dL</span></div><input type="number" id="trans-fe" oninput="calculateTransferrin()"></div>
                    <div class="input-group"><div class="label-row"><label>TIBC</label><span class="unit-badge">µg/dL</span></div><input type="number" id="trans-tibc" oninput="calculateTransferrin()"></div>
                    <div id="res-transferrin-final" class="final-result-box"></div>
                </div>
            </div>

<div id="calc-lights" class="calculator-view">
    <h3 style="margin-bottom: 20px; color: var(--primary);">Light's Criteria (Pleural Effusion)</h3>
    <div class="calc-input-grid">
        <div class="input-group">
            <div class="label-row"><label>Pleural Fluid Protein</label><span class="unit-badge">g/dL</span></div>
            <input type="number" id="light-p-protein" placeholder="Required" oninput="calculateLightsCriteria()">
        </div>
        <div class="input-group">
            <div class="label-row"><label>Serum Protein</label><span class="unit-badge">g/dL</span></div>
            <input type="number" id="light-s-protein" placeholder="Required" oninput="calculateLightsCriteria()">
        </div>
        <div class="input-group">
            <div class="label-row"><label>Pleural Fluid LDH</label><span class="unit-badge">U/L</span></div>
            <input type="number" id="light-p-ldh" placeholder="Required" oninput="calculateLightsCriteria()">
        </div>
        <div class="input-group">
            <div class="label-row"><label>Serum LDH</label><span class="unit-badge">U/L</span></div>
            <input type="number" id="light-s-ldh" placeholder="Required" oninput="calculateLightsCriteria()">
        </div>
        <div class="input-group full-width">
            <div class="label-row"><label>Upper limit of normal serum LDH</label><span class="unit-badge">U/L</span></div>
            <input type="number" id="light-s-ldh-uln" value="250" oninput="calculateLightsCriteria()">
        </div>
        
        <div id="res-light-final" class="final-result-box" style="display: none; grid-column: span 2;"></div>
    
    </div>
</div>

            <div id="calc-a1c" class="calculator-view">
                <h3 style="margin-bottom: 20px; color: var(--primary);">HbA1c Converter</h3>
                <div class="calc-input-grid">
                    <div class="input-group"><div class="label-row"><label>% (NGSP)</label><span class="unit-badge">%</span></div><input type="number" id="a1c-ngsp" oninput="calculateA1c('ngsp')"></div>
                    <div class="input-group"><div class="label-row"><label>mmol/mol (IFCC)</label><span class="unit-badge">mmol/mol</span></div><input type="number" id="a1c-ifcc" oninput="calculateA1c('ifcc')"></div>
                    <div style="grid-column: span 2; font-size: 0.8rem; color: var(--text-light); margin-top: 15px; text-align: center;"></div>
                    <div id="res-a1c-eag" class="final-result-box" style="grid-column: span 2;"></div>
                </div>
            </div>

        </div>
    </div>

    <div id="tab-qc" class="section">
    
    <div class="qc-card">
        <div class="qc-header" onclick="toggleQC('qc-lj', this)">
            <h3><i class="fa-solid fa-chart-line"></i> Levey-Jennings Simulator</h3>
            <i class="fa-solid fa-chevron-down"></i>
        </div>
        <div id="qc-lj" class="qc-body">
            <div class="info-box" style="background: rgba(var(--primary-rgb), 0.08); padding: 15px; border-radius: 8px; font-size: 0.85rem; margin-bottom: 20px; border-left: 4px solid var(--primary);">
    <i class="fa-solid fa-circle-info"></i> 
    Enter your data manually or upload via Excel. When uploading, please ensure your file matches the template and uses dots (.) instead of commas (,) as decimal separators. You can either let the system calculate the Mean and SD automatically or enter your own values—be sure to select the appropriate option. You can edit or delete entries by clicking on the value or its sequence number. Select the Westgard rules you wish to apply from the checklist. Once everything is ready, click 'Calculate & Plot'.
</div>
            <div class="calc-input-grid">
                <div class="input-group">
                    <div class="label-row"><label>Mean</label></div>
                    <input type="number" id="lj-mean" oninput="updateLJLimits()">
                </div>
                <div class="input-group">
                    <div class="label-row"><label>SD</label></div>
                    <input type="number" id="lj-sd" oninput="updateLJLimits()">
                </div>
                
                <div class="input-group full-width" style="display:flex; gap:15px; flex-wrap:wrap; margin-top:5px;">
                     <label style="display:flex; align-items:center; gap:8px; font-size:0.85rem; cursor:pointer; white-space:nowrap;">
                        <input type="radio" name="lj-calc-mode" value="manual" checked onchange="toggleLJMode()"> Enter mean and SD manually
                    </label>
                    <label style="display:flex; align-items:center; gap:8px; font-size:0.85rem; cursor:pointer; white-space:nowrap;">
                        <input type="radio" name="lj-calc-mode" value="auto" onchange="toggleLJMode()"> Calculate mean and SD from data
                    </label>
                </div>
    
                <div class="input-group full-width" style="margin-top:10px;">
                    <label style="color:var(--primary); margin-bottom:8px; display:block;">Westgard QC Rules</label>
                    <div style="display:flex; flex-wrap:wrap; gap:10px; white-space:nowrap;">
                        <label style="display:flex; align-items:center; gap:5px; font-size:0.85rem; cursor:pointer;"><input type="checkbox" class="iqc-rule" value="1-2s"> 1<sub>2s</sub></label>
                        <label style="display:flex; align-items:center; gap:5px; font-size:0.85rem; cursor:pointer;"><input type="checkbox" class="iqc-rule" value="1-3s"> 1<sub>3s</sub></label>
                        <label style="display:flex; align-items:center; gap:5px; font-size:0.85rem; cursor:pointer;"><input type="checkbox" class="iqc-rule" value="2-2s"> 2<sub>2s</sub></label>
                        <label style="display:flex; align-items:center; gap:5px; font-size:0.85rem; cursor:pointer;"><input type="checkbox" class="iqc-rule" value="R-4s"> R<sub>4s</sub></label>
                        <label style="display:flex; align-items:center; gap:5px; font-size:0.85rem; cursor:pointer;"><input type="checkbox" class="iqc-rule" value="4-1s"> 4<sub>1s</sub></label>
                        <label style="display:flex; align-items:center; gap:5px; font-size:0.85rem; cursor:pointer;"><input type="checkbox" class="iqc-rule" value="10x"> 10x</label>
                    </div>
                </div>
            </div>
            
            <div class="input-group" style="margin-bottom: 15px; margin-top: 15px;">
                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                    <button class="btn-action btn-secondary" style="flex:1;" onclick="triggerLJExcelInput()">
                        <i class="fa-solid fa-file-excel"></i> Upload Excel
                    </button>
                    <input type="file" id="lj-excel-upload" accept=".xlsx, .xls" style="display:none;" onchange="handleLJExcelUpload(this)">
                    <span id="lj-upload-status" style="font-size:0.8rem; color:var(--success); display:none; margin-left:5px;"></span>
                    
                    <button class="btn-action btn-secondary" style="flex:1;" onclick="downloadLJTemplate()">
                        <i class="fa-solid fa-download"></i> Template
                    </button>
                </div>
            </div>

            <div class="input-group">
                <div style="display:flex; gap:10px;">
                    <input type="number" id="lj-val" placeholder="Manual Value...">
                    <button class="btn-action" style="width:auto; margin:0;" onclick="addLJPoint()">Add</button>
                </div>
            </div>
            
            <div style="max-height:150px; overflow-y:auto; border:1px solid var(--border-color); margin-bottom:10px; margin-top:10px;">
                <table class="data-table">
                    <thead style="background:var(--primary-light); position:sticky; top:0;"><tr><th>No</th><th>Value</th><th>...</th></tr></thead>
                    <tbody id="lj-data-tbody"></tbody>
                </table>
            </div>
            <div style="text-align:right;"><button class="btn-secondary" style="padding:2px 8px; font-size:0.7rem;" onclick="clearLJData()">Clear</button></div>
            
            <button class="btn-action" onclick="runLeveyJennings()" style="margin-top:15px; margin-bottom:15px;">CALCULATE & PLOT</button>
            
            <div class="chart-container"><canvas id="ljChart"></canvas></div>
            <button class="btn-action btn-secondary" onclick="downloadHighResChart('ljChart')" style="margin-top:10px;"><i class="fa-solid fa-download"></i> Download Chart (HD)</button>
        </div>
    </div>

    <div class="qc-card">
        <div class="qc-header" onclick="toggleQC('qc-pbrtqc', this)">
            <h3><i class="fa-solid fa-chart-area"></i> PBRTQC (EWMA & MA)</h3>
            <i class="fa-solid fa-chevron-down"></i>
        </div>
        <div id="qc-pbrtqc" class="qc-body">
            <div class="info-box" style="background: rgba(var(--primary-rgb), 0.08); padding: 15px; border-radius: 8px; font-size: 0.85rem; margin-bottom: 20px; border-left: 4px solid var(--primary);">
    <i class="fa-solid fa-circle-info"></i> 
                Enter your data manually or upload via Excel. When uploading, please ensure the file matches the template and uses dots (.) as decimal separators instead of commas (,). To use the methods and parameters established by Hacettepe University Hospitals Central Laboratory, select the 'Auto' option for calculations. Alternatively, you may manually select your preferred method and parameters. Additionally, you can enable the 'Truncation' option to apply biological variation-mediated truncation limits, and the 'Log Transformation' option to convert your data into a log-normal distribution. Once everything is ready, click 'Calculate & Plot'.
</div>
            <div class="calc-input-grid">
                <div class="input-group full-width">
                    <label>Analyte</label>
                    <select id="pbrtqc-analyte" onchange="updatePBRTQCConfig()"></select>
                </div>
                <div class="input-group" id="unit-group" style="display:none;">
                    <label>Unit</label>
                    <select id="pbrtqc-unit" onchange="updatePBRTQCConfig()"></select>
                </div>
            </div>

            <div id="custom-params" style="display:none; background:var(--bg-input); padding:10px; border-radius:10px; margin-bottom:15px;">
                <div class="calc-input-grid">
                    <div class="input-group"><label>CVi (%)</label><input type="number" id="cust-cvi" value="5"></div>
                    <div class="input-group"><label>CVg (%)</label><input type="number" id="cust-cvg" value="10"></div>
                    <div class="input-group"><label>Low Limit</label><input type="number" id="cust-l" value="0"></div>
                    <div class="input-group"><label>High Limit</label><input type="number" id="cust-u" value="100"></div>
                </div>
            </div>

            <div class="input-group">
                <label>Method</label>
                <select id="pbrtqc-method" onchange="togglePBRTQCParams()">
                    <option value="auto">✨ Auto (Optimal)</option>
                    <option value="ewma">EWMA</option>
                    <option value="ma">MA</option>
                </select>
            </div>

            <div id="param-container" style="background:var(--bg-input); padding:10px; border-radius:10px; margin-bottom:15px;">
                <div class="input-group" id="param-mode-group">
                    <label>Parameter Mode</label>
                    <select id="param-mode" onchange="toggleManualParams()">
                        <option value="auto">Auto (From Table)</option>
                        <option value="manual">Manual Entry</option>
                    </select>
                </div>
                
                <div id="manual-params" style="display:none; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div class="ewma-only input-group"><label>Lambda (λ)</label><input type="number" id="manual-lambda" step="0.01"></div>
                    <div class="ewma-only input-group"><label>Limit (L)</label><input type="number" id="manual-l" step="0.1"></div>
                    <div class="ma-only input-group"><label>Window (w)</label><input type="number" id="manual-w" step="1"></div>
                </div>
                <div id="auto-param-display" style="font-size:0.8rem; color:var(--primary); font-weight:bold;"></div>
            </div>

            <div class="input-group">
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <button class="btn-action btn-secondary" style="flex:1;" onclick="triggerExcelInput()">
                        <i class="fa-solid fa-file-excel"></i> Upload Excel
                    </button>
                    
                    <input type="file" id="excel-upload" accept=".xlsx, .xls" style="display:none;" onchange="handleExcelUpload(this)">
                    <span id="pbrtqc-upload-status" style="font-size:0.8rem; color:var(--success); display:none; margin-left:5px;"></span>
                    
                    <button class="btn-action btn-secondary" style="flex:1;" onclick="downloadTemplate()">
                        <i class="fa-solid fa-download"></i> Template
                    </button>
                </div>
                
                <div style="display:flex; gap:10px;">
                    <input type="number" id="single-val-input" placeholder="Enter manual value..." style="flex:1;">
                    <button class="btn-action" style="width:auto; margin:0; padding:0 20px;" onclick="addManualValue()">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                </div>
            </div>

            <div style="max-height:150px; overflow-y:auto; border:1px solid var(--border-color); margin-bottom:10px;">
                <table class="data-table">
                    <thead style="background:var(--primary-light); position:sticky; top:0;"><tr><th>No</th><th>Value</th><th>...</th></tr></thead>
                    <tbody id="manual-data-tbody"></tbody>
                </table>
            </div>
            <div style="text-align:right;"><button class="btn-secondary" style="padding:2px 8px; font-size:0.7rem;" onclick="clearManualData()">Clear</button></div>

            <div style="display:flex; gap:10px; margin-top:10px;">
                <label><input type="checkbox" id="opt-trunc" checked> <span>Truncation (RCV)</span></label>
                <label><input type="checkbox" id="opt-norm" checked> <span>Log Trans.</span></label>
            </div>

            <button class="btn-action" onclick="runPBRTQC()">CALCULATE & PLOT</button>

            <div id="qc-result-area" style="display:none;">
                <div class="chart-container"><canvas id="qcChart"></canvas></div>
                <div id="qc-stats" class="warning-box" style="display:block; margin-top:10px;"></div>
                <button class="btn-action btn-secondary" onclick="downloadHighResChart('qcChart')"><i class="fa-solid fa-download"></i> Download Chart (HD)</button>
            </div>
        </div>
    </div>

    <div class="qc-card">
        <div class="qc-header" onclick="toggleQC('qc-sigma', this)">
            <h3><i class="fa-solid fa-bullseye"></i> Sigma Metric & Method Decision</h3>
            <i class="fa-solid fa-chevron-down"></i>
        </div>
        <div id="qc-sigma" class="qc-body">
            <div class="calc-input-grid">
                <div class="input-group">
                    <div class="label-row"><label>TEa (Total Allowable Error)</label><span class="unit-badge">%</span></div>
                    <input type="number" id="sigma-tea">
                </div>
                <div class="input-group">
                    <div class="label-row"><label>CV (Coeff. of Variation)</label><span class="unit-badge">%</span></div>
                    <input type="number" id="sigma-cv">
                </div>
                <div class="input-group">
                    <div class="label-row"><label>Bias</label><span class="unit-badge">%</span></div>
                    <input type="number" id="sigma-bias">
                </div>
                <div class="input-group" style="display:flex; align-items:center;">
                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-weight:500;">
                        <input type="checkbox" id="sigma-use-bias" checked onchange="updateSigmaBiasToggle()">
                        Use Bias in Calculation
                    </label>
                </div>
                <div id="res-sigma-final" class="final-result-box" style="grid-column: span 2;"></div>
            </div>
            
            <div class="input-group" style="margin-top:15px;">
                <button class="btn-action" onclick="runSigmaMetric()">CALCULATE & PLOT</button>
            </div>
            <div style="margin-top:20px;">
                <h4 style="margin-bottom:10px; color:var(--text-main); font-size:0.9rem;">Normalized Method Decision Chart</h4>
                <div class="chart-container" style="height:350px;">
                    <canvas id="sigmaChart"></canvas>
                </div>
                <button class="btn-action btn-secondary" onclick="downloadHighResChart('sigmaChart')" style="margin-top:10px;"><i class="fa-solid fa-download"></i> Download Chart (HD)</button>
                <div style="margin-top:10px; font-size:0.75rem; color:var(--text-light); text-align:center;">
                    Y-Axis: Bias % | X-Axis: CV % | Lines: Sigma Zones (2, 3, 4, 5, 6)
                </div>
            </div>
        </div>
    </div>

    <div class="qc-card">
        <div class="qc-header" onclick="toggleQC('qc-carryover', this)">
            <h3><i class="fa-solid fa-arrows-turn-to-dots"></i> Carryover Analysis</h3>
            <i class="fa-solid fa-chevron-down"></i>
        </div>
        <div id="qc-carryover" class="qc-body">
            <div class="input-group full-width" style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                <label style="margin:0; color:var(--primary); font-weight:600;">TEa</label>
                <input type="number" id="carry-tea" step="0.01" placeholder="Enter TEa" style="max-width:120px;">
                <a href="https://westgard.com/clia-a-quality/quality-requirements/2024-clia-requirements.html" target="_blank" title="CLIA 2025 Acceptance Limits" style="color:var(--primary); text-decoration:none;">
                    <i class="fa-solid fa-up-right-from-square"></i>
                </a>
            </div>
            <div class="input-group full-width" style="font-size:0.8rem; color:var(--text-light);">
                <label style="display:block; margin-bottom:6px; color:var(--primary);">Sequence</label>
                <div>L1-L2-L3-H1-H2-L4-H3-H4-L5-L6-L7-L8-H5-H6-L9-H7-H8-L10-H9-H10-L11</div>
            </div>
            <div style="display:flex; flex-wrap:nowrap; gap:6px; overflow-x:auto; padding:8px; background:var(--bg-input); border-radius:10px;">
                <div style="display:flex; flex-direction:column; align-items:center; min-width:60px;"><div style="font-size:0.7rem; color:var(--text-light);">L1</div><input type="number" id="carry-L1" step="0.01" style="width:60px; text-align:center;"></div>
                <div style="display:flex; flex-direction:column; align-items:center; min-width:60px;"><div style="font-size:0.7rem; color:var(--text-light);">L2</div><input type="number" id="carry-L2" step="0.01" style="width:60px; text-align:center;"></div>
                <div style="display:flex; flex-direction:column; align-items:center; min-width:60px;"><div style="font-size:0.7rem; color:var(--text-light);">L3</div><input type="number" id="carry-L3" step="0.01" style="width:60px; text-align:center;"></div>
                <div style="display:flex; flex-direction:column; align-items:center; min-width:60px;"><div style="font-size:0.7rem; color:var(--text-light);">H1</div><input type="number" id="carry-H1" step="0.01" style="width:60px; text-align:center;"></div>
                <div style="display:flex; flex-direction:column; align-items:center; min-width:60px;"><div style="font-size:0.7rem; color:var(--text-light);">H2</div><input type="number" id="carry-H2" step="0.01" style="width:60px; text-align:center;"></div>
                <div style="display:flex; flex-direction:column; align-items:center; min-width:60px;"><div style="font-size:0.7rem; color:var(--text-light);">L4</div><input type="number" id="carry-L4" step="0.01" style="width:60px; text-align:center;"></div>
                <div style="display:flex; flex-direction:column; align-items:center; min-width:60px;"><div style="font-size:0.7rem; color:var(--text-light);">H3</div><input type="number" id="carry-H3" step="0.01" style="width:60px; text-align:center;"></div>
                <div style="display:flex; flex-direction:column; align-items:center; min-width:60px;"><div style="font-size:0.7rem; color:var(--text-light);">H4</div><input type="number" id="carry-H4" step="0.01" style="width:60px; text-align:center;"></div>
                <div style="display:flex; flex-direction:column; align-items:center; min-width:60px;"><div style="font-size:0.7rem; color:var(--text-light);">L5</div><input type="number" id="carry-L5" step="0.01" style="width:60px; text-align:center;"></div>
                <div style="display:flex; flex-direction:column; align-items:center; min-width:60px;"><div style="font-size:0.7rem; color:var(--text-light);">L6</div><input type="number" id="carry-L6" step="0.01" style="width:60px; text-align:center;"></div>
                <div style="display:flex; flex-direction:column; align-items:center; min-width:60px;"><div style="font-size:0.7rem; color:var(--text-light);">L7</div><input type="number" id="carry-L7" step="0.01" style="width:60px; text-align:center;"></div>
                <div style="display:flex; flex-direction:column; align-items:center; min-width:60px;"><div style="font-size:0.7rem; color:var(--text-light);">L8</div><input type="number" id="carry-L8" step="0.01" style="width:60px; text-align:center;"></div>
                <div style="display:flex; flex-direction:column; align-items:center; min-width:60px;"><div style="font-size:0.7rem; color:var(--text-light);">H5</div><input type="number" id="carry-H5" step="0.01" style="width:60px; text-align:center;"></div>
                <div style="display:flex; flex-direction:column; align-items:center; min-width:60px;"><div style="font-size:0.7rem; color:var(--text-light);">H6</div><input type="number" id="carry-H6" step="0.01" style="width:60px; text-align:center;"></div>
                <div style="display:flex; flex-direction:column; align-items:center; min-width:60px;"><div style="font-size:0.7rem; color:var(--text-light);">L9</div><input type="number" id="carry-L9" step="0.01" style="width:60px; text-align:center;"></div>
                <div style="display:flex; flex-direction:column; align-items:center; min-width:60px;"><div style="font-size:0.7rem; color:var(--text-light);">H7</div><input type="number" id="carry-H7" step="0.01" style="width:60px; text-align:center;"></div>
                <div style="display:flex; flex-direction:column; align-items:center; min-width:60px;"><div style="font-size:0.7rem; color:var(--text-light);">H8</div><input type="number" id="carry-H8" step="0.01" style="width:60px; text-align:center;"></div>
                <div style="display:flex; flex-direction:column; align-items:center; min-width:60px;"><div style="font-size:0.7rem; color:var(--text-light);">L10</div><input type="number" id="carry-L10" step="0.01" style="width:60px; text-align:center;"></div>
                <div style="display:flex; flex-direction:column; align-items:center; min-width:60px;"><div style="font-size:0.7rem; color:var(--text-light);">H9</div><input type="number" id="carry-H9" step="0.01" style="width:60px; text-align:center;"></div>
                <div style="display:flex; flex-direction:column; align-items:center; min-width:60px;"><div style="font-size:0.7rem; color:var(--text-light);">H10</div><input type="number" id="carry-H10" step="0.01" style="width:60px; text-align:center;"></div>
                <div style="display:flex; flex-direction:column; align-items:center; min-width:60px;"><div style="font-size:0.7rem; color:var(--text-light);">L11</div><input type="number" id="carry-L11" step="0.01" style="width:60px; text-align:center;"></div>
            </div>
            <div class="input-group" style="margin-top:10px;">
                <button class="btn-action" onclick="runCarryover()">CALCULATE</button>
            </div>
            <div id="carry-result" style="display:none; margin-top:15px;">
                <div id="carry-summary" class="final-result-box" style="margin-bottom:10px;"></div>
                <div id="carry-group-stats" class="warning-box" style="display:block;"></div>
                <div id="carry-conclusion" class="final-result-box" style="font-weight:bold; text-align:center; margin-top:10px;"></div>
            </div>
        </div>
    </div>

    <div class="qc-card">
    <div class="qc-header" onclick="toggleQC('qc-rcv', this)">
        <h3><i class="fa-solid fa-calculator"></i> Delta Calculation- Reference Change Value (RCV)</h3>
        <i class="fa-solid fa-chevron-down"></i>
    </div>
    <div id="qc-rcv" class="qc-body">
        <div class="calc-input-grid">
            <div class="input-group">
                <label>Patient’s Previous Result</label>
                <input type="number" id="rcv-old" step="0.01">
            </div>
            <div class="input-group">
                <label>Patient’s Current Result</label>
                <input type="number" id="rcv-new" step="0.01">
            </div>
            <div class="input-group">
                <label>Within-Subject Variation CV<sub>I</sub> (%) 
                    <a href="https://biologicalvariation.eu/meta_calculations" target="_blank" style="margin-left:5px; color:var(--primary); text-decoration:none;" title="EFLM Biological Variation Database">
                        <i class="fa-solid fa-external-link-alt" style="font-size:0.75rem;"></i>
                    </a>
                </label>
                <input type="number" id="rcv-cvi" step="0.1">
            </div>
            <div class="input-group">
                <label>Between-Subject Variation CV<sub>G</sub> (%) 
                    <a href="https://biologicalvariation.eu/meta_calculations" target="_blank" style="margin-left:5px; color:var(--primary); text-decoration:none;" title="EFLM Biological Variation Database">
                        <i class="fa-solid fa-external-link-alt" style="font-size:0.75rem;"></i>
                    </a>
                </label>
                <input type="number" id="rcv-cvg" step="0.1">
            </div>
            <div class="input-group full-width">
                <label>Significance Level</label>
                <select id="rcv-z">
                    <option value="1.96">p < 0.05 (z = 1.96)</option>
                    <option value="2.58">p < 0.01 (z = 2.58)</option>
                </select>
            </div>
        </div>
        
        <button class="btn-action" onclick="calculateRCV()" style="margin-top:15px;">CALCULATE</button>
        
        <div id="rcv-result" style="margin-top:20px; padding:15px; border-radius:10px; background:var(--bg-input); display:none;">
            <div style="font-size:1.1rem; font-weight:bold; margin-bottom:10px;" id="rcv-percent"></div>
            <div style="font-size:1rem; margin-bottom:10px;" id="rcv-value"></div>
            <div style="font-size:1rem; margin-bottom:10px; padding:8px; background:var(--bg-body); border-radius:6px;" id="rcv-ii"></div>
            <div style="font-size:1.2rem; font-weight:bold; padding:10px; border-radius:8px; text-align:center;" id="rcv-conclusion"></div>
        </div>
    </div>
</div>

<div class="qc-card">
    <div class="qc-header" onclick="toggleQC('qc-ii', this)">
        <h3><i class="fa-solid fa-user-check"></i> Individuality Index (II)</h3>
        <i class="fa-solid fa-chevron-down"></i>
    </div>
    <div id="qc-ii" class="qc-body">
        <div class="calc-input-grid">
            <div class="input-group">
                <label>CV<sub>I</sub> (%) 
                    <a href="https://biologicalvariation.eu/meta_calculations" target="_blank" style="margin-left:5px; color:var(--primary); text-decoration:none;" title="EFLM Biological Variation Database">
                        <i class="fa-solid fa-external-link-alt" style="font-size:0.75rem;"></i>
                    </a>
                </label>
                <input type="number" id="ii-cvi" step="0.1" oninput="calculateII()">
            </div>
            <div class="input-group">
                <label>CV<sub>G</sub> (%) 
                    <a href="https://biologicalvariation.eu/meta_calculations" target="_blank" style="margin-left:5px; color:var(--primary); text-decoration:none;" title="EFLM Biological Variation Database">
                        <i class="fa-solid fa-external-link-alt" style="font-size:0.75rem;"></i>
                    </a>
                </label>
                <input type="number" id="ii-cvg" step="0.1" oninput="calculateII()">
            </div>
        </div>
        <div id="ii-result" style="margin-top:20px; padding:15px; border-radius:10px; background:var(--bg-input); display:none;">
            <div style="font-size:1.3rem; font-weight:bold; margin-bottom:15px; text-align:center; color:var(--primary);" id="ii-value"></div>
            <div style="font-size:0.95rem; padding:12px; border-radius:8px; line-height:1.5;" id="ii-interpretation"></div>
        </div>
    </div>
</div>

</div>


    <div id="tab-info" class="section">
        <div class="calculator-view" style="display:block;">
            <h3>Laboratory Handbook</h3>
            <p>Turkish Ministry of Health, Medical Biochemistry Regulations, Letters, Legislation Documents</p>
            <button class="btn-action" onclick="window.open('https://drive.google.com/drive/folders/1dayFfTfZdNzpzFO80tXyA1vU5qtAsBvP?usp=drive_link')">Google Drive <i class="fa-solid fa-arrow-up-right-from-square"></i></button>
        </div>
        
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:12px; margin-top:15px;">
    
    <div class="calculator-view external-link-card" style="display:block; margin:0; padding:15px; text-align:center;" onclick="window.open('https://www.mayocliniclabs.com', '_blank')">
        <i class="fa-solid fa-microscope" style="font-size:2rem; color:var(--primary); margin-bottom:10px;"></i>
        <h4 style="font-size:0.85rem;">Mayo Clinic Labs</h4>
        <span style="font-size:0.7rem; color:var(--text-light);">Test Catalog</span>
    </div>

    <div class="calculator-view external-link-card" style="display:block; margin:0; padding:15px; text-align:center;" onclick="window.open('https://clinical-laboratory-diagnostics.com/', '_blank')">
        <i class="fa-solid fa-book-medical" style="font-size:2rem; color:var(--primary); margin-bottom:10px;"></i>
        <h4 style="font-size:0.85rem;">Clinical Lab Diagnostics</h4>
        <span style="font-size:0.7rem; color:var(--text-light);">Online Textbook</span>
    </div>

    <div class="calculator-view external-link-card" style="display:block; margin:0; padding:15px; text-align:center;" onclick="window.open('https://myadlm.org/', '_blank')">
        <i class="fa-solid fa-flask-vial" style="font-size:2rem; color:var(--primary); margin-bottom:10px;"></i>
        <h4 style="font-size:0.85rem;">ADLM (AACC)</h4>
        <span style="font-size:0.7rem; color:var(--text-light);">Lab Medicine Authority</span>
    </div>

    <div class="calculator-view external-link-card" style="display:block; margin:0; padding:15px; text-align:center;" onclick="window.open('https://labtestsonline.org.uk/', '_blank')">
        <i class="fa-solid fa-vial-circle-check" style="font-size:2rem; color:var(--primary); margin-bottom:10px;"></i>
        <h4 style="font-size:0.85rem;">Lab Tests Online</h4>
        <span style="font-size:0.7rem; color:var(--text-light);">Test Explanations</span>
    </div>

    <div class="calculator-view external-link-card" style="display:block; margin:0; padding:15px; text-align:center;" onclick="window.open('https://www.turkbiyokimyadernegi.org.tr/', '_blank')">
        <i class="fa-solid fa-dna" style="font-size:2rem; color:var(--primary); margin-bottom:10px;"></i>
        <h4 style="font-size:0.85rem;">TBD</h4>
        <span style="font-size:0.7rem; color:var(--text-light);">Türk Biyokimya Derneği</span>
    </div>

    <div class="calculator-view external-link-card" style="display:block; margin:0; padding:15px; text-align:center;" onclick="window.open('https://tkbd.org/', '_blank')">
        <i class="fa-solid fa-hospital-user" style="font-size:2rem; color:var(--primary); margin-bottom:10px;"></i>
        <h4 style="font-size:0.85rem;">TKBD</h4>
        <span style="font-size:0.7rem; color:var(--text-light);">Klinik Biyokimya Derneği</span>
    </div>

    <div class="calculator-view external-link-card" style="display:block; margin:0; padding:15px; text-align:center;" onclick="window.open('https://kbud.org.tr/', '_blank')">
        <i class="fa-solid fa-user-doctor" style="font-size:2rem; color:var(--primary); margin-bottom:10px;"></i>
        <h4 style="font-size:0.85rem;">KBUD</h4>
        <span style="font-size:0.7rem; color:var(--text-light);">Biyokimya Uzmanları Derneği</span>
    </div>

    <div class="calculator-view external-link-card" style="display:block; margin:0; padding:15px; text-align:center;" onclick="window.open('https://www.reddit.com/r/medlabprofessionals/', '_blank')">
        <i class="fa-brands fa-reddit-alien" style="font-size:2rem; color:var(--primary); margin-bottom:10px;"></i>
        <h4 style="font-size:0.85rem;">Reddit MedLab</h4>
        <span style="font-size:0.7rem; color:var(--text-light);">Global Lab Community</span>
    </div>

    <div class="calculator-view external-link-card" style="display:block; margin:0; padding:15px; text-align:center;" onclick="window.open('https://laberrorfinder.streamlit.app/', '_blank')">
    <i class="fa-solid fa-magnifying-glass-chart" style="font-size:2rem; color:var(--primary); margin-bottom:10px;"></i>
    <h4 style="font-size:0.85rem;">Lab Error Finder</h4>
    <span style="font-size:0.7rem; color:var(--text-light);">Lab Error Finder</span>
</div>

<div class="calculator-view external-link-card" style="display:block; margin:0; padding:15px; text-align:center;" onclick="window.open('https://hikmetc-qcconstellation.streamlit.app/', '_blank')">
    <i class="fa-solid fa-star" style="font-size:2rem; color:var(--primary); margin-bottom:10px;"></i>
    <h4 style="font-size:0.85rem;">QC Constellation</h4>
    <span style="font-size:0.7rem; color:var(--text-light);">Quality Control App</span>
</div>

</div>

        <div class="calculator-view" style="display:block; margin-top:15px;">
            <h3 style="color:var(--primary); margin-bottom:15px; border-bottom:1px solid var(--border-color); padding-bottom:10px;">
                <i class="fa-solid fa-newspaper"></i> Journals
            </h3>
            <div id="pubmedJournalWidget" style="display:block; margin-bottom:15px;">
                <div style="display:flex; gap:10px; align-items:center; margin-bottom:6px;">
                    <span style="font-size:0.85rem; color:var(--text-light);">Please select the journals you wish to follow and the number of recent articles to display, then click Lab Digest to continue.
</span>
                </div>
                <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px; flex-wrap:nowrap; justify-content:flex-start;">
    <select id="pubmedCountSelect" class="input-group" style="width:160px; padding:10px; border-radius:8px; height:42px; margin:0;">
        <option value="5">Last 5</option>
        <option value="10">Last 10</option>
        <option value="15">Last 15</option>
        <option value="20">Last 20</option>
        <option value="30">Last 30</option>
    </select>
    
    <button class="btn-action morning-brief-btn" onclick="loadPubMedJournalsLatest()" style="width:auto; margin:0; padding:0 20px; height:42px; display:inline-flex; align-items:center; gap:12px;">
        <i class="fa-solid fa-flask"></i> 
        <span>Lab Digest</span>
    </button>
</div>
</button>
                </div>
                <div id="pubmedJournalResults" style="border:1px solid var(--border-color); border-radius:10px; background:var(--bg-card); padding:10px; max-height:300px; overflow-y:auto;"></div>
            </div>
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                <input id="journalSearchInput" class="input-group" type="text" placeholder="Search journals" style="flex:1; padding:10px; border-radius:8px;" oninput="filterJournalLists()">
            </div>
            <div class="journal-list" id="rssJournalList">
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap; line-height:1;">
                    <button data-journal="Clinical Chemistry" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px; vertical-align:middle;" onclick="toggleFav('Clinical Chemistry', this)"></button>
                    <a href="https://academic.oup.com/clinchem" target="_blank" class="journal-link">Clinical Chemistry</a>
                </div>
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap; line-height:1;">
                    <button data-journal="American Journal of Clinical Pathology" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px; vertical-align:middle;" onclick="toggleFav('American Journal of Clinical Pathology', this)"></button>
                    <a href="https://academic.oup.com/ajcp" target="_blank" class="journal-link">American Journal of Clinical Pathology</a>
                </div>
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap; line-height:1;">
                    <button data-journal="Advances in Laboratory Medicine" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px; vertical-align:middle;" onclick="toggleFav('Advances in Laboratory Medicine', this)"></button>
                    <a href="https://www.degruyterbrill.com/journal/key/almed/html#latestIssue" target="_blank" class="journal-link">Advances in Laboratory Medicine</a>
                </div>
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap;">
                    <button data-journal="Annals of Clinical Biochemistry" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px;" onclick="toggleFav('Annals of Clinical Biochemistry', this)"></button>
                    <a href="https://journals.sagepub.com/home/acb" target="_blank" class="journal-link">Annals of Clinical Biochemistry</a>
                </div>
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap;">
                    <button data-journal="Annals of Laboratory Medicine" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px;" onclick="toggleFav('Annals of Laboratory Medicine', this)"></button>
                    <a href="https://www.annlabmed.org/main.html" target="_blank" class="journal-link">Annals of Laboratory Medicine</a>
                </div>
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap;">
                    <button data-journal="Biochemia Medica" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px;" onclick="toggleFav('Biochemia Medica', this)"></button>
                    <a href="https://www.biochemia-medica.com/en" target="_blank" class="journal-link">Biochemia Medica</a>
                </div>
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap; line-height:1;">
                    <button data-journal="Clinica Chimica Acta" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px;" onclick="toggleFav('Clinica Chimica Acta', this)"></button>
                    <a href="https://www.sciencedirect.com/journal/clinica-chimica-acta" target="_blank" class="journal-link">Clinica Chimica Acta</a>
                </div>
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap; line-height:1;">
                    <button data-journal="Clinical Laboratory" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px;" onclick="toggleFav('Clinical Laboratory', this)"></button>
                    <a href="https://www.clin-lab-publications.com/" target="_blank" class="journal-link">Clinical Laboratory</a>
                </div>
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap; line-height:1;">
                    <button data-journal="Clinical Chemistry and Laboratory Medicine" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px;" onclick="toggleFav('Clinical Chemistry and Laboratory Medicine', this)"></button>
                    <a href="https://www.degruyterbrill.com/journal/key/cclm/html" target="_blank" class="journal-link">Clinical Chemistry and Laboratory Medicine</a>
                </div>
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap; line-height:1;">
                    <button data-journal="Critical Reviews in Clinical Laboratory Sciences" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px;" onclick="toggleFav('Critical Reviews in Clinical Laboratory Sciences', this)"></button>
                    <a href="https://www.tandfonline.com/journals/ilab20" target="_blank" class="journal-link">Critical Reviews in Clinical Laboratory Sciences</a>
                </div>
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap; line-height:1;">
                    <button data-journal="eJIFCC" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px;" onclick="toggleFav('eJIFCC', this)"></button>
                    <a href="https://pmc.ncbi.nlm.nih.gov/journals/?term=%22EJIFCC%22" target="_blank" class="journal-link">eJIFCC</a>
                </div>
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap; line-height:1;">
                    <button data-journal="International Journal of Analytical Chemistry" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px;" onclick="toggleFav('International Journal of Analytical Chemistry', this)"></button>
                    <a href="https://onlinelibrary.wiley.com/journal/7072" target="_blank" class="journal-link">International Journal of Analytical Chemistry</a>
                </div>
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap; line-height:1;">
                    <button data-journal="Journal of Analytical Toxicology" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px;" onclick="toggleFav('Journal of Analytical Toxicology', this)"></button>
                    <a href="https://academic.oup.com/jat" target="_blank" class="journal-link">Journal of Analytical Toxicology</a>
                </div>
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap; line-height:1;">
                    <button data-journal="Journal of Clinical Laboratory Analysis" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px;" onclick="toggleFav('Journal of Clinical Laboratory Analysis', this)"></button>
                    <a href="https://onlinelibrary.wiley.com/journal/10982825" target="_blank" class="journal-link">Journal of Clinical Laboratory Analysis</a>
                </div>
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap; line-height:1;">
                    <button data-journal="Applied Biochemistry and Biotechnology" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px;" onclick="toggleFav('Applied Biochemistry and Biotechnology', this)"></button>
                    <a href="https://link.springer.com/journal/12010" target="_blank" class="journal-link">Applied Biochemistry and Biotechnology</a>
                </div>
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap; line-height:1;">
                    <button data-journal="Indian Journal of Clinical Biochemistry" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px;" onclick="toggleFav('Indian Journal of Clinical Biochemistry', this)"></button>
                    <a href="https://link.springer.com/journal/12291" target="_blank" class="journal-link">Indian Journal of Clinical Biochemistry</a>
                </div>
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap; line-height:1;">
                    <button data-journal="Journal of Laboratory Automation" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px;" onclick="toggleFav('Journal of Laboratory Automation', this)"></button>
                    <a href="https://journals.sagepub.com/home/jla" target="_blank" class="journal-link">Journal of Laboratory Automation</a>
                </div>
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap; line-height:1;">
                    <button data-journal="Chemistry and Physics of Lipids" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px;" onclick="toggleFav('Chemistry and Physics of Lipids', this)"></button>
                    <a href="https://www.sciencedirect.com/journal/chemistry-and-physics-of-lipids" target="_blank" class="journal-link">Chemistry and Physics of Lipids</a>
                </div>
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap; line-height:1;">
                    <button data-journal="Biological Trace Element Research" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px;" onclick="toggleFav('Biological Trace Element Research', this)"></button>
                    <a href="https://link.springer.com/journal/12011" target="_blank" class="journal-link">Biological Trace Element Research</a>
                </div>
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap; line-height:1;">
                    <button data-journal="Clinical and Experimental Medicine" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px;" onclick="toggleFav('Clinical and Experimental Medicine', this)"></button>
                    <a href="https://link.springer.com/journal/10238" target="_blank" class="journal-link">Clinical and Experimental Medicine</a>
                </div>
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap; line-height:1;">
                    <button data-journal="Annals of Clinical & Laboratory Science" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px;" onclick="toggleFav('Annals of Clinical & Laboratory Science', this)"></button>
                    <a href="http://www.annclinlabsci.org/" target="_blank" class="journal-link">Annals of Clinical & Laboratory Science</a>
                </div>
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap; line-height:1;">
                    <button data-journal="Laboratory Medicine" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px;" onclick="toggleFav('Laboratory Medicine', this)"></button>
                    <a href="https://academic.oup.com/labmed" target="_blank" class="journal-link">Laboratory Medicine</a>
                </div>
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap; line-height:1;">
                    <button data-journal="Practical Laboratory Medicine" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px;" onclick="toggleFav('Practical Laboratory Medicine', this)"></button>
                    <a href="https://www.sciencedirect.com/journal/practical-laboratory-medicine" target="_blank" class="journal-link">Practical Laboratory Medicine</a>
                </div>
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap; line-height:1;">
                    <button data-journal="Scandinavian Journal of Clinical and Laboratory Investigation" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px;" onclick="toggleFav('Scandinavian Journal of Clinical and Laboratory Investigation', this)"></button>
                    <a href="https://www.tandfonline.com/journals/iclb20" target="_blank" class="journal-link">Scandinavian Journal of Clinical and Laboratory Investigation</a>
                </div>
                <div style="display:flex; align-items:center; gap:6px; white-space:nowrap; line-height:1;">
                    <button data-journal="The Journal of Applied Laboratory Medicine" class="btn-action btn-secondary" style="width:18px; height:18px; padding:0; font-size:0.8rem; line-height:1; min-width:unset; display:inline-flex; align-items:center; justify-content:center; border-radius:4px;" onclick="toggleFav('The Journal of Applied Laboratory Medicine', this)"></button>
                    <a href="https://academic.oup.com/jalm" target="_blank" class="journal-link">The Journal of Applied Laboratory Medicine</a>
                </div>
            </div>
            <h4 style="font-size:0.85rem; color:var(--text-light); margin:10px 0 6px 0;">Also visit journals</h4>
            <div class="journal-list" id="visitJournalList">
                <div style="white-space:nowrap;">
                    <a href="https://www.bslonline.org/main.html" target="_blank" class="journal-link">Biomedical Science Letters</a>
                </div>
                <div style="white-space:nowrap;">
                    <a href="https://jlpm.amegroups.org/" target="_blank" class="journal-link">Journal of Laboratory and Precision Medicine</a>
                </div>
                <div style="white-space:nowrap;">
                    <a href="https://www.degruyterbrill.com/journal/key/labm/html#issues" target="_blank" class="journal-link">Journal of Laboratory Medicine</a>
                </div>
                <div style="white-space:nowrap;">
                    <a href="https://www.sciencedirect.com/journal/labmed-discovery" target="_blank" class="journal-link">LabMed Discovery</a>
                </div>
                <div style="white-space:nowrap;">
                    <a href="https://njlm.net/" target="_blank" class="journal-link">National Journal Laboratory Medicine</a>
                </div>
                <div style="white-space:nowrap;">
                    <a href="https://www.kjcls.org/main.html" target="_blank" class="journal-link">The Korean Journal of Clinical Laboratory Science</a>
                </div>
                <div style="white-space:nowrap;">
                    <a href="https://journals.lww.com/drug-monitoring/pages/default.aspx" target="_blank" class="journal-link">Therapeutic Drug Monitoring</a>
                </div>
                <div style="white-space:nowrap;">
                    <a href="https://tkb.dergisi.org/" target="_blank" class="journal-link">Türk Klinik Biyokimya Dergisi</a>
                </div>
                <div style="white-space:nowrap;">
                    <a href="https://www.degruyterbrill.com/journal/key/tjb/html#issues" target="_blank" class="journal-link">Turkish Journal of Biochemistry</a>
                </div>
            </div>
            <!-- Removed other widgets to simplify: using PubMed journal aggregator only -->
        </div>
    </div>

    <div id="tab-notes" class="section">
        <div class="calculator-view" style="display:block;">
            <h3>Personal Notes</h3>
            <textarea id="myNotes" style="width:100%; height:300px; padding:10px; border-radius:10px; border:1px solid var(--border-color);" oninput="localStorage.setItem('labNotes', this.value)"></textarea>
        </div>
    </div>

</div>

<footer>
    <div class="footer-info">
        <p style="font-weight:600; margin-bottom:5px;">Medical Biochemistry Lab Assistant</p>
        <p style="opacity:0.7; font-size:0.65rem; margin-bottom:5px;">Content provided here is for general information purposes only.</p>
        <p style="font-size:0.75rem; margin-bottom:8px;">Contact: belginsaraa@gmail.com</p>
        <a href="https://github.com/belqin" target="_blank" class="signature-link">
            <p class="signature">Prepared by: Belgin ŞARA, MD</p>
        </a>
    </div>
    <div class="footer-controls">
        <button class="control-btn" onclick="toggleTheme()" id="themeBtn"><i class="fa-solid fa-moon"></i></button>
    </div>
</footer>

<script>
    Chart.register(ChartDataLabels);
    try { Chart.register(window.ChartZoom || window['chartjs-plugin-zoom']); } catch(e) {}
    const ljBgPlugin = {
        id: 'ljBgPlugin',
        beforeDraw(chart, args, pluginOptions) {
            const { ctx, chartArea, scales } = chart;
            if (!chartArea || !scales || !scales.y) return;
            const y = scales.y;
            const opt = pluginOptions || {};
            const { mean, upper1SD, upper2SD, upper3SD, lower1SD, lower2SD, lower3SD } = opt;
            if ([mean, upper1SD, upper2SD, upper3SD, lower1SD, lower2SD, lower3SD].some(v => typeof v !== 'number')) return;
            const top = chartArea.top, bottom = chartArea.bottom, left = chartArea.left, right = chartArea.right;
            const Y = v => y.getPixelForValue(v);
            ctx.save();
            ctx.fillStyle = 'rgba(255, 182, 193, 0.25)';
            ctx.fillRect(left, top, right - left, Y(upper3SD) - top);
            ctx.fillStyle = 'rgba(255, 228, 230, 0.25)';
            ctx.fillRect(left, Y(upper3SD), right - left, Y(upper2SD) - Y(upper3SD));
            ctx.fillStyle = 'rgba(251, 191, 36, 0.18)';
            ctx.fillRect(left, Y(upper2SD), right - left, Y(upper1SD) - Y(upper2SD));
            ctx.fillStyle = 'rgba(34, 197, 94, 0.12)';
            ctx.fillRect(left, Y(upper1SD), right - left, Y(mean) - Y(upper1SD));
            ctx.fillStyle = 'rgba(34, 197, 94, 0.12)';
            ctx.fillRect(left, Y(mean), right - left, Y(lower1SD) - Y(mean));
            ctx.fillStyle = 'rgba(251, 191, 36, 0.18)';
            ctx.fillRect(left, Y(lower1SD), right - left, Y(lower2SD) - Y(lower1SD));
            ctx.fillStyle = 'rgba(255, 228, 230, 0.25)';
            ctx.fillRect(left, Y(lower2SD), right - left, Y(lower3SD) - Y(lower2SD));
            ctx.fillStyle = 'rgba(255, 182, 193, 0.25)';
            ctx.fillRect(left, Y(lower3SD), right - left, bottom - Y(lower3SD));
            ctx.restore();
        }
    };
    try { Chart.register(ljBgPlugin); } catch(e) {}

    // --- GLOBAL VARIABLES & SETTINGS ---
    let ckdGender = 'female';
    let ckdRace = 'other';
    let schwartzK = 0.55;
    let pbrtqcData = [];
    let ljData = [];
    let qcChart = null;
    let ljChart = null;

    // --- 1. DATABASE (PBRTQC) ---
    const analyteDB = {
        "Albumin": { cvi: 2.5, cvg: 4.1, units: { "g/L (SI)": {l:37, u:48.8}, "g/dL": {l:3.7, u:4.88} }, opt: { m:'ewma', L:2.7, lam:0.02, w:null } },
        "ALP": { cvi: 6.6, cvg: 35.6, units: { "U/L": {l:30, u:120}, "µkat/L (SI)": {l:0.5, u:2.0} }, opt: { m:'ewma', L:2.5, lam:0.05, w:null } },
        "ALT": { cvi: 11.4, cvg: 35.2, units: { "U/L": {l:0, u:41}, "µkat/L (SI)": {l:0, u:0.68} }, opt: { m:'ewma', L:2.5, lam:0.02, w:null } },
        "AST": { cvi: 8.6, cvg: 19.4, units: { "U/L": {l:0, u:40}, "µkat/L (SI)": {l:0, u:0.67} }, opt: { m:'ewma', L:2.5, lam:0.05, w:null } },
        "BUN": { cvi: 13.3, cvg: 20.6, units: { "mmol/L (SI)": {l:2.5, u:7.1}, "mg/dL": {l:7, u:20} }, opt: { m:'ewma', L:2.5, lam:0.02, w:null } },
        "Calcium": { cvi: 1.8, cvg: 2.7, units: { "mmol/L (SI)": {l:2.19, u:2.64}, "mg/dL": {l:8.8, u:10.6} }, opt: { m:'ewma', L:3.0, lam:0.10, w:25 } },
        "Chloride": { cvi: 1.0, cvg: 1.3, units: { "mmol/L (SI)": {l:99.46, u:109.34}, "mEq/L": {l:99.46, u:109.34} }, opt: { m:'ma', L:null, lam:null, w:10 } },
        "HDL Cholesterol": { cvi: 5.7, cvg: 20.0, units: { "mmol/L (SI)": {l:1.03, u:1.55}, "mg/dL": {l:40, u:60} }, opt: { m:'ewma', L:2.5, lam:0.05, w:null } },
        "LDL Cholesterol": { cvi: 7.7, cvg: 20.2, units: { "mmol/L (SI)": {l:1.3, u:3.4}, "mg/dL": {l:50, u:130} }, opt: { m:'ewma', L:2.5, lam:0.05, w:null } },
        "Total Cholesterol": { cvi: 5.2, cvg: 15.3, units: { "mmol/L (SI)": {l:0, u:5.2}, "mg/dL": {l:0, u:200} }, opt: { m:'ewma', L:2.5, lam:0.05, w:null } },
        "Creatinine": { cvi: 4.4, cvg: 16.2, units: { "µmol/L (SI)": {l:62, u:106}, "mg/dL": {l:0.7, u:1.2} }, opt: { m:'ewma', L:2.5, lam:0.02, w:null } },
        "GGT": { cvi: 8.3, cvg: 45.2, units: { "U/L": {l:0, u:60}, "µkat/L (SI)": {l:0, u:1.0} }, opt: { m:'ewma', L:2.5, lam:0.02, w:null } },
        "Glucose": { cvi: 4.6, cvg: 8.1, units: { "mmol/L (SI)": {l:4.0, u:6.88}, "mg/dL": {l:72, u:124} }, opt: { m:'ewma', L:2.5, lam:0.05, w:null } },
        "Iron": { cvi: 27.6, cvg: 26.7, units: { "µmol/L (SI)": {l:11, u:30}, "µg/dL": {l:60, u:170} }, opt: { m:'ewma', L:2.5, lam:0.02, w:null } },
        "LDH": { cvi: 4.4, cvg: 11.8, units: { "U/L": {l:125, u:220}, "µkat/L (SI)": {l:2.0, u:3.7} }, opt: { m:'ewma', L:2.5, lam:0.05, w:null } },
        "Magnesium": { cvi: 2.6, cvg: 5.9, units: { "mmol/L (SI)": {l:0.66, u:1.07}, "mg/dL": {l:1.6, u:2.6} }, opt: { m:'ewma', L:2.5, lam:0.02, w:null } },
        "Phosphate": { cvi: 7.7, cvg: 10.7, units: { "mmol/L (SI)": {l:0.8, u:1.45}, "mg/dL": {l:2.5, u:4.5} }, opt: { m:'ewma', L:2.5, lam:0.02, w:null } },
        "Potassium": { cvi: 3.9, cvg: 5.3, units: { "mmol/L (SI)": {l:3.5, u:5.1}, "mEq/L": {l:3.5, u:5.1} }, opt: { m:'ewma', L:2.5, lam:0.02, w:null } },
        "Sodium": { cvi: 0.5, cvg: 0.7, units: { "mmol/L (SI)": {l:136, u:145}, "mEq/L": {l:136, u:145} }, opt: { m:'ma', L:null, lam:null, w:10 } },
        "Total Bilirubin": { cvi: 20.2, cvg: 24.6, units: { "µmol/L (SI)": {l:5, u:21}, "mg/dL": {l:0.3, u:1.2} }, opt: { m:'ewma', L:2.5, lam:0.02, w:null } },
        "Total Protein": { cvi: 2.6, cvg: 3.5, units: { "g/L (SI)": {l:64, u:83}, "g/dL": {l:6.4, u:8.3} }, opt: { m:'ewma', L:2.5, lam:0.05, w:null } },
        "Triglycerides": { cvi: 19.7, cvg: 33.1, units: { "mmol/L (SI)": {l:0, u:1.7}, "mg/dL": {l:0, u:150} }, opt: { m:'ewma', L:2.5, lam:0.02, w:null } },
        "Uric Acid": { cvi: 8.1, cvg: 22.4, units: { "µmol/L (SI)": {l:200, u:420}, "mg/dL": {l:3.4, u:7.0} }, opt: { m:'ma', L:null, lam:null, w:75 } },
        "Other": { cvi: 0, cvg: 0, units: {}, opt: {} }
    };

    // --- 2. CALCULATOR LIST ---
    const calculators = [
        {id: 'spot-urine', title: 'Spot Urine Analysis', icon: 'fa-vial'},
        { 
    id: 'calc-dilution', 
    title: "Manual Dilution Planner", 
    icon: 'fa-vial', 
    category: 'lab-ops' 
},
{ 
    id: 'calc-serial-planner', 
    title: "Serial Dilution Planner", 
    icon: 'fa-project-diagram', 
    category: 'lab-ops' 
},
        {id: 'urine24', title: '24h Urine', icon: 'fa-flask'},
        {id: 'gfr', title: 'GFR Calculator', icon: 'fa-filter'},
        {id: 'ldl', title: 'LDL Calc', icon: 'fa-heart-pulse'},
        {id: 'homa', title: 'HOMA-IR', icon: 'fa-syringe'},
        {id: 'schwartz', title: 'Schwartz Formula', icon: 'fa-child'},
        {id: 'fib4', title: 'FIB-4 Score', icon: 'fa-file-medical'},
        {id: 'calc-corr-na', title: 'Corrected Sodium', icon: 'fa-vial'},
        {id: 'calc-calcium', title: 'Corrected Calcium', icon: 'fa-bone'},
        {id: 'calc-corr-mg', title: 'Corrected Magnesium', icon: 'fa-capsules'},
        {id: 'calc-anion', title: 'Anion Gap', icon: 'fa-battery-half'},
        {id: 'calc-osmo', title: 'Osmolality', icon: 'fa-droplet'},
        {id: 'calc-fena', title: 'FENa', icon: 'fa-droplet'},
        {id: 'calc-saag', title: 'SAAG', icon: 'fa-vials'},
        {id: 'calc-ph', title: 'pH Estimation', icon: 'fa-wind'},
        {id: 'calc-mentzer', title: 'Mentzer Index', icon: 'fa-syringe'},
        {id: 'calc-albglob', title: 'Alb/Glob Ratio', icon: 'fa-scale-balanced'},
        {id: 'calc-rbc', title: 'RBC Indices', icon: 'fa-circle-dot'},
        {id: 'calc-retic', title: 'Corrected Reticulocyte', icon: 'fa-circle-dot'},
        {id: 'calc-inr', title: 'INR Calc', icon: 'fa-stopwatch'},
        {id: 'calc-bun-crea', title: 'BUN/Creatinine Ratio', icon: 'fa-percentage'},
        {id: 'calc-h-ion', title: 'ABG Validation [H+]', icon: 'fa-vial-circle-check'},
        {id: 'calc-fai', title: 'Free Androgen Index', icon: 'fa-venus-mars'},
        {id: 'calc-fpsa', title: 'Free PSA %', icon: 'fa-mars'},
        {id: 'calc-ca-ion', title: 'Est. Ionized Calcium', icon: 'fa-bone'},
        {id: 'calc-igg-index', title: 'IgG Index', icon: 'fa-brain'},
        {id: 'calc-transferrin', title: 'Transferrin Saturation', icon: 'fa-dumbbell'},
{id: 'calc-lights', 
    title: "Light's Criteria", 
    icon: 'fa-lungs', 
    category: 'fluids'},
        {id: 'calc-a1c', title: 'HbA1c Converter', icon: 'fa-cube'}
    ];

    // --- 3. INIT ---
    window.onload = function() {
        populateAnalyteSelect();
        updatePBRTQCConfig();
        const saved = localStorage.getItem('labNotes');
        if(saved) document.getElementById('myNotes').value = saved;
        loadTheme();
        renderCalcMenu();
        renderLJData();
        initJournalListTicks();
        sortJournalLists();
        // Add onclick to all unit badges that don't have it
        document.querySelectorAll('.unit-badge:not([onclick])').forEach(badge => {
            const unitText = badge.textContent.trim().replace(/\s*\(SI\)/g, '').trim();
            if (
                unitText.includes('mg/dL') ||
                unitText.includes('g/dL') ||
                unitText.includes('mmol/L') ||
                unitText.includes('µmol/L') ||
                unitText.includes('g/L') ||
                unitText.includes('mEq/L') ||
                unitText.includes('U/L') ||
                unitText.includes('µkat/L') ||
                unitText.includes('mmHg') ||
                unitText.includes('kPa') ||
                unitText.includes('10³/µL') ||
                unitText.includes('10⁹/L') ||
                unitText.includes('10⁶/µL') ||
                unitText.includes('10¹²/L') ||
                unitText === 'kg' ||
                unitText === 'lb' ||
                unitText === 'cm' ||
                unitText === 'm' ||
                unitText === 'mL' ||
                unitText === 'L' ||
                unitText.includes('µIU/mL') ||
                unitText.includes('pmol/L') ||
                unitText.includes('ng/mL') ||
                unitText.includes('µg/L')
            ) {
                badge.style.cursor = 'pointer';
                badge.onclick = function() { convertToSI(this); };
                if (!badge.querySelector('i')) {
                    badge.innerHTML += ' <i class="fa-solid fa-rotate"></i>';
                }
            }
        });
        const ljInput = document.getElementById('lj-val');
        if (ljInput) {
            ljInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { e.preventDefault(); addLJPoint(); }
            });
        }
        const pbrtqcInput = document.getElementById('single-val-input');
        if (pbrtqcInput) {
            pbrtqcInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { e.preventDefault(); addManualValue(); }
            });
        }
    };

    function toggleTheme() {
        const body = document.body;
        const isDark = body.getAttribute('data-theme') === 'dark';
        body.setAttribute('data-theme', isDark ? '' : 'dark');
        localStorage.setItem('theme', isDark ? 'light' : 'dark');
        document.querySelector('#themeBtn i').className = isDark ? 'fa-solid fa-moon' : 'fa-solid fa-sun';
    }
    function loadTheme() {
        if(localStorage.getItem('theme') === 'dark') document.body.setAttribute('data-theme', 'dark');
    }

    function switchTab(tabId, btn) {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        const activeSection = document.getElementById(tabId);
        activeSection.classList.add('active');

        if (tabId === 'tab-calc') {
            closeCalcDetail();
        } else {
            activeSection.querySelectorAll('.calculator-view').forEach(view => view.style.display = 'block');
        }
        
        const suggestions = document.getElementById('calcSuggestions');
        if(suggestions) suggestions.style.display = 'none';
    }

    // --- 4. CALC MENU ---
    function renderCalcMenu() {
        const menu = document.getElementById('calc-menu');
        menu.innerHTML = '';
        calculators.sort((a,b) => a.title.localeCompare(b.title));
        
        calculators.forEach(calc => {
            const div = document.createElement('div');
            div.className = 'calc-card-mini';
            div.innerHTML = `<i class="fa-solid ${calc.icon} calc-icon"></i><div class="calc-title">${calc.title}</div>`;
            div.onclick = () => openCalc(calc.id);
            menu.appendChild(div);
        });
    }
    function openCalc(id) {
        document.getElementById('calc-list-view').style.display = 'none';
        document.getElementById('calc-detail-view').style.display = 'block';
        document.querySelectorAll('.calculator-view').forEach(e=>e.style.display='none');
        let targetId = id.startsWith('calc-') ? id : 'calc-'+id;
        if(!document.getElementById(targetId)) targetId = id;
        const target = document.getElementById(targetId);
        if(target) {
            target.style.display='block';
            // Add global SI convert badge next to header and disable per-field conversion
            setTimeout(() => {
                const header = target.querySelector('h3');
                if (header && !header.querySelector('.global-si-badge')) {
                    const siBadge = document.createElement('span');
                    siBadge.className = 'unit-badge global-si-badge';
                    siBadge.style.marginLeft = '10px';
                    siBadge.style.cursor = 'pointer';
                    siBadge.textContent = 'SI unit conversion';
                    siBadge.dataset.mode = 'conv';
                    siBadge.onclick = () => convertCalcToSI(targetId);
                    header.appendChild(siBadge);
                }
                target.querySelectorAll('.unit-badge').forEach(badge => {
                    if (badge.classList.contains('global-si-badge')) return;
                    badge.style.cursor = 'default';
                    badge.onclick = null;
                    const icon = badge.querySelector('i');
                    if (icon) icon.remove();
                });
            }, 10);
        }
    }
    function closeCalcDetail() {
        document.querySelectorAll('.calculator-view input').forEach(el => el.value = '');
        document.querySelectorAll('.mini-result, .final-result-box').forEach(el => el.innerHTML = '');
        document.getElementById('calc-detail-view').style.display = 'none';
        document.getElementById('calc-list-view').style.display = 'block';
    }

    // --- 5. CLINICAL CALCS ---
    function toggleUnit(badge) { 
        if (badge.querySelector('i')) {
            badge.querySelector('i').classList.toggle('fa-spin'); 
        }
    }
    function convertCalcToSI(containerId) {
        const cont = document.getElementById(containerId);
        if (!cont) return;
        const header = cont.querySelector('h3');
        const toggle = header ? header.querySelector('.global-si-badge') : null;
        const currentMode = toggle ? (toggle.dataset.mode || 'conv') : 'conv';
        const badges = Array.from(cont.querySelectorAll('.unit-badge'));
        
        const isBadgeSI = (badge) => {
            const txtNode = badge.cloneNode(true);
            const icon = txtNode.querySelector('i'); if (icon) icon.remove();
            const currentUnit = txtNode.textContent.trim();
            return currentUnit.includes('(SI)') || ['µmol/L','mmol/L','g/L','µkat/L','kPa','10⁹/L','10¹²/L','L','pmol/L','nmol/L','m'].includes(currentUnit.replace(/\s*\(SI\)/g,'').trim());
        };
        
        if (containerId === 'calc-fai') {
            const ttBadge = cont.querySelector('#fai-tt') ? cont.querySelector('#fai-tt').parentNode.querySelector('.unit-badge') : null;
            const shbgBadge = cont.querySelector('#fai-shbg') ? cont.querySelector('#fai-shbg').parentNode.querySelector('.unit-badge') : null;
            const albBadge = cont.querySelector('#fai-alb') ? cont.querySelector('#fai-alb').parentNode.querySelector('.unit-badge') : null;
            if (currentMode !== 'si') {
                if (ttBadge && !isBadgeSI(ttBadge)) convertToSI(ttBadge);
                if (shbgBadge && !isBadgeSI(shbgBadge)) convertToSI(shbgBadge);
                if (albBadge && !isBadgeSI(albBadge)) convertToSI(albBadge);
                if (toggle) { toggle.dataset.mode = 'si'; }
            } else {
                if (ttBadge && isBadgeSI(ttBadge)) convertToSI(ttBadge);
                if (albBadge && isBadgeSI(albBadge)) convertToSI(albBadge);
                if (toggle) { toggle.dataset.mode = 'conv'; }
            }
            badges.forEach(b => { if(b.classList.contains('global-si-badge')) return; b.style.cursor = 'default'; b.onclick = null; const icon = b.querySelector('i'); if(icon) icon.remove(); });
            const inputs = cont.querySelectorAll('input[type="number"]');
            inputs.forEach(inp => { inp.dispatchEvent(new Event('input', { bubbles: true })); });
            return;
        }
        
        if (currentMode !== 'si') {
            badges.forEach(b => { if (!b.classList.contains('global-si-badge') && !isBadgeSI(b)) convertToSI(b); });
            if (toggle) { toggle.dataset.mode = 'si'; }
        } else {
            badges.forEach(b => { if (!b.classList.contains('global-si-badge') && isBadgeSI(b)) convertToSI(b); });
            if (toggle) { toggle.dataset.mode = 'conv'; }
        }
        
        badges.forEach(b => { if(b.classList.contains('global-si-badge')) return; b.style.cursor = 'default'; b.onclick = null; const icon = b.querySelector('i'); if(icon) icon.remove(); });
        const inputs = cont.querySelectorAll('input[type="number"]');
        inputs.forEach(inp => { inp.dispatchEvent(new Event('input', { bubbles: true })); });
    }
    
    // Convert to SI unit when clicking on unit badge
    function convertToSI(badge) {
        const inputGroup = badge.closest('.input-group');
        if (!inputGroup) return;
        const input = inputGroup.querySelector('input');
        if (!input) return;
        
        const currentValue = input.value;
        const value = parseFloat(currentValue);
        const hasValue = !isNaN(value) && currentValue !== '';
        
        let newValue, newUnit;
        
        const badgeText = badge.cloneNode(true);
        if (badgeText.querySelector('i')) badgeText.querySelector('i').remove();
        const currentUnit = badgeText.textContent.trim().replace(/\s*\(SI\)/g, '').trim();
        
        const label = inputGroup.querySelector('label');
        const labelText = label ? label.textContent.toLowerCase() : '';
        
        // Helper to check unit
        const is = (u) => currentUnit === u;
        
        // Check if currently SI
        const isSI = currentUnit.includes('(SI)') || 
                     ['µmol/L', 'mmol/L', 'g/L', 'µkat/L', 'kPa', '10⁹/L', '10¹²/L', 'L', 'pmol/L', 'nmol/L', 'm'].includes(currentUnit);

        if (!isSI) {
            // ---> CONVERT TO SI <---
            if (is('mg/dL')) {
                if (labelText.includes('creatinine')) { newValue = hasValue ? value * 88.4 : undefined; newUnit = 'µmol/L (SI)'; }
                else if (labelText.includes('glucose') || labelText.includes('fasting glucose')) { newValue = hasValue ? value * 0.0555 : undefined; newUnit = 'mmol/L (SI)'; }
                else if (labelText.includes('cholesterol') || labelText.includes('hdl') || labelText.includes('ldl') || labelText.includes('triglyceride')) { newValue = hasValue ? value * 0.0259 : undefined; if(labelText.includes('triglyceride')) newValue = hasValue ? value * 0.0113 : undefined; newUnit = 'mmol/L (SI)'; }
                else if (labelText.includes('calcium') || labelText.includes('total calcium')) { newValue = hasValue ? value * 0.25 : undefined; newUnit = 'mmol/L (SI)'; }
                else if (labelText.includes('bun')) { newValue = hasValue ? value * 0.357 : undefined; newUnit = 'mmol/L (SI)'; }
                else if (labelText.includes('magnesium') || labelText.includes('measured mg')) { newValue = hasValue ? value * 0.4114 : undefined; newUnit = 'mmol/L (SI)'; }
                else if (labelText.includes('phosphorus') || labelText.includes('fosfor')) { newValue = hasValue ? value * 0.3229 : undefined; newUnit = 'mmol/L (SI)'; }
                else if (labelText.includes('protein') || labelText.includes('albumin') || labelText.includes('igg')) { newValue = hasValue ? value * 0.01 : undefined; newUnit = 'g/L (SI)'; } // mg/dL -> g/L
            }
            else if (is('g/dL')) {
                if (labelText.includes('albumin') || labelText.includes('protein') || labelText.includes('igg')) { newValue = hasValue ? value * 10 : undefined; newUnit = 'g/L (SI)'; }
                else if (labelText.includes('hgb') || labelText.includes('hemoglobin')) { newValue = hasValue ? value * 10 : undefined; newUnit = 'g/L (SI)'; }
            }
            else if (is('mEq/L')) {
                newValue = hasValue ? value : undefined; newUnit = 'mmol/L (SI)';
            }
            else if (is('U/L')) {
                newValue = hasValue ? value * 0.01667 : undefined; newUnit = 'µkat/L (SI)';
            }
            else if (is('µIU/mL')) {
                newValue = hasValue ? value * 6.945 : undefined; newUnit = 'pmol/L (SI)';
            }
            else if (is('mmHg')) {
                newValue = hasValue ? value * 0.1333 : undefined; newUnit = 'kPa (SI)';
            }
            else if (is('ng/mL')) { // PSA
                newValue = hasValue ? value : undefined; newUnit = 'µg/L (SI)';
            }
            else if (is('ng/dL')) { // Testosterone
                newValue = hasValue ? value * 0.0347 : undefined; newUnit = 'nmol/L (SI)';
            }
            else if (is('µg/L')) { // Copper
                if (labelText.includes('copper') || labelText.includes('bakır')) { newValue = hasValue ? value / 63.546 : undefined; newUnit = 'µmol/L (SI)'; }
            }
            else if (is('10³/µL')) { newValue = hasValue ? value : undefined; newUnit = '10⁹/L (SI)'; }
            else if (is('10⁶/µL')) { newValue = hasValue ? value : undefined; newUnit = '10¹²/L (SI)'; }
            else if (is('kg')) { newValue = hasValue ? value * 2.20462 : undefined; newUnit = 'lb'; }
            else if (is('cm')) { newValue = hasValue ? value / 100 : undefined; newUnit = 'm (SI)'; }
            else if (is('mL')) { newValue = hasValue ? value / 1000 : undefined; newUnit = 'L (SI)'; }
        } else {
            // ---> CONVERT BACK TO CONVENTIONAL <---
            if (is('µmol/L')) {
                if (labelText.includes('creatinine')) { newValue = hasValue ? value / 88.4 : undefined; newUnit = 'mg/dL'; }
                else if (labelText.includes('copper') || labelText.includes('bakır')) { newValue = hasValue ? value * 63.546 : undefined; newUnit = 'µg/L'; }
            }
            else if (is('mmol/L')) {
                if (labelText.includes('glucose')) { newValue = hasValue ? value / 0.0555 : undefined; newUnit = 'mg/dL'; }
                else if (labelText.includes('cholesterol') || labelText.includes('hdl') || labelText.includes('ldl')) { newValue = hasValue ? value / 0.0259 : undefined; newUnit = 'mg/dL'; }
                else if (labelText.includes('triglyceride')) { newValue = hasValue ? value / 0.0113 : undefined; newUnit = 'mg/dL'; }
                else if (labelText.includes('calcium')) { newValue = hasValue ? value / 0.25 : undefined; newUnit = 'mg/dL'; }
                else if (labelText.includes('bun')) { newValue = hasValue ? value / 0.357 : undefined; newUnit = 'mg/dL'; }
                else if (labelText.includes('magnesium') || labelText.includes('measured mg')) { newValue = hasValue ? value / 0.4114 : undefined; newUnit = 'mg/dL'; }
                else if (labelText.includes('phosphorus') || labelText.includes('fosfor')) { newValue = hasValue ? value / 0.3229 : undefined; newUnit = 'mg/dL'; }
                else { newValue = hasValue ? value : undefined; newUnit = 'mEq/L'; } 
            }
            else if (is('g/L')) {
                // Determine if target is g/dL or mg/dL
                if (labelText.includes('urine') || labelText.includes('spot') || labelText.includes('csf') || labelText.includes('bos') || labelText.includes('microalbumin') || labelText.includes('igg') && !labelText.includes('serum')) {
                    // Urine/CSF proteins usually mg/dL
                    newValue = hasValue ? value * 100 : undefined; newUnit = 'mg/dL';
                } else {
                    // Serum proteins/Hgb usually g/dL
                    newValue = hasValue ? value / 10 : undefined; newUnit = 'g/dL';
                }
            }
            else if (is('µkat/L')) { newValue = hasValue ? value / 0.01667 : undefined; newUnit = 'U/L'; }
            else if (is('pmol/L')) { newValue = hasValue ? value / 6.945 : undefined; newUnit = 'µIU/mL'; }
            else if (is('kPa')) { newValue = hasValue ? value / 0.1333 : undefined; newUnit = 'mmHg'; }
            else if (is('nmol/L')) { newValue = hasValue ? value / 0.0347 : undefined; newUnit = 'ng/dL'; }
            else if (is('µg/L')) { newValue = hasValue ? value : undefined; newUnit = 'ng/mL'; }
            else if (is('10⁹/L')) { newValue = hasValue ? value : undefined; newUnit = '10³/µL'; }
            else if (is('10¹²/L')) { newValue = hasValue ? value : undefined; newUnit = '10⁶/µL'; }
            else if (is('L')) { newValue = hasValue ? value * 1000 : undefined; newUnit = 'mL'; }
            else if (is('m')) { newValue = hasValue ? value * 100 : undefined; newUnit = 'cm'; }
            else if (is('lb')) { newValue = hasValue ? value / 2.20462 : undefined; newUnit = 'kg'; }
        }
        
        if (newUnit) {
            if (hasValue && newValue !== undefined) {
                input.value = Number.isInteger(newValue) ? newValue : newValue.toFixed(2).replace(/\.00$/, '');
            }
            
            const icon = badge.querySelector('i');
            badge.textContent = newUnit;
            if (icon) {
                badge.appendChild(icon);
            } else {
                const rotateIcon = document.createElement('i');
                rotateIcon.className = 'fa-solid fa-rotate';
                badge.appendChild(rotateIcon);
            }
            badge.onclick = function() { convertToSI(this); };
            badge.style.cursor = 'pointer';
            
            if (hasValue && newValue !== undefined) {
                input.dispatchEvent(new Event('input', { bubbles: true }));
            }
        }
    }

    function getNormalizedValue(id, stdUnit) {
        const input = document.getElementById(id);
        if(!input) return NaN;
        const val = parseFloat(input.value);
        if(isNaN(val)) return NaN;
        
        const badge = input.parentNode.querySelector('.unit-badge');
        if(!badge) return val;
        
        const badgeClone = badge.cloneNode(true);
        if(badgeClone.querySelector('i')) badgeClone.querySelector('i').remove();
        const cur = badgeClone.textContent.trim().replace(/\s*\(SI\)/g, '').trim();
        
        if(cur === stdUnit) return val;
        
        // Conversions to Standard Unit
        if(stdUnit==='mg/dL') {
            if(cur==='g/L') return val*100; 
            if(cur==='µmol/L') return val/88.4; // Creatinine
            if(cur==='mmol/L') {
                 if(id.includes('ca')) return val/0.25;
                 if(id.includes('p') || id.includes('phos')) return val/0.3229;
                 if(id.includes('bun')) return val/0.357;
                 if(id.includes('glu')) return val/0.0555;
                 if(id.includes('mg')) return val/0.4114;
                 if(id.includes('chol')||id.includes('hdl')||id.includes('ldl')) return val/0.0259;
                 if(id.includes('trig')) return val/0.0113;
            }
        }
        else if(stdUnit==='mEq/L') {
            if(cur==='mmol/L') return val;
        }
        else if(stdUnit==='U/L') {
            if(cur==='µkat/L') return val/0.01667;
        }
        else if(stdUnit==='µg/L') {
            if(cur==='µmol/L') return val*63.546;
        }
        else if(stdUnit==='mL') {
            if(cur==='L') return val*1000;
        }
        else if(stdUnit==='g/dL') {
            if(cur==='g/L') return val/10;
        }
        
        return val;
    }

    function calculateSpotUrine() { 
        const creaVal = getNormalizedValue('spot-crea', 'mg/dL');
        if(!creaVal) return; 
        
        const inputStd = {
            'spot-prot':'mg/dL', 'spot-alb':'mg/dL', 'spot-ca':'mg/dL', 
            'spot-na':'mEq/L', 'spot-k':'mEq/L', 'spot-cl':'mEq/L',
            'spot-p':'mg/dL', 'spot-bun':'mg/dL', 'spot-amy':'U/L', 'spot-cu':'µg/L'
        };

        const map = {
            'spot-prot': 1000, 'spot-alb': 1000, 'spot-ca': 1000, 
            'spot-na': 100, 'spot-k': 100, 'spot-cl': 100,
            'spot-p': 1000, 'spot-bun': 1000, 'spot-amy': 100, 'spot-cu': 100
        };
        const units = {
            'spot-prot':'mg/g Cr', 'spot-alb':'mg/g Cr', 'spot-ca':'mg/g Cr', 
            'spot-na':'mEq/g Cr', 'spot-k':'mEq/g Cr', 'spot-cl':'mEq/g Cr',
            'spot-p':'mg/g Cr', 'spot-bun':'mg/g Cr', 'spot-amy':'U/g Cr', 'spot-cu':'µg/g Cr'
        };
        
        for(const[id,f]of Object.entries(map)){
            const v = getNormalizedValue(id, inputStd[id]);
            const resEl = document.getElementById('res-'+id) || (function(){
                const d=document.createElement('div'); d.id='res-'+id; d.className='mini-result'; 
                const inp=document.getElementById(id); if(inp) inp.parentNode.appendChild(d); return d;
            })();
            if(!isNaN(v)){ 
                const val=((v/creaVal)*f); 
                const unit = units[id];
                let extra = '';
                if(unit.includes('mg/g Cr')) { 
                    extra = ` <span style="color:var(--text-light)">(${(val/1000).toFixed(2)} g/g Cr)</span>`;
                } else if(unit.includes('mEq/g Cr')) {
                    extra = ` <span style="color:var(--text-light)">(${val.toFixed(2)} mmol/g Cr)</span>`;
                } else if(unit.includes('U/g Cr')) {
                    const v2 = val * 0.01667;
                    extra = ` <span style="color:var(--text-light)">(${v2.toFixed(2)} µkat/g Cr)</span>`;
                } else if(unit.includes('µg/g Cr')) {
                    const v2 = val / 63.546;
                    extra = ` <span style="color:var(--text-light)">(${v2.toFixed(3)} µmol/g Cr)</span>`;
                }
                resEl.innerHTML=`${val.toFixed(2)} ${unit}${extra}`; 
            }
        } 
    }

    function calculateUrineMulti() { 
        const vol = getNormalizedValue('uVol', 'mL');
        if(!vol) return; 
        
        const list = [
            {id:'uProt', f:0.01, u:'mg/day', std:'mg/dL'}, {id:'uAlb', f:0.01, u:'mg/day', std:'mg/dL'},
            {id:'uCrea', f:0.01, u:'mg/day', std:'mg/dL'}, {id:'uCa', f:0.01, u:'mg/day', std:'mg/dL'},
            {id:'uP', f:0.01, u:'mg/day', std:'mg/dL'}, {id:'uBun', f:0.01, u:'mg/day', std:'mg/dL'},
            {id:'uCl', f:0.001, u:'mEq/day', std:'mEq/L'}, {id:'uK', f:0.001, u:'mEq/day', std:'mEq/L'},
            {id:'uAmy', f:0.001, u:'U/day', std:'U/L'}, {id:'uCu', f:0.001, u:'µg/day', std:'µg/L'}
        ];
        
        list.forEach(item=>{
            const v = getNormalizedValue(item.id, item.std);
            if(!isNaN(v)){
                const resEl = document.getElementById('res-'+item.id) || (function(){
                    const d=document.createElement('div'); d.id='res-'+item.id; d.className='mini-result'; 
                    const inp=document.getElementById(item.id); if(inp) inp.parentNode.appendChild(d); return d;
                })();
                const resVal = v*vol*item.f;
                // Dual unit display logic
                let extra = '';
                if(item.u === 'mg/day') {
                    extra = ` <span style="color:var(--text-light)">(${(resVal/1000).toFixed(2)} g/day)</span>`;
                } else if(item.u === 'mEq/day') {
                    extra = ` <span style="color:var(--text-light)">(${resVal.toFixed(2)} mmol/day)</span>`;
                } else if(item.u === 'U/day') {
                    const v2 = resVal * 0.01667;
                    extra = ` <span style="color:var(--text-light)">(${v2.toFixed(2)} µkat/day)</span>`;
                } else if(item.u === 'µg/day') {
                    const v2 = resVal / 63.546;
                    extra = ` <span style="color:var(--text-light)">(${v2.toFixed(3)} µmol/day)</span>`;
                }
                resEl.innerHTML=`${resVal.toFixed(2)} ${item.u}${extra}`;
            }
        }); 
    }

    function selectFactor(f) {
    document.getElementById('selected-factor').value = f;
    document.getElementById('custom-x-wrapper').style.display = 'none';
    document.getElementById('proj-steps').value = 5;
    planSerialDilution();
}

function enableCustomX() {
    document.getElementById('selected-factor').value = 'custom';
    document.getElementById('custom-x-wrapper').style.display = 'block';
    planSerialDilution();
}

function planSerialDilution() {
    const stockC = parseFloat(document.getElementById('plan-stock-c').value) || 0;
    const targetC = parseFloat(document.getElementById('plan-target-c').value) || 0;
    // Eğer boşsa 100 kullan, girilirse girileni kullan
    const transferV = parseFloat(document.getElementById('plan-transfer-v').value) || 100;
    const factorInput = document.getElementById('selected-factor').value;
    const resBox = document.getElementById('res-plan-final');
    
    let factorX = factorInput === 'custom' 
        ? parseFloat(document.getElementById('plan-custom-x').value) 
        : parseFloat(factorInput);

    // 1. Butonların üzerindeki adım sayılarını güncelle (Hedef varsa)
    updateFactorButtons(stockC, targetC);

    if (stockC > 0 && factorX > 1) {
        let steps;
        let isProjection = false;

        // Mod Belirleme: Target varsa hedefe göre, yoksa manuel projeksiyon
        if (targetC > 0 && stockC > targetC) {
            steps = Math.ceil(Math.log(stockC / targetC) / Math.log(factorX));
            document.getElementById('factor-label').innerText = `Targeting Strategy (1:${factorX})`;
        } else {
            steps = parseInt(document.getElementById('proj-steps').value);
            isProjection = true;
            document.getElementById('factor-label').innerText = "Manual Factor / Projection Mode";
        }

        const diluentV = transferV * (factorX - 1);
        resBox.style.display = 'block';

        let html = `
            <div style="background: rgba(var(--primary-rgb), 0.05); padding: 15px; border-radius: 10px; border-left: 5px solid var(--primary);">
                <div style="margin-bottom: 15px; font-size: 0.85rem; background: #fff; padding: 12px; border-radius: 8px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; gap: 5px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Step Dilution: <strong>1:${factorX}</strong></span>
                        <span>Diluent Vol: <strong style="color: var(--primary);">${diluentV.toFixed(1)} µL</strong></span>
                    </div>
                    <div style="font-style: italic; font-size: 0.75rem; color: #64748b; border-top: 1px solid #f1f5f9; padding-top: 8px; margin-top: 5px;">
                        Instructions: Each tube should already contain ${diluentV.toFixed(1)} µL of diluent.
                    </div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
        `;

        for (let i = 1; i <= steps; i++) {
            const currentC = stockC / Math.pow(factorX, i);
            html += `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: #fff; border: 1px solid #cbd5e1; border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="background: var(--primary); color: #fff; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold;">${i}</span>
                        <div>
                            <div style="font-size: 0.85rem; font-weight: 700;">Tube ${i}</div>
                            <div style="font-size: 0.8rem; color: var(--primary); font-family: monospace;">${currentC < 0.001 ? currentC.toExponential(2) : currentC.toFixed(4)}</div>
                        </div>
                    </div>
                    <div style="text-align: right; font-size: 0.7rem; color: #64748b;">
                        Transfer ${transferV}µL <br> from ${i === 1 ? 'Stock' : 'Tube ' + (i-1)}
                    </div>
                </div>
            `;
        }

        if (isProjection) {
            html += `<button onclick="document.getElementById('proj-steps').value = ${steps + 5}; planSerialDilution();" style="width:100%; margin-top:10px; background:none; border:1px dashed var(--primary); color:var(--primary); padding:10px; border-radius:8px; cursor:pointer; font-size:0.75rem;">+ Add 5 More Tubes</button>`;
        }

        html += `</div></div>`;
        resBox.innerHTML = html;
    } else {
        resBox.style.display = 'none';
    }
}

function updateFactorButtons(stockC, targetC) {
    const factorInput = document.getElementById('selected-factor').value;
    
    document.querySelectorAll('.factor-btn').forEach(btn => {
        btn.classList.remove('active');
        const factorText = btn.innerText.split('\n')[0]; // Sadece "1:10" kısmını al
        const factorVal = parseInt(factorText.split(':')[1]);

        // Aktif butonu işaretle
        if (factorText === `1:${factorInput}` || (factorInput === 'custom' && factorText === '1:X')) {
            btn.classList.add('active');
        }

        // Eğer hedef varsa butonun altına kaç tüp gerektiğini yaz
        if (stockC > 0 && targetC > 0 && stockC > targetC && !isNaN(factorVal)) {
            const steps = Math.ceil(Math.log(stockC / targetC) / Math.log(factorVal));
            btn.innerHTML = `${factorText}<br><span class="step-count-badge">${steps} steps</span>`;
        } else if (!isNaN(factorVal)) {
            btn.innerHTML = factorText;
        }
    });
}

    function calculateIgGIndex() {
    const igg_csf = getNormalizedValue('igg-csf', 'mg/dL');
    const alb_serum = getNormalizedValue('alb-serum', 'g/dL');
    const igg_serum = getNormalizedValue('igg-serum', 'mg/dL');
    const alb_csf = getNormalizedValue('alb-csf', 'mg/dL');
    const resBox = document.getElementById('res-igg-index-final');

    if (igg_csf && alb_serum && igg_serum && alb_csf) {
        const alb_serum_mg = alb_serum * 1000;
        const res = (igg_csf * alb_serum_mg) / (igg_serum * alb_csf);
        
        let interpretation = "";
        let color = "#1e293b";

        // Klinik Yorumlama
        if (res > 0.7) {
            interpretation = "Elevated IgG Index (>0.7): Suggests intrathecal IgG synthesis (e.g., Multiple Sclerosis, Neurosyphilis).";
            color = "#dc2626"; // Kırmızı (Anormal)
        } else if (res >= 0.3 && res <= 0.7) {
            interpretation = "IgG Index is within the normal physiological range (0.3–0.7).";
            color = "#16a34a"; // Yeşil (Normal)
        } else {
            interpretation = "Low IgG Index: Less common; usually indicates blood-brain barrier compromise or technical variation.";
            color = "#d97706"; // Turuncu
        }

        resBox.style.display = 'block';
        resBox.innerHTML = `
            <div style="background: rgba(var(--primary-rgb), 0.05); border-left: 4px solid ${color}; padding: 12px; border-radius: 8px; margin-top: 10px;">
                <div style="font-size: 1.15rem; font-weight: bold; color: ${color};">IgG Index: ${res.toFixed(2)}</div>
                <div style="font-size: 0.85rem; margin-top: 4px; color: #334155; font-weight: 600;">${interpretation}</div>
                
                <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1); font-size: 0.75rem; color: #64748b; line-height:1.4;">
                    <strong>Calculation Method:</strong><br>
                    Index = [IgG (CSF) / IgG (Serum)] / [Albumin (CSF) / Albumin (Serum)]<br>
                    <span style="font-style: italic;">*Clinical Note: An elevated index indicates that IgG is being produced within the CNS rather than leaking from the blood. It is positive in ~90% of MS patients.</span>
                </div>
            </div>
        `;
    } else {
        resBox.innerHTML = '';
        resBox.style.display = 'none';
    }
}

function setDilution(ratio) {
    document.getElementById('dil-custom-ratio').value = ratio;
    calculateDilution();
}

function calculateDilution() {
    const rawValStr = document.getElementById('dil-raw-value').value;
    const rawVal = parseFloat(rawValStr);
    const ratioX = parseFloat(document.getElementById('dil-custom-ratio').value);
    const minSample = parseFloat(document.getElementById('dil-min-sample').value) || 0;
    const resBox = document.getElementById('res-dilution-final');

    if (ratioX && ratioX > 1) {
        let sampleVol = 1000 / ratioX;
        let totalVol = 1000;

        if (sampleVol < minSample) {
            sampleVol = minSample;
            totalVol = sampleVol * ratioX;
        }

        const diluentVol = totalVol - sampleVol;
        const color = "var(--primary)";

        resBox.style.display = 'block';
        
        // Cihaz sonucu girilmiş mi kontrolü
        const hasResult = rawValStr !== "" && !isNaN(rawVal);
        const finalResult = hasResult ? (rawVal * ratioX) : null;

        resBox.innerHTML = `
            <div style="background: rgba(var(--primary-rgb), 0.05); border-left: 5px solid ${color}; padding: 15px; border-radius: 10px;">
                <div style="margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid rgba(0,0,0,0.1);">
                    <div style="font-size: 0.8rem; color: var(--text-light); font-weight: 800; text-transform: uppercase;">Preparation Recipe (1:${ratioX})</div>
                    <div style="font-size: 1.1rem; color: var(--text-main); margin-top: 8px;">
                        <span style="display:inline-block; width: 110px;">💧 Sample:</span> <strong style="color:#2563eb;">${sampleVol.toFixed(1)} µL</strong><br>
                        <span style="display:inline-block; width: 110px;">🧪 Diluent:</span> <strong style="color:var(--text-light);">${diluentVol.toFixed(1)} µL</strong>
                        <div style="font-size: 0.7rem; color: #94a3b8; margin-top: 5px;">(Total Mix: ${totalVol.toFixed(0)} µL)</div>
                    </div>
                </div>

                ${hasResult ? `
                    <div style="text-align: center; padding: 10px 0;">
                        <div style="font-size: 0.75rem; color: var(--text-light); font-weight: bold; text-transform: uppercase;">Corrected Final Result</div>
                        <div style="font-size: 2.2rem; font-weight: 900; color: ${color}; letter-spacing: -1px;">
                            ${finalResult.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 4})}
                        </div>
                    </div>
                ` : `
                    <div style="background: #ffffff; padding: 12px; border-radius: 8px; border: 2px dashed #dc2626; font-size: 0.95rem; color: var(--text-main); text-align: center;">
                        <i class="fas fa-exclamation-triangle" style="color: #dc2626; margin-right: 5px;"></i>
                        Once measured, multiply the reading by <br>
                        <span style="font-size: 1.4rem; color: #dc2626; font-weight: 900;">${ratioX}</span>
                    </div>
                `}
            </div>
        `;
    } else {
        resBox.style.display = 'none';
    }
}


function calculateLDL() {
    const t = getNormalizedValue('ldl-tot', 'mg/dL');
    const h = getNormalizedValue('ldl-hdl', 'mg/dL');
    const tr = getNormalizedValue('ldl-trig', 'mg/dL');
    const el = document.getElementById('res-ldl-final');

    if (!isNaN(t) && !isNaN(h) && !isNaN(tr) && t > 0 && h > 0 && tr >= 0) {
        // Friedewald Formula: LDL = TC - HDL - (TG/5)
        const l = t - h - (tr / 5);
        const lmmol = l * 0.0259;
        const ratio = tr / h;

        let interpretation = "";
        let color = "#1e293b";

        // Klinik Yorumlama (Genel popülasyon hedefleri)
        if (tr > 400) {
            interpretation = "Friedewald formula is inaccurate when Triglycerides > 400 mg/dL. Direct LDL measurement is recommended.";
            color = "#d97706"; // Turuncu (Uyarı)
        } else if (l >= 190) {
            interpretation = "Very High LDL: Significant cardiovascular risk.";
            color = "#dc2626"; // Kırmızı
        } else if (l >= 130 && l < 190) {
            interpretation = "Borderline/High LDL: Lifestyle or medical intervention may be needed.";
            color = "#d97706";
        } else {
            interpretation = "LDL is within the optimal or near-optimal range for the general population.";
            color = "#16a34a"; // Yeşil
        }

        el.style.display = 'block';
        el.innerHTML = `
            <div style="background: rgba(var(--primary-rgb), 0.05); border-left: 4px solid ${color}; padding: 12px; border-radius: 8px; margin-top: 10px;">
                <div style="font-size: 1.1rem; font-weight: bold; color: ${color};">LDL: ${l.toFixed(0)} mg/dL (${lmmol.toFixed(2)} mmol/L)</div>
                <div style="font-size: 0.85rem; margin-top: 4px; color: #334155; font-weight: 600;">TG/HDL Ratio: ${ratio.toFixed(2)}</div>
                <div style="font-size: 0.8rem; margin-top: 4px; color: #475569;">${interpretation}</div>
                
                <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1); font-size: 0.75rem; color: #64748b; line-height:1.4;">
                    <strong>Calculation Method:</strong><br>
                    LDL = Total Cholesterol - HDL - (Triglycerides / 5)<br>
                    <span style="font-style: italic;">*Clinical Note: The TG/HDL ratio is a strong predictor of insulin resistance and cardiovascular risk (Optimal: <2.0).</span>
                </div>
            </div>
        `;
    } else {
        el.innerHTML = '';
        el.style.display = 'none';
    }
}

function calculateHoma() {
    const g = parseFloat(document.getElementById('homa-glu').value),
          i = parseFloat(document.getElementById('homa-ins').value);
    const resBox = document.getElementById('res-homa-final');

    if (g && i) {
        // Standart HOMA-IR Formülü (Glucose mg/dL bazında)
        const v = ((g * i) / 405);
        
        let interpretation = "";
        let color = "#1e293b";

        // Klinik Yorumlama
        if (v > 2.5) {
            interpretation = "High HOMA-IR (>2.5): Significant insulin resistance. Increased risk for Type 2 Diabetes and Metabolic Syndrome.";
            color = "#dc2626"; // Kırmızı
        } else if (v >= 1.9 && v <= 2.5) {
            interpretation = "Borderline: Early signs of insulin resistance. Lifestyle modifications recommended.";
            color = "#d97706"; // Turuncu
        } else {
            interpretation = "Normal: Optimal insulin sensitivity.";
            color = "#16a34a"; // Yeşil
        }

        resBox.style.display = 'block';
        resBox.innerHTML = `
            <div style="background: rgba(var(--primary-rgb), 0.05); border-left: 4px solid ${color}; padding: 12px; border-radius: 8px; margin-top: 10px;">
                <div style="font-size: 1.15rem; font-weight: bold; color: ${color};">HOMA-IR: ${v.toFixed(2)}</div>
                <div style="font-size: 0.85rem; margin-top: 4px; color: #334155; font-weight: 600;">${interpretation}</div>
                
                <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1); font-size: 0.75rem; color: #64748b; line-height:1.4;">
                    <strong>Calculation Method:</strong><br>
                    HOMA-IR = [Glucose (mg/dL) × Insulin (µIU/mL)] / 405<br>
                    <span style="font-style: italic;">*Clinical Note: For the most accurate result, the blood sample must be taken after at least 8 hours of fasting.</span>
                </div>
            </div>
        `;
    } else {
        resBox.innerHTML = '';
        resBox.style.display = 'none';
    }
}
function setSchwartzK(k,b){ schwartzK=k; document.querySelectorAll('#calc-schwartz .radio-option').forEach(x=>x.classList.remove('selected')); b.classList.add('selected'); calculateSchwartz(); }
    function calculateSchwartz(){ const h=parseFloat(document.getElementById('sch-height').value), c=parseFloat(document.getElementById('sch-crea').value); const el=document.getElementById('res-schwartz-final'); if(h&&c){ const gfr=((schwartzK*h)/c); el.innerHTML=`eGFR (Schwartz): ${gfr.toFixed(1)} mL/min/1.73m²`; } else { el.innerHTML=''; } }

function calculateFIB4() {
    const a = parseFloat(document.getElementById('fib-age').value),
          ast = parseFloat(document.getElementById('fib-ast').value),
          alt = parseFloat(document.getElementById('fib-alt').value),
          p = parseFloat(document.getElementById('fib-plt').value);
    const resBox = document.getElementById('res-fib4-final');

    if (a && ast && alt && p && alt > 0) {
        // FIB-4 Formula: (Age * AST) / (Platelet * sqrt(ALT))
        const res = (a * ast) / (p * Math.sqrt(alt));
        
        let interpretation = "";
        let color = "#1e293b";

        // Klinik Yorumlama (NAFLD/MASLD için standart eşikler)
        if (res < 1.30) {
            interpretation = "Low Risk: High negative predictive value for advanced fibrosis.";
            color = "#16a34a"; // Yeşil
        } else if (res >= 1.30 && res <= 2.67) {
            interpretation = "Indeterminate Risk: Intermediate zone. Consider additional testing (e.g., FibroScan).";
            color = "#d97706"; // Turuncu
        } else {
            interpretation = "High Risk: Significant risk of advanced fibrosis or cirrhosis.";
            color = "#dc2626"; // Kırmızı
        }

        resBox.style.display = 'block';
        resBox.innerHTML = `
            <div style="background: rgba(var(--primary-rgb), 0.05); border-left: 4px solid ${color}; padding: 12px; border-radius: 8px; margin-top: 10px;">
                <div style="font-size: 1.15rem; font-weight: bold; color: ${color};">FIB-4 Score: ${res.toFixed(2)}</div>
                <div style="font-size: 0.85rem; margin-top: 4px; color: #334155; font-weight: 600;">${interpretation}</div>
                
                <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1); font-size: 0.75rem; color: #64748b; line-height:1.4;">
                    <strong>Calculation Method:</strong><br>
                    FIB-4 = (Age [years] × AST [U/L]) / (Platelet Count [10<sup>9</sup>/L] × √ALT [U/L])<br>
                    <span style="font-style: italic;">*Clinical Note: In patients over age 65, the low-risk cutoff is often adjusted to 2.0 instead of 1.3.</span>
                </div>
            </div>
        `;
    } else {
        resBox.innerHTML = '';
        resBox.style.display = 'none';
    }
}
    function calculateCorrNa() {
    const nEl = document.getElementById('na-meas'), gEl = document.getElementById('na-glu');
    const n = parseFloat(nEl.value), g = parseFloat(gEl.value);
    const resBox = document.getElementById('res-na-final');

    if (n && g) {
        const gUnit = gEl.parentNode.querySelector('.unit-badge').textContent.trim();
        const isMmol = gUnit.includes('mmol/L');
        
        // Eşik değer kontrolü (400 mg/dL veya 22.2 mmol/L)
        const threshold = isMmol ? 22.2 : 400;
        const baseline = isMmol ? 5.6 : 100;
        
        // Katsayı: 400 mg/dL altı için 1.6, üstü için 2.4
        const coefficient = g > threshold ? 2.4 : 1.6;
        
        // Formül uygulaması
        const corr = n + coefficient * ((g - baseline) / (isMmol ? 5.6 : 100));
        
        let interpretation = "";
        let color = "#1e293b";

        if (corr < 135) {
            interpretation = "True hyponatremia is present despite glucose correction.";
            color = "#dc2626";
        } else if (corr >= 135 && corr <= 145) {
            interpretation = "Sodium is within normal limits after correction (Pseudohyponatremia).";
            color = "#16a34a";
        } else {
            interpretation = "Corrected sodium is high, indicating significant water deficit.";
            color = "#d97706";
        }

        resBox.style.display = 'block';
        resBox.innerHTML = `
            <div style="background: rgba(var(--primary-rgb), 0.05); border-left: 4px solid ${color}; padding: 12px; border-radius: 8px; margin-top: 10px;">
                <div style="font-size: 1.15rem; font-weight: bold; color: ${color};">Corrected Na: ${corr.toFixed(1)} mEq/L</div>
                <div style="font-size: 0.85rem; margin-top: 4px; color: #334155; font-weight: 600;">${interpretation}</div>
                
                <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1); font-size: 0.75rem; color: #64748b; line-height:1.4;">
                    <strong>Calculation Method:</strong><br>
                    Formula: Na + ${coefficient} × [(Glucose - ${baseline}) / ${baseline}]<br>
                    <span style="font-style: italic;">A correction factor of 1.6 is applied for glucose levels up to 400 mg/dL (22.2 mmol/L), while a higher coefficient of 2.4 is used for values exceeding this threshold to ensure greater accuracy.</span>
                </div>
            </div>
        `;
    } else {
        resBox.innerHTML = '';
        resBox.style.display = 'none';
    }
}
function calculateCa() {
    const cEl = document.getElementById('ca-tot'), aEl = document.getElementById('ca-alb');
    const c = parseFloat(cEl.value), a = parseFloat(aEl.value);
    const resBox = document.getElementById('res-ca-final');

    if (c && a) {
        const cUnit = cEl.parentNode.querySelector('.unit-badge').textContent.trim();
        const aUnit = aEl.parentNode.querySelector('.unit-badge').textContent.trim();
        
        // Birim çevrimleri
        const cMg = cUnit.includes('mmol/L') ? c * 4 : c;
        const aGdL = aUnit.includes('g/L') ? a / 10 : a;
        
        // Formül: Total Ca + 0.8 * (4.0 - Albumin)
        const corrMgdl = cMg + 0.8 * (4.0 - aGdL);
        const corrMmol = corrMgdl * 0.25;

        let interpretation = "";
        let color = "#1e293b";

        // Klinik Yorumlama
        if (corrMgdl < 8.5) {
            interpretation = "Corrected Calcium is low (Hypocalcemia). Check Vitamin D and Magnesium levels.";
            color = "#dc2626"; // Kırmızı
        } else if (corrMgdl >= 8.5 && corrMgdl <= 10.5) {
            interpretation = "Corrected Calcium is within the normal range.";
            color = "#16a34a"; // Yeşil
        } else {
            interpretation = "Corrected Calcium is high (Hypercalcemia). Consider PTH and malignancy screening.";
            color = "#d97706"; // Turuncu
        }

        resBox.style.display = 'block';
        resBox.innerHTML = `
            <div style="background: rgba(var(--primary-rgb), 0.05); border-left: 4px solid ${color}; padding: 12px; border-radius: 8px; margin-top: 10px;">
                <div style="font-size: 1.1rem; font-weight: bold; color: ${color};">Corrected Ca: ${corrMgdl.toFixed(2)} mg/dL (${corrMmol.toFixed(2)} mmol/L)</div>
                <div style="font-size: 0.85rem; margin-top: 4px; color: #334155; font-weight: 600;">${interpretation}</div>
                
                <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1); font-size: 0.75rem; color: #64748b; line-height:1.4;">
                    <strong>Calculation Method (Payne's Formula):</strong><br>
                    Corrected Ca = Total Ca + [0.8 × (4.0 - Albumin)]<br>
                    <span style="font-style: italic;">*In hypoalbuminemia, total calcium measurements may be falsely low because about 40-45% of serum calcium is bound to albumin.</span>
                </div>
            </div>
        `;
    } else {
        resBox.innerHTML = '';
        resBox.style.display = 'none';
    }
}
function calculateCorrMg() {
    const mEl = document.getElementById('mg-meas'), aEl = document.getElementById('mg-alb');
    const m = parseFloat(mEl.value), a = parseFloat(aEl.value);
    const resBox = document.getElementById('res-mg-final');

    if (m && a) {
        const mUnit = mEl.parentNode.querySelector('.unit-badge').textContent.trim();
        const aUnit = aEl.parentNode.querySelector('.unit-badge').textContent.trim();
        
        // Birim çevrimleri
        const mMgdl = mUnit.includes('mmol/L') ? m / 0.4114 : m;
        const aGdL = aUnit.includes('g/L') ? a / 10 : a;
        
        // Formül: Measured Mg + 0.05 * (4.0 - Albumin)
        const corrMgdl = mMgdl + 0.05 * (4.0 - aGdL);
        const corrMmol = corrMgdl * 0.4114;

        let interpretation = "";
        let color = "#1e293b";

        // Klinik Yorumlama
        if (corrMgdl < 1.7) {
            interpretation = "Corrected Magnesium is low (Hypomagnesemia). Often associated with hypocalcemia and hypokalemia.";
            color = "#dc2626"; // Kırmızı
        } else if (corrMgdl >= 1.7 && corrMgdl <= 2.3) {
            interpretation = "Corrected Magnesium is within the normal range.";
            color = "#16a34a"; // Yeşil
        } else {
            interpretation = "Corrected Magnesium is high (Hypermagnesemia). Monitor for neurological and cardiac symptoms.";
            color = "#d97706"; // Turuncu
        }

        resBox.style.display = 'block';
        resBox.innerHTML = `
            <div style="background: rgba(var(--primary-rgb), 0.05); border-left: 4px solid ${color}; padding: 12px; border-radius: 8px; margin-top: 10px;">
                <div style="font-size: 1.1rem; font-weight: bold; color: ${color};">Corrected Mg: ${corrMgdl.toFixed(2)} mg/dL (${corrMmol.toFixed(3)} mmol/L)</div>
                <div style="font-size: 0.85rem; margin-top: 4px; color: #334155; font-weight: 600;">${interpretation}</div>
                
                <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1); font-size: 0.75rem; color: #64748b; line-height:1.4;">
                    <strong>Calculation Method:</strong><br>
                    Corrected Mg = Measured Mg + [0.05 × (4.0 - Albumin)]<br>
                    <span style="font-style: italic;">*Similar to calcium, serum magnesium is bound to albumin; hypoalbuminemia can lead to falsely low total magnesium measurements.</span>
                </div>
            </div>
        `;
    } else {
        resBox.innerHTML = '';
        resBox.style.display = 'none';
    }
}
function calculateAnionGap(){ 
    const n = parseFloat(document.getElementById('ag-na').value), 
          c = parseFloat(document.getElementById('ag-cl').value), 
          h = parseFloat(document.getElementById('ag-hCO3') ? document.getElementById('ag-hCO3').value : document.getElementById('ag-hco3').value), 
          a = parseFloat(document.getElementById('ag-alb').value || '4.0'); 
    const resBox = document.getElementById('res-ag-final');

    if(n && c && h){ 
        const ag = (n - (c + h)); 
        const corrAg = ag + 2.5 * (4.0 - a); 
        
        let interpretation = "";
        let color = "#1e293b";

        // Klinik Yorumlama (Düzeltilmiş AG üzerinden)
        if (corrAg > 12) {
            interpretation = "High Anion Gap Metabolic Acidosis (HAGMA): Consider GOLD MARK causes (Glycols, Oxoproline, L-lactate, D-lactate, Methanol, Aspirin, Renal failure, Ketoacidosis).";
            color = "#dc2626"; // Kırmızı
        } else if (corrAg >= 8 && corrAg <= 12) {
            interpretation = "Anion Gap is within the normal range (8–12 mEq/L).";
            color = "#16a34a"; // Yeşil
        } else {
            interpretation = "Low Anion Gap: Consider hypoalbuminemia, multiple myeloma, or lithium toxicity.";
            color = "#d97706"; // Turuncu
        }

        resBox.style.display = 'block';
        resBox.innerHTML = `
            <div style="background: rgba(var(--primary-rgb), 0.05); border-left: 4px solid ${color}; padding: 12px; border-radius: 8px; margin-top: 10px;">
                <div style="font-size: 1.1rem; font-weight: bold; color: ${color};">AG: ${ag.toFixed(1)} | Corrected AG: ${corrAg.toFixed(1)} mEq/L</div>
                <div style="font-size: 0.85rem; margin-top: 4px; color: #334155; font-weight: 600;">${interpretation}</div>
                
                <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1); font-size: 0.75rem; color: #64748b; line-height:1.4;">
                    <strong>Calculation Method:</strong><br>
                    1. Observed AG = Na - (Cl + HCO₃)<br>
                    2. Corrected AG = Observed AG + [2.5 × (4.0 - Albumin)]<br>
                    <span style="font-style: italic;">*Albumin correction is critical because albumin is the primary unmeasured anion; for every 1 g/dL drop in albumin, the "normal" AG drops by approximately 2.5 mEq/L.</span>
                </div>
            </div>
        `;
    } else { 
        resBox.innerHTML = ''; 
        resBox.style.display = 'none';
    } 
}
function calculateOsmo() {
    const nEl = document.getElementById('osmo-na'),
          gEl = document.getElementById('osmo-glu'),
          bEl = document.getElementById('osmo-bun');
    const n = parseFloat(nEl.value),
          g = parseFloat(gEl.value),
          b = parseFloat(bEl.value);
    const resBox = document.getElementById('res-osmo-final');

    if (n && g && b) {
        const gUnit = gEl.parentNode.querySelector('.unit-badge').textContent.trim();
        const bUnit = bEl.parentNode.querySelector('.unit-badge').textContent.trim();
        
        // Osmolality Formülü
        const osmo = (2 * n) + (gUnit.includes('mmol/L') ? g : g / 18) + (bUnit.includes('mmol/L') ? b : b / 2.8);
        
        let interpretation = "";
        let color = "#1e293b";

        // Klinik Yorumlama
        if (osmo < 275) {
            interpretation = "Hypo-osmolality: Often associated with hyponatremia and water excess.";
            color = "#dc2626"; // Kırmızı
        } else if (osmo >= 275 && osmo <= 295) {
            interpretation = "Serum Osmolality is within the normal physiological range.";
            color = "#16a34a"; // Yeşil
        } else {
            interpretation = "Hyper-osmolality: Consider dehydration, hyperglycemia, or presence of unmeasured osmolytes.";
            color = "#d97706"; // Turuncu
        }

        resBox.style.display = 'block';
        resBox.innerHTML = `
            <div style="background: rgba(var(--primary-rgb), 0.05); border-left: 4px solid ${color}; padding: 12px; border-radius: 8px; margin-top: 10px;">
                <div style="font-size: 1.1rem; font-weight: bold; color: ${color};">Calculated Osmolality: ${osmo.toFixed(0)} mOsm/kg</div>
                <div style="font-size: 0.85rem; margin-top: 4px; color: #334155; font-weight: 600;">${interpretation}</div>
                
                <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1); font-size: 0.75rem; color: #64748b; line-height:1.4;">
                    <strong>Calculation Method:</strong><br>
                    2×Na + [Glucose / ${gUnit.includes('mmol/L') ? '1' : '18'}] + [BUN / ${bUnit.includes('mmol/L') ? '1' : '2.8'}]<br>
                    <span style="font-style: italic;">*Clinical Note: If the measured osmolality (from lab) is >10 mOsm/kg higher than this calculated value, an "Osmolar Gap" exists, suggesting toxic alcohol ingestion (e.g., methanol, ethylene glycol).</span>
                </div>
            </div>
        `;
    } else {
        resBox.innerHTML = '';
        resBox.style.display = 'none';
    }
}

function calculateFENa() {
    const sna = getNormalizedValue('fena-sna', 'mEq/L');
    const screa = getNormalizedValue('fena-screa', 'mg/dL');
    const una = getNormalizedValue('fena-una', 'mEq/L');
    const ucrea = getNormalizedValue('fena-ucrea', 'mg/dL');
    const res = document.getElementById('res-fena-final');

    if (!isNaN(sna) && !isNaN(screa) && !isNaN(una) && !isNaN(ucrea) && sna > 0 && screa > 0 && ucrea > 0) {
        const f = ((una * screa) / (sna * ucrea)) * 100;
        
        let interpretation = '';
        let color = '';
        let bgColor = '';

        // Karar Mekanizması
        if (f < 1) {
            interpretation = "<strong>Prerenal Azotemia</strong><br><small>Please correlate with urine volume (↓), BUN/Creatinine ratio (>20:1), urine osmolality (>500 mOsm/kg), urine sodium (<20 mEq/L) and urine sediment (granular casts, hyaline casts) for a definitive diagnosis of prerenal etiology.</small>";
            color = "#2563eb"; // Mavi
            bgColor = "rgba(37, 99, 235, 0.1)";
        } else if (f >= 1 && f <= 2) {
            interpretation = "<strong>Intermediate Zone</strong><br><small>Please correlate with clinical status.</small>";
            color = "#d97706"; // Turuncu
            bgColor = "rgba(217, 119, 6, 0.1)";
        } else {
            interpretation = "<strong>Intrinsic Renal Failure (ATN)</strong><br><small>Please correlate with urine volume (usually ↓), BUN/Creatinine ratio (~10:1), urine osmolality (~300 mOsm/kg), urine sodium (>40 mEq/L) and urine sediment (brown casts, renal tubular cell casts) for a definitive diagnosis of intrinsic renal etiology.</small>";
            color = "#dc2626"; // Kırmızı
            bgColor = "rgba(220, 38, 38, 0.1)";
        }

        // Sonucu ve Notu Ekrana Basma
        res.innerHTML = `
            <div style="background: ${bgColor}; border-left: 4px solid ${color}; padding: 12px; border-radius: 6px; margin-top: 10px;">
                <div style="font-size: 1.2rem; font-weight: bold; color: ${color};">FENa: ${f.toFixed(2)}%</div>
                <div style="margin-top: 5px; color: #333;">${interpretation}</div>
            </div>
        `;
    } else {
        res.innerHTML = '';
    }
}    

function calculateLightsCriteria() {
    const pProt = parseFloat(document.getElementById('light-p-protein').value),
          sProt = parseFloat(document.getElementById('light-s-protein').value),
          pLdh = parseFloat(document.getElementById('light-p-ldh').value),
          sLdh = parseFloat(document.getElementById('light-s-ldh').value),
          uln = parseFloat(document.getElementById('light-s-ldh-uln').value);
    
    const resBox = document.getElementById('res-light-final');

    if (pProt && sProt && pLdh && sLdh && uln) {
        const protRatio = pProt / sProt;
        const ldhRatio = pLdh / sLdh;
        const ldhThreshold = (2/3) * uln;

        // Kriterlerin değerlendirilmesi
        const c1 = protRatio > 0.5;
        const c2 = ldhRatio > 0.6;
        const c3 = pLdh > ldhThreshold;
        
        const isExudate = c1 || c2 || c3;
        
        const color = isExudate ? "#dc2626" : "#16a34a";
        const resultText = isExudate ? "EXUDATE" : "TRANSUDATE";
        const interpretation = isExudate 
            ? "Likely due to inflammation, infection, or malignancy. Further investigation (cytology, culture) is required."
            : "Likely due to systemic factors like heart failure, cirrhosis, or nephrotic syndrome.";

        resBox.style.display = 'block';
        resBox.innerHTML = `
            <div style="background: rgba(var(--primary-rgb), 0.05); border-left: 4px solid ${color}; padding: 15px; border-radius: 10px; margin-top: 10px;">
                <div style="font-size: 1.2rem; font-weight: bold; color: ${color}; mb-2">Result: ${resultText}</div>
                <div style="font-size: 0.85rem; margin-top: 4px; color: #334155; font-weight: 600;">${interpretation}</div>
                
                <div style="margin-top: 12px; display: flex; flex-direction: column; gap: 6px;">
                    <div style="font-size: 0.8rem; color: ${c1 ? color : '#64748b'}; font-weight: ${c1 ? 'bold' : 'normal'}">
                        ${c1 ? '●' : '○'} Protein Ratio: ${protRatio.toFixed(2)} ${c1 ? '(>0.5)' : ''}
                    </div>
                    <div style="font-size: 0.8rem; color: ${c2 ? color : '#64748b'}; font-weight: ${c2 ? 'bold' : 'normal'}">
                        ${c2 ? '●' : '○'} LDH Ratio: ${ldhRatio.toFixed(2)} ${c2 ? '(>0.6)' : ''}
                    </div>
                    <div style="font-size: 0.8rem; color: ${c3 ? color : '#64748b'}; font-weight: ${c3 ? 'bold' : 'normal'}">
                        ${c3 ? '●' : '○'} Pleural LDH: ${pLdh.toFixed(0)} ${c3 ? '(>2/3 ULN)' : ''}
                    </div>
                </div>

                <div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1); font-size: 0.75rem; color: #64748b; line-height:1.4;">
                    <strong>Calculation Method:</strong><br>
                    Exudate if any of the following are met:<br>
                    1. Pleural/Serum Protein > 0.5<br>
                    2. Pleural/Serum LDH > 0.6<br>
                    3. Pleural LDH > 2/3 of Serum LDH Upper Limit<br>
                    <span style="font-style: italic; display: block; margin-top: 4px;">*Clinical Note: If the patient is on diuretics and the result is "Exudate", consider calculating the Serum-Effusion Albumin Gradient.</span>
                </div>
            </div>
        `;
    } else {
        resBox.innerHTML = '';
        resBox.style.display = 'none';
    }
}

function calculateSAAG() {
    const s = getNormalizedValue('saag-serum', 'g/dL'),
          a = getNormalizedValue('saag-ascites', 'g/dL');
    const el = document.getElementById('res-saag-final');

    if (!isNaN(s) && !isNaN(a)) {
        const d = s - a;
        const d_gL = d * 10;
        
        let interpretation = "";
        let color = "#1e293b";

        // Klinik Yorumlama
        if (d >= 1.1) {
            interpretation = "SAAG ≥ 1.1 g/dL: High gradient. Suggests Portal Hypertension (e.g., Cirrhosis, CHF, Budd-Chiari).";
            color = "#16a34a"; // Yeşil
        } else if (d >= 0 && d < 1.1) {
            interpretation = "SAAG < 1.1 g/dL: Low gradient. Suggests non-portal hypertensive causes (e.g., Malignancy, TB, Pancreatitis).";
            color = "#d97706"; // Turuncu
        } else {
            // Negatif sonuç durumu
            interpretation = "Negative SAAG: Usually indicates an input error (Ascites albumin cannot physiologically exceed Serum albumin).";
            color = "#dc2626"; // Kırmızı
        }

        el.style.display = 'block';
        el.innerHTML = `
            <div style="background: rgba(var(--primary-rgb), 0.05); border-left: 4px solid ${color}; padding: 12px; border-radius: 8px; margin-top: 10px;">
                <div style="font-size: 1.15rem; font-weight: bold; color: ${color};">SAAG: ${d.toFixed(2)} g/dL (${d_gL.toFixed(1)} g/L)</div>
                <div style="font-size: 0.85rem; margin-top: 4px; color: #334155; font-weight: 600;">${interpretation}</div>
                
                <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1); font-size: 0.75rem; color: #64748b; line-height:1.4;">
                    <strong>Calculation Method:</strong><br>
                    SAAG = [Serum Albumin] - [Ascites Albumin]<br>
                    <span style="font-style: italic;">*Note: A high gradient (≥1.1) is 97% predictive of portal hypertension. If the result is negative, please verify your input values.</span>
                </div>
            </div>
        `;
    } else {
        el.innerHTML = '';
        el.style.display = 'none';
    }
}

function calculatePH() {
    const h = parseFloat(document.getElementById('ph-hco3').value);
    const p = parseFloat(document.getElementById('ph-pco2').value);
    const resBox = document.getElementById('res-ph-final');

    if (h && p) {
        const badge = document.getElementById('ph-pco2').parentNode.querySelector('.unit-badge');
        const txt = badge ? badge.textContent.trim() : '';
        
        // k = Solubilite katsayısı (mmHg için 0.03, kPa için 0.226)
        const k = txt.includes('kPa') ? 0.226 : 0.03;
        
        // Henderson-Hasselbalch: pH = 6.1 + log10(HCO3 / (k * pCO2))
        const ph = (6.1 + Math.log10(h / (k * p)));

        let interpretation = "";
        let color = "#1e293b";

        // Klinik Yorumlama
        if (ph < 7.35) {
            interpretation = "Acidemia: Blood pH is below the normal range.";
            color = "#dc2626"; // Kırmızı
        } else if (ph > 7.45) {
            interpretation = "Alkalemia: Blood pH is above the normal range.";
            color = "#2563eb"; // Mavi (Alkaloz için tipik)
        } else {
            interpretation = "Normal: pH is within the physiological range (7.35 - 7.45).";
            color = "#16a34a"; // Yeşil
        }

        resBox.style.display = 'block';
        resBox.innerHTML = `
            <div style="background: rgba(var(--primary-rgb), 0.05); border-left: 4px solid ${color}; padding: 12px; border-radius: 8px; margin-top: 10px;">
                <div style="font-size: 1.2rem; font-weight: bold; color: ${color};">Calculated pH: ${ph.toFixed(3)}</div>
                <div style="font-size: 0.85rem; margin-top: 4px; color: #334155; font-weight: 600;">${interpretation}</div>
                
                <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1); font-size: 0.75rem; color: #64748b; line-height:1.4;">
                    <strong>Calculation Method (Henderson-Hasselbalch):</strong><br>
                    pH = 6.1 + log<sub>10</sub>(HCO<sub>3</sub><sup>-</sup> / [${k} × pCO<sub>2</sub>])<br>
                    <span style="font-style: italic;">*Note: This formula assumes a normal body temperature (37°C). Significant hypothermia or hyperthermia can affect the pKa and solubility.</span>
                </div>
            </div>
        `;
    } else {
        resBox.innerHTML = '';
        resBox.style.display = 'none';
    }
}
function calculateMentzer() {
    const m = parseFloat(document.getElementById('men-mcv').value),
          r = parseFloat(document.getElementById('men-rbc').value);
    const resBox = document.getElementById('res-mentzer-final');

    if (m && r && r > 0) {
        const v = (m / r);
        
        let interpretation = "";
        let color = "#1e293b";

        // Klinik Yorumlama
        if (v < 13) {
            interpretation = "Mentzer Index < 13: Suggests Beta-Thalassemia Trait.";
            color = "#d97706"; // Turuncu
        } else {
            interpretation = "Mentzer Index ≥ 13: Suggests Iron Deficiency Anemia.";
            color = "#dc2626"; // Kırmızı (Demir eksikliği daha yaygın tedavi gerektirir)
        }

        resBox.style.display = 'block';
        resBox.innerHTML = `
            <div style="background: rgba(var(--primary-rgb), 0.05); border-left: 4px solid ${color}; padding: 12px; border-radius: 8px; margin-top: 10px;">
                <div style="font-size: 1.15rem; font-weight: bold; color: ${color};">Mentzer Index: ${v.toFixed(1)}</div>
                <div style="font-size: 0.85rem; margin-top: 4px; color: #334155; font-weight: 600;">${interpretation}</div>
                
                <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1); font-size: 0.75rem; color: #64748b; line-height:1.4;">
                    <strong>Calculation Method:</strong><br>
                    Mentzer Index = MCV / RBC<br>
                    <span style="font-style: italic;">*This index is most reliable when the patient has microcytic anemia (MCV < 80 fL).</span>
                </div>
            </div>
        `;
    } else {
        resBox.innerHTML = '';
        resBox.style.display = 'none';
    }
}
function calculateAlbGlob() {
    const a = getNormalizedValue('albglob-alb', 'g/dL'), 
          t = getNormalizedValue('albglob-tp', 'g/dL');
    const el = document.getElementById('res-albglob-final');

    if (!isNaN(a) && !isNaN(t) && a >= 0 && t >= 0 && t >= a) {
        const g = t - a;
        let ratioVal = g === 0 ? "∞" : (a / g).toFixed(2);
        
        let interpretation = "";
        let color = "#1e293b";

        // Klinik Yorumlama (A/G Oranı)
        if (g > 0) {
            const r = a / g;
            if (r < 1.1) {
                interpretation = "Low A/G ratio: Consider chronic inflammation, liver disease, or plasma cell dyscrasias.";
                color = "#dc2626"; // Kırmızı
            } else if (r >= 1.1 && r <= 2.5) {
                interpretation = "A/G ratio is within the expected clinical range.";
                color = "#16a34a"; // Yeşil
            } else {
                interpretation = "High A/G ratio: Often seen in hypogammaglobulinemia or certain leukemias.";
                color = "#d97706"; // Turuncu
            }
        }

        el.style.display = 'block';
        el.innerHTML = `
            <div style="background: rgba(var(--primary-rgb), 0.05); border-left: 4px solid ${color}; padding: 12px; border-radius: 8px; margin-top: 10px;">
                <div style="font-size: 1.15rem; font-weight: bold; color: ${color};">A/G Ratio: ${ratioVal}</div>
                <div style="font-size: 0.85rem; margin-top: 4px; color: #334155; font-weight: 600;">${interpretation}</div>
                
                <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1); font-size: 0.75rem; color: #64748b; line-height:1.4;">
                    <strong>Calculation Method:</strong><br>
                    1. Globulin = Total Protein - Albumin<br>
                    2. A/G Ratio = Albumin / Globulin<br>
                    <span style="font-style: italic;">*A low A/G ratio may indicate overproduction of globulins (e.g., Multiple Myeloma) or underproduction of albumin (e.g., Cirrhosis).</span>
                </div>
            </div>
        `;
    } else {
        el.innerHTML = '';
        el.style.display = 'none';
    }
}
    function calculateRBCIndices(){ const h=parseFloat(document.getElementById('rbc-hgb').value), hc=parseFloat(document.getElementById('rbc-hct').value), r=parseFloat(document.getElementById('rbc-count').value); if(h&&hc&&r){ const mcv=(hc/r*10); const mch=(h/r*10); const mchc=(h/hc*100); document.getElementById('res-rbc-final').innerHTML=`MCV: ${mcv.toFixed(1)} fL<br>MCH: ${mch.toFixed(1)} pg<br>MCHC: ${mchc.toFixed(1)} g/dL`; } else { document.getElementById('res-rbc-final').innerHTML=''; } }
function calculateRetic(){ 
    const r = parseFloat(document.getElementById('ret-pct').value), 
          h = parseFloat(document.getElementById('ret-hct').value), 
          n = parseFloat(document.getElementById('ret-hct-normal').value || '45'); 
    const resBox = document.getElementById('res-retic-final');

    if(r && h){ 
        let m = 1.0; 
        if(h <= 15) m = 2.5; 
        else if(h >= 16 && h <= 25) m = 2.0; 
        else if(h >= 26 && h <= 35) m = 1.5; 
        else m = 1.0; 

        // RPI (Reticulocyte Production Index) / CRC Calculation
        const crc = (r * (h / n)) / m; 
        
        let interpretation = "";
        let color = "#1e293b";

        // Klinik Yorumlama
        if (crc < 2) {
            interpretation = "CRC < 2%: Inadequate bone marrow response (Hypoproliferative anemia).";
            color = "#dc2626"; // Kırmızı
        } else {
            interpretation = "CRC ≥ 2%: Adequate bone marrow response (Hyperproliferative anemia).";
            color = "#16a34a"; // Yeşil
        }

        resBox.style.display = 'block';
        resBox.innerHTML = `
            <div style="background: rgba(var(--primary-rgb), 0.05); border-left: 4px solid ${color}; padding: 12px; border-radius: 8px; margin-top: 10px;">
                <div style="font-size: 1.15rem; font-weight: bold; color: ${color};">Reticulocyte Index (RPI): ${crc.toFixed(2)}%</div>
                <div style="font-size: 0.85rem; margin-top: 4px; color: #334155; font-weight: 600;">${interpretation}</div>
                
                <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1); font-size: 0.75rem; color: #64748b; line-height:1.4;">
                    <strong>Calculation Method:</strong><br>
                    RPI = (% Reticulocytes × [Measured Hct / Normal Hct]) / Maturation Factor<br>
                    <span style="font-style: italic;">*The maturation factor (${m}) adjusts for "shift reticulocytes" that leave the marrow early during severe anemia.</span>
                </div>
            </div>
        `;
    } else { 
        resBox.innerHTML = ''; 
        resBox.style.display = 'none';
    } 
}

function calculateINR(){ 
    const p = parseFloat(document.getElementById('inr-pt').value), 
          c = parseFloat(document.getElementById('inr-control').value), 
          i = parseFloat(document.getElementById('inr-isi').value); 
    const resBox = document.getElementById('res-inr-final');

    if(p && c && i){ 
        const v = Math.pow((p / c), i); 
        
        let interpretation = "";
        let color = "#1e293b";

        // Klinik Yorumlama
        if (v > 4.5) {
            interpretation = "Critical High: High risk of spontaneous bleeding. Monitor patient closely.";
            color = "#dc2626"; // Kırmızı
        } else if (v >= 2.0 && v <= 3.0) {
            interpretation = "Therapeutic Range: Typical target for DVT, PE, or Atrial Fibrillation.";
            color = "#16a34a"; // Yeşil
        } else if (v < 0.8) {
            interpretation = "Lower than normal: Increased risk of clotting.";
            color = "#d97706"; // Turuncu
        } else if (v > 1.1 && v < 2.0) {
            interpretation = "Elevated but sub-therapeutic (for most indications).";
            color = "#1e293b"; 
        } else {
            interpretation = "INR is within the normal range for healthy individuals.";
            color = "#16a34a";
        }

        resBox.style.display = 'block';
        resBox.innerHTML = `
            <div style="background: rgba(var(--primary-rgb), 0.05); border-left: 4px solid ${color}; padding: 12px; border-radius: 8px; margin-top: 10px;">
                <div style="font-size: 1.15rem; font-weight: bold; color: ${color};">INR: ${v.toFixed(2)}</div>
                <div style="font-size: 0.85rem; margin-top: 4px; color: #334155; font-weight: 600;">${interpretation}</div>
                
                <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1); font-size: 0.75rem; color: #64748b; line-height:1.4;">
                    <strong>Calculation Method:</strong><br>
                    INR = [Patient PT / Control PT]<sup>ISI</sup><br>
                    <span style="font-style: italic;">*ISI (International Sensitivity Index) is specific to the thromboplastin reagent used in the lab.</span>
                </div>
            </div>
        `;
    } else { 
        resBox.innerHTML = ''; 
        resBox.style.display = 'none';
    } 
}
function calculateBunCrea() {
    const b = getNormalizedValue('bc-bun', 'mg/dL'),
          c = getNormalizedValue('bc-crea', 'mg/dL');
    const el = document.getElementById('res-bun-crea-final');

    if (!isNaN(b) && !isNaN(c) && b > 0 && c > 0) {
        const v = (b / c);
        
        let interpretation = "";
        let color = "#1e293b";

        // Klinik Yorumlama
        if (v > 20) {
            interpretation = "Ratio > 20:1: Suggests Prerenal Azotemia (e.g., dehydration, heart failure, or GI bleed).";
            color = "#d97706"; // Turuncu
        } else if (v >= 10 && v <= 20) {
            interpretation = "Ratio 10-20:1: Normal range or Postrenal causes.";
            color = "#16a34a"; // Yeşil
        } else {
            interpretation = "Ratio < 10:1: Suggests Intrinsic Renal Injury (e.g., Acute Tubular Necrosis).";
            color = "#dc2626"; // Kırmızı
        }

        el.style.display = 'block';
        el.innerHTML = `
            <div style="background: rgba(var(--primary-rgb), 0.05); border-left: 4px solid ${color}; padding: 12px; border-radius: 8px; margin-top: 10px;">
                <div style="font-size: 1.15rem; font-weight: bold; color: ${color};">BUN/Cr Ratio: ${v.toFixed(1)}</div>
                <div style="font-size: 0.85rem; margin-top: 4px; color: #334155; font-weight: 600;">${interpretation}</div>
                
                <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1); font-size: 0.75rem; color: #64748b; line-height:1.4;">
                    <strong>Clinical Pearls:</strong><br>
                    • <strong>High Ratio (>20):</strong> Increased urea reabsorption due to low flow state (Dehydration).<br>
                    • <strong>Low Ratio (<10):</strong> Reduced urea reabsorption due to tubular damage (ATN).<br>
                    <span style="font-style: italic;">*Note: High protein intake or GI bleeding can also elevate this ratio.</span>
                </div>
            </div>
        `;
    } else {
        el.innerHTML = '';
        el.style.display = 'none';
    }
}

function calculateHIon() {
    const p = parseFloat(document.getElementById('h-pco2').value);
    const h = parseFloat(document.getElementById('h-hco3').value);
    const resBox = document.getElementById('res-h-ion-final');

    if (p && h && h > 0) {
        // Kassirer-Bleich Equation: [H+] = 24 * (pCO2 / HCO3)
        const val = (24 * (p / h));
        
        // [H+] değerinden tahmini pH hesaplama (Logaritmik dönüşüm)
        const estPh = 9 - Math.log10(val * 1e1); // Yaklaşık pH tahmini

        let interpretation = "";
        let color = "#1e293b";

        // Klinik Yorumlama
        if (val > 45) {
            interpretation = "Acidemia: High H+ concentration (pH < 7.35).";
            color = "#dc2626"; // Kırmızı
        } else if (val < 35) {
            interpretation = "Alkalemia: Low H+ concentration (pH > 7.45).";
            color = "#2563eb"; // Mavi
        } else {
            interpretation = "Normal range: H+ concentration is within 35-45 nmol/L.";
            color = "#16a34a"; // Yeşil
        }

        resBox.style.display = 'block';
        resBox.innerHTML = `
            <div style="background: rgba(var(--primary-rgb), 0.05); border-left: 4px solid ${color}; padding: 12px; border-radius: 8px; margin-top: 10px;">
                <div style="font-size: 1.2rem; font-weight: bold; color: ${color};">[H<sup>+</sup>]: ${val.toFixed(1)} nmol/L</div>
                <div style="font-size: 0.85rem; margin-top: 4px; color: #334155; font-weight: 600;">${interpretation}</div>
                
                <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1); font-size: 0.75rem; color: #64748b; line-height:1.4;">
                    <strong>Calculation Method (Kassirer-Bleich):</strong><br>
                    [H<sup>+</sup>] = 24 × (pCO<sub>2</sub> / HCO<sub>3</sub><sup>-</sup>)<br>
                    <span style="font-style: italic;">*Clinical Use: This linear equation is an alternative to Henderson-Hasselbalch. It is often used at the bedside to verify the internal consistency of blood gas results.</span>
                </div>
            </div>
        `;
    } else {
        resBox.innerHTML = '';
        resBox.style.display = 'none';
    }
}
function calculateFAI() {
    const ttEl = document.getElementById('fai-tt');
    const shbgEl = document.getElementById('fai-shbg');
    const albEl = document.getElementById('fai-alb');
    const resBox = document.getElementById('res-fai-final');

    const tt = parseFloat(ttEl.value);
    const shbg = parseFloat(shbgEl.value);
    const alb = parseFloat(albEl.value);

    if (!tt || !shbg || !alb) {
        resBox.innerHTML = '';
        resBox.style.display = 'none';
        return;
    }

    const ttUnit = ttEl.parentNode.querySelector('.unit-badge')?.textContent.trim() || '';
    const albUnit = albEl.parentNode.querySelector('.unit-badge')?.textContent.trim() || '';

    // Birim Çevrimleri (Standartlaştırma)
    let ttNmol = ttUnit.includes('ng/dL') ? tt * 0.0347 : tt;
    let albGL = albUnit.includes('g/dL') ? alb * 10 : alb;

    // Vermeulen Sabitleri
    const Ka = 10e8; 
    const Kb = 3.6e4; 
    const albMol = albGL / 66500;
    const shbgMol = shbg / 1e9;
    const ttMol = ttNmol / 1e9;

    const b_coef = Ka * shbgMol + Kb * albMol + 1 - Ka * ttMol;
    const freeTMol = (-b_coef + Math.sqrt(Math.pow(b_coef, 2) - 4 * Ka * (-ttMol))) / (2 * Ka);
    
    // Sonuçların Hazırlanması (Her iki birim için)
    const freeTNmol = freeTMol * 1e9;
    const freeTNgdl = freeTNmol / 0.0347;
    
    const bioavailTNmol = (freeTMol + (Kb * albMol * freeTMol)) * 1e9;
    const bioavailTNgdl = bioavailTNmol / 0.0347;
    
    const fai = (ttNmol / shbg) * 100;
    const freeTPercent = (freeTNmol / ttNmol) * 100;

    let interpretation = "";
    let color = "#1e293b";

    if (fai > 5) {
        interpretation = "Elevated FAI: Possible hyperandrogenism (e.g., PCOS).";
        color = "#dc2626";
    } else {
        interpretation = "FAI and Free T values are within clinical expectations.";
        color = "#16a34a";
    }

    resBox.style.display = 'block';
    resBox.innerHTML = `
        <div style="background: rgba(var(--primary-rgb), 0.05); border-left: 4px solid ${color}; padding: 15px; border-radius: 10px; margin-top: 10px;">
            <div style="font-size: 1.2rem; font-weight: bold; color: ${color}; margin-bottom: 8px;">FAI: ${fai.toFixed(1)}%</div>
            <div style="font-size: 0.85rem; margin-bottom: 12px; color: #334155; font-weight: 600;">${interpretation}</div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
                <div style="background: #fff; padding: 10px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                    <div style="font-size: 0.75rem; color: #64748b; font-weight: bold; text-transform: uppercase;">Free Testosterone</div>
                    <div style="font-size: 1rem; color: #1e293b; font-weight: 700;">${freeTNgdl.toFixed(2)} <span style="font-size: 0.7rem;">ng/dL</span></div>
                    <div style="font-size: 0.9rem; color: #475569;">${freeTNmol.toFixed(3)} <span style="font-size: 0.7rem;">nmol/L</span></div>
                    <div style="font-size: 0.8rem; color: var(--primary); margin-top: 4px;">Ratio: ${freeTPercent.toFixed(2)}%</div>
                </div>
                <div style="background: #fff; padding: 10px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                    <div style="font-size: 0.75rem; color: #64748b; font-weight: bold; text-transform: uppercase;">Bioavailable Testosterone</div>
                    <div style="font-size: 1rem; color: #1e293b; font-weight: 700;">${bioavailTNgdl.toFixed(2)} <span style="font-size: 0.7rem;">ng/dL</span></div>
                    <div style="font-size: 0.9rem; color: #475569;">${bioavailTNmol.toFixed(2)} <span style="font-size: 0.7rem;">nmol/L</span></div>
                </div>
            </div>

            <div style="padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1); font-size: 0.75rem; color: #64748b; line-height:1.4;">
                <strong>Calculation Method:</strong><br>
                Calculated using Vermeulen's equation. SHBG and Albumin binding constants (Ka: 10<sup>9</sup> L/mol, Kb: 3.6×10<sup>4</sup> L/mol) are applied.<br>
            </div>
        </div>
    `;
}

function calculateFPSA() {
    const f = parseFloat(document.getElementById('fpsa-free').value),
          t = parseFloat(document.getElementById('fpsa-total').value);
    const resBox = document.getElementById('res-fpsa-final');

    if (f && t && t > 0) {
        const pct = ((f / t) * 100);
        
        let interpretation = "";
        let color = "#1e293b";

        // Klinik Yorumlama (Total PSA 4-10 ng/mL aralığı için standart yorumlar)
        if (pct <= 10) {
            interpretation = "High risk of prostate cancer (~50%). Biopsy is strongly recommended.";
            color = "#dc2626"; // Kırmızı
        } else if (pct > 10 && pct <= 25) {
            interpretation = "Intermediate risk. Clinical correlation and other parameters (age, volume) are needed.";
            color = "#d97706"; // Turuncu
        } else {
            interpretation = "Lower risk of cancer. More likely associated with BPH or prostatitis.";
            color = "#16a34a"; // Yeşil
        }

        resBox.style.display = 'block';
        resBox.innerHTML = `
            <div style="background: rgba(var(--primary-rgb), 0.05); border-left: 4px solid ${color}; padding: 12px; border-radius: 8px; margin-top: 10px;">
                <div style="font-size: 1.15rem; font-weight: bold; color: ${color};">% Free PSA: ${pct.toFixed(1)}%</div>
                <div style="font-size: 0.85rem; margin-top: 4px; color: #334155; font-weight: 600;">${interpretation}</div>
                
                <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1); font-size: 0.75rem; color: #64748b; line-height:1.4;">
                    <strong>Calculation Method:</strong><br>
                    % Free PSA = (Free PSA / Total PSA) × 100<br>
                    <span style="font-style: italic;">*Clinical Note: This ratio is most diagnostic when Total PSA is between 4–10 ng/mL. Lower percentages (<10-15%) are more suspicious for malignancy.</span>
                </div>
            </div>
        `;
    } else {
        resBox.innerHTML = '';
        resBox.style.display = 'none';
    }
}
function calculateCaIon(){ const c=parseFloat(document.getElementById('cai-ca').value), t=parseFloat(document.getElementById('cai-tp').value); const el=document.getElementById('res-ca-ion-final'); if(c&&t){ const est=(((c*6)-(t/3))/(t+6)); el.innerHTML=`Estimated Ionized Ca: ${est.toFixed(2)}`; } else { el.innerHTML=''; } }

function calculateTransferrin() {
    const fe = getNormalizedValue('trans-fe', 'µg/dL');
    const tibc = getNormalizedValue('trans-tibc', 'µg/dL');
    const resBox = document.getElementById('res-transferrin-final');

    if (fe && tibc && tibc > 0) {
        const sat = (fe / tibc) * 100;
        
        let interpretation = "";
        let color = "#1e293b";

        // Klinik Yorumlama
        if (sat < 15) {
            interpretation = "Low Saturation: Suggests Iron Deficiency Anemia.";
            color = "#dc2626"; // Kırmızı
        } else if (sat > 45) {
            interpretation = "High Saturation: Consider Iron Overload (e.g., Hemochromatosis) or recent transfusion.";
            color = "#d97706"; // Turuncu
        } else {
            interpretation = "Saturation is within the normal physiological range (20–45%).";
            color = "#16a34a"; // Yeşil
        }

        resBox.style.display = 'block';
        resBox.innerHTML = `
            <div style="background: rgba(var(--primary-rgb), 0.05); border-left: 4px solid ${color}; padding: 12px; border-radius: 8px; margin-top: 10px;">
                <div style="font-size: 1.15rem; font-weight: bold; color: ${color};">Transferrin Saturation: ${sat.toFixed(1)}%</div>
                <div style="font-size: 0.85rem; margin-top: 4px; color: #334155; font-weight: 600;">${interpretation}</div>
                
                <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1); font-size: 0.75rem; color: #64748b; line-height:1.4;">
                    <strong>Calculation Method:</strong><br>
                    Saturation % = (Serum Iron / TIBC) × 100<br>
                    <span style="font-style: italic;">*Clinical Note: In iron deficiency, serum iron decreases while TIBC increases, leading to very low saturation. In chronic inflammation, both may be low.</span>
                </div>
            </div>
        `;
    } else {
        resBox.innerHTML = '';
        resBox.style.display = 'none';
    }
}


    function calculateA1c(s){
    const ngspInput = document.getElementById('a1c-ngsp');
    const ifccInput = document.getElementById('a1c-ifcc');
    const resBox = document.getElementById('res-a1c-eag');

    if(s === 'ngsp'){
        const v = parseFloat(ngspInput.value);
        if(!isNaN(v)) ifccInput.value = ((v - 2.152) / 0.09148).toFixed(1);
    } else {
        const v = parseFloat(ifccInput.value);
        if(!isNaN(v)) ngspInput.value = ((0.09148 * v) + 2.152).toFixed(1);
    }

    const ngsp = parseFloat(ngspInput.value);
    
    if(isNaN(ngsp)){
        resBox.innerHTML = '';
        resBox.style.display = 'none';
        return;
    }

    // eAG (Estimated Average Glucose) Calculation
    const eag_mg = (28.7 * ngsp) - 46.7;
    const eag_mmol = eag_mg / 18;

    let interpretation = "";
    let color = "#1e293b";

    // Klinik Yorumlama (ADA Standartları)
    if (ngsp < 5.7) {
        interpretation = "Normal range.";
        color = "#16a34a"; // Yeşil
    } else if (ngsp >= 5.7 && ngsp <= 6.4) {
        interpretation = "Prediabetes range. Increased risk of developing type 2 diabetes.";
        color = "#d97706"; // Turuncu
    } else {
        interpretation = "Diabetes range. Consistent with a diagnosis of diabetes.";
        color = "#dc2626"; // Kırmızı
    }

    resBox.style.display = 'block';
    resBox.innerHTML = `
        <div style="background: rgba(var(--primary-rgb), 0.05); border-left: 4px solid ${color}; padding: 12px; border-radius: 8px; margin-top: 10px;">
            <div style="font-size: 1rem; font-weight: bold; color: ${color}; mb-2">eAG: ${eag_mg.toFixed(0)} mg/dL (${eag_mmol.toFixed(1)} mmol/L)</div>
            <div style="font-size: 0.85rem; margin-top: 4px; color: #334155; font-weight: 600;">${interpretation}</div>
            
            <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1); font-size: 0.75rem; color: #64748b; line-height:1.4;">
                <strong>Calculation Method:</strong><br>
                1. <strong>IFCC/NGSP:</strong> Master Equation (NGSP = [0.09148 × IFCC] + 2.152)<br>
                2. <strong>eAG:</strong> (28.7 × HbA1c) - 46.7<br>
                <span style="font-style: italic;">*Clinical Note: HbA1c reflects the average blood glucose levels over the past 2-3 months.</span>
            </div>
        </div>
    `;
}

   // --- GFR FUNCTIONS (UPDATED) ---
    
    // Helper to switch gender UI (Separated from Race)
    function setCkdGender(g){ 
        ckdGender=g; 
        document.getElementById('btn-gender-female').classList.toggle('selected', g==='female');
        document.getElementById('btn-gender-male').classList.toggle('selected', g==='male');
        calculateGFR_Selected(); 
    }

    // Helper to switch race UI (Separated from Gender)
    function setCkdRace(r){ 
        ckdRace=r; 
        document.getElementById('btn-race-other').classList.toggle('selected', r==='other');
        document.getElementById('btn-race-black').classList.toggle('selected', r==='black');
        calculateGFR_Selected(); 
    }

    function updateGFRInputs(){ 
        const m = document.getElementById('gfr-method').value;
        
        // Creatinine visibility
        const needsCrea = ['2021-crea', '2021-combo', '2009-crea', '2012-combo', 'mdrd', 'cockcroft'].includes(m);
        document.getElementById('grp-crea').style.display = needsCrea ? 'block' : 'none';
        
        // Cystatin C visibility
        const needsCys = ['2021-combo', '2012-cys', '2012-combo'].includes(m);
        document.getElementById('grp-cys').style.display = needsCys ? 'block' : 'none';
        
        // Race visibility (Only 2009 CKD-EPI, MDRD and 2012 Combo use race adjustment)
        const needsRace = ['2009-crea', 'mdrd', '2012-combo'].includes(m);
        document.getElementById('grp-race').style.display = needsRace ? 'block' : 'none';

        // Weight visibility (Only Cockcroft-Gault)
        document.getElementById('grp-weight').style.display = (m === 'cockcroft') ? 'block' : 'none';

        calculateGFR_Selected(); 
    }
// --- EKSİK OLAN FONKSİYON ---
function getVal(id) {
    const element = document.getElementById(id);
    if (!element) return 0;
    const value = parseFloat(element.value);
    return isNaN(value) ? 0 : value;
}
    function calculateGFR_Selected(){ 
        const m = document.getElementById('gfr-method').value;
        const scr = getVal('gfr-crea', 'creatinine'); // getVal converts to mg/dL
        const cys = getVal('gfr-cys'); 
        const age = getVal('gfr-age');
        const weight = getVal('gfr-weight'); // For Cockcroft
        const isF = ckdGender === 'female';
        const isBlack = ckdRace === 'black';

        if(!age) { document.getElementById('res-gfr-final').innerText = ''; return; }

        let gfr = 0;
        const min = Math.min;
        const max = Math.max;

        // --- 1. 2021 CKD-EPI Creatinine (No Race) ---
        if(m === '2021-crea' && scr) {
            let k = isF ? 0.7 : 0.9;
            let a = isF ? -0.241 : -0.302;
            let s = isF ? 1.012 : 1;
            gfr = 142 * Math.pow(min(scr/k, 1), a) * Math.pow(max(scr/k, 1), -1.2) * Math.pow(0.9938, age) * s;
        }
        
        // --- 2. 2021 CKD-EPI Creatinine-Cystatin C (No Race) ---
        else if(m === '2021-combo' && scr && cys) {
            let k = isF ? 0.7 : 0.9;
            let a = isF ? -0.219 : -0.144; // Alpha for Crea
            let s = isF ? 1.012 : 1;
            gfr = 135 * Math.pow(min(scr/k, 1), a) * Math.pow(max(scr/k, 1), -0.544) 
                      * Math.pow(min(cys/0.8, 1), -0.323) * Math.pow(max(cys/0.8, 1), -0.778)
                      * Math.pow(0.9961, age) * s;
        }

        // --- 3. 2009 CKD-EPI Creatinine (With Race) ---
        else if(m === '2009-crea' && scr) {
            let k = isF ? 0.7 : 0.9;
            let a = isF ? -0.329 : -0.411;
            let s = isF ? 1.018 : 1;
            let r = isBlack ? 1.159 : 1;
            gfr = 141 * Math.pow(min(scr/k, 1), a) * Math.pow(max(scr/k, 1), -1.209) * Math.pow(0.993, age) * s * r;
        }

        // --- 4. 2012 CKD-EPI Cystatin C (No Race) ---
        else if(m === '2012-cys' && cys) {
            let s = isF ? 0.932 : 1;
            gfr = 133 * Math.pow(min(cys/0.8, 1), -0.499) * Math.pow(max(cys/0.8, 1), -1.328) * Math.pow(0.996, age) * s;
        }

        // --- 5. 2012 CKD-EPI Creatinine-Cystatin C (With Race) ---
        // Note: The 2012 combo originally included a race multiplier for Black (1.08).
        else if(m === '2012-combo' && scr && cys) {
            let k = isF ? 0.7 : 0.9;
            let a = isF ? -0.248 : -0.207;
            let s = isF ? 0.969 : 1;
            let r = isBlack ? 1.08 : 1; 
            
            gfr = 135 * Math.pow(min(scr/k, 1), a) * Math.pow(max(scr/k, 1), -0.601) 
                      * Math.pow(min(cys/0.8, 1), -0.375) * Math.pow(max(cys/0.8, 1), -0.711) 
                      * Math.pow(0.9952, age) * s * r;
        }

        // --- 6. MDRD (4-variable) ---
        else if(m === 'mdrd' && scr) {
            let s = isF ? 0.742 : 1;
            let r = isBlack ? 1.212 : 1;
            gfr = 175 * Math.pow(scr, -1.154) * Math.pow(age, -0.203) * s * r;
        }

        // --- 7. Cockcroft-Gault (Returns mL/min, not normalized to 1.73m2) ---
        else if(m === 'cockcroft' && scr && weight) {
            // Formula: ((140 - age) * weight) / (72 * scr) [* 0.85 if female]
            let s = isF ? 0.85 : 1;
            gfr = ((140 - age) * weight) / (72 * scr) * s;
        }

        // Result Display
        const resBox = document.getElementById('res-gfr-final');
        if(gfr > 0 && isFinite(gfr)) {
            let unit = (m === 'cockcroft') ? 'mL/min' : 'mL/min/1.73m²';
            resBox.innerHTML = `Result: ${gfr.toFixed(1)} ${unit}`;
        } else {
            resBox.innerHTML = '';
        }
    }

    function showCalcSuggestions(){ const inp=document.getElementById('calcSearchInput'), q=inp.value.toLowerCase(), box=document.getElementById('calcSuggestions'); box.innerHTML=''; if(!q.length){box.style.display='none'; return;} const m=calculators.filter(c=>c.title.toLowerCase().includes(q)); if(m.length){ m.forEach(c=>{ const d=document.createElement('div'); d.className='suggestion-item'; d.innerHTML=`<i class="fa-solid ${c.icon}" style="color:var(--primary)"></i> ${c.title}`; d.onclick=()=>{openCalc(c.id);box.style.display='none';inp.value='';}; box.appendChild(d); }); box.style.display='block'; } else box.style.display='none'; }


    // --- 8. LEVEY-JENNINGS ---
    function addLJPoint() {
        const val = parseFloat(document.getElementById('lj-val').value);
        if(!isNaN(val)) {
            ljData.push(val);
            if(document.querySelector('input[name="lj-calc-mode"][value="auto"]').checked) {
                recalcLJAuto();
            }
            renderLJData();
            document.getElementById('lj-val').value = '';
        }
    }
    
    function runLeveyJennings() {
        if (ljData.length === 0) {
            alert("Please add at least one data point.");
            return;
        }
        
        // Ensure auto-calc is up to date before running
        if(document.querySelector('input[name="lj-calc-mode"][value="auto"]').checked) {
            recalcLJAuto();
        }

        const mean = parseFloat(document.getElementById('lj-mean').value);
        const sd = parseFloat(document.getElementById('lj-sd').value);
        if (isNaN(mean) || isNaN(sd)) {
            alert("Please enter valid Mean and SD values.");
            return;
        }
        drawLJChart(mean, sd);
    }
    
    function editLJValue(index) {
        const currentVal = ljData[index];
        const newVal = prompt("Enter new value:", currentVal);
        if (newVal !== null) {
            const parsed = parseFloat(newVal);
            if (!isNaN(parsed)) {
                ljData[index] = parsed;
                if(document.querySelector('input[name="lj-calc-mode"][value="auto"]').checked) {
                    recalcLJAuto();
                }
                renderLJData();
            } else {
                alert("Please enter a valid number.");
            }
        }
    }
    
    function moveLJValue(index, direction) {
        if (direction === 'up' && index < ljData.length - 1) {
            [ljData[index], ljData[index + 1]] = [ljData[index + 1], ljData[index]];
            renderLJData();
        } else if (direction === 'down' && index > 0) {
            [ljData[index], ljData[index - 1]] = [ljData[index - 1], ljData[index]];
            renderLJData();
        }
    }
    
    function removeLJValue(index) {
        if(confirm("Are you sure you want to delete this value?")) {
            ljData.splice(index, 1);
            if(document.querySelector('input[name="lj-calc-mode"][value="auto"]').checked) {
                recalcLJAuto();
            }
            renderLJData();
        }
    }
    
    function clearLJData() {
        if(confirm("Clear all data?")) {
            ljData = [];
            if(document.querySelector('input[name="lj-calc-mode"][value="auto"]').checked) {
                recalcLJAuto();
            }
            renderLJData();
            if(ljChart) {
                ljChart.destroy();
                ljChart = null;
            }
        }
    }
    
    function renderLJData() {
        const tbody = document.getElementById('lj-data-tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        
        for(let i = ljData.length - 1; i >= 0; i--) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td contenteditable="true" onkeydown="handleInlineEnter(event)" onblur="commitLJPosition(${i}, this)" style="cursor:text;" title="Sırayı değiştir">${i + 1}</td>
                <td contenteditable="true" onkeydown="handleInlineEnter(event)" onblur="commitLJValue(${i}, this)" style="font-weight:bold; color:var(--primary); cursor:text;" title="Değeri düzenle">${ljData[i]}</td>
                <td>
                    <div class="action-group">
                        <button class="btn-icon btn-delete" onclick="removeLJValue(${i})" title="Delete"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </td>`;
            tbody.appendChild(tr);
        }
        if (ljData.length === 0) tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#999; padding:10px;">No data.</td></tr>';
    }
    function handleInlineEnter(e) { if (e.key === 'Enter') { e.preventDefault(); e.target.blur(); } }
    function commitLJPosition(index, el) {
        const n = ljData.length;
        const text = (el.innerText || '').trim();
        const newPos = parseInt(text, 10);
        if (isNaN(newPos) || newPos < 1 || newPos > n) { renderLJData(); return; }
        const to = newPos - 1;
        if (to === index) { renderLJData(); return; }
        const [item] = ljData.splice(index, 1);
        ljData.splice(to, 0, item);
        if(document.querySelector('input[name="lj-calc-mode"][value="auto"]').checked) { recalcLJAuto(); }
        renderLJData();
    }
    function commitLJValue(index, el) {
        const text = (el.innerText || '').trim();
        const val = parseFloat(text);
        if (isNaN(val)) { renderLJData(); return; }
        ljData[index] = val;
        if(document.querySelector('input[name="lj-calc-mode"][value="auto"]').checked) { recalcLJAuto(); }
        renderLJData();
    }
    function drawLJChart(mean, sd) {
        const ctx = document.getElementById('ljChart').getContext('2d');
        if(ljChart) ljChart.destroy();
        const labels = ljData.map((_, i) => i + 1);
        
        // Fixed limitSD to 2 (User requested removal of option)
        const limitSD = 2;
        
        // Calculate all limits
        const upperLimit = mean + limitSD * sd;
        const lowerLimit = mean - limitSD * sd;
        const upper3SD = mean + 3 * sd;
        const lower3SD = mean - 3 * sd;
        const upper2SD = mean + 2 * sd;
        const lower2SD = mean - 2 * sd;
        const upper1SD = mean + sd;
        const lower1SD = mean - sd;
        
        // Check Westgard Rules
        const activeRules = Array.from(document.querySelectorAll('.iqc-rule:checked')).map(cb => cb.value);
        const violations = checkWestgardRules(ljData, mean, sd, activeRules);
        
        // Determine point colors and styles based on values and violations
        const pointColors = [];
        const pointRadiuses = [];
        const pointStyles = [];
        
        ljData.forEach((val, index) => {
            let color = '#16a34a';
            let radius = 4;
            let style = 'circle';

            const violation = violations.find(v => v.index === index);
            if (violation) {
                radius = 7;
                style = 'rectRot';
                color = violation.color || '#b91c1c';
            }
            
            pointColors.push(color);
            pointRadiuses.push(radius);
            pointStyles.push(style);
        });
        
        const datasets = [
            // Background Zones (Stacked Logic for Fills)
            // Order: Top -> Bottom. We fill 'to' the next dataset index.
            
            // 1. Top Zone (> +2SD) -> Red
            { label: 'BgTop', data: Array(labels.length).fill(mean + 6 * sd), borderColor: 'transparent', pointRadius: 0, borderWidth: 0, backgroundColor: 'transparent', fill: 8, order: 10 },
            // 2. Upper Yellow Zone (+1SD to +2SD)
            { 
                label: 'BgUpperYellow', 
                data: Array(labels.length).fill(upper2SD), 
                borderColor: 'transparent', pointRadius: 0, borderWidth: 0, 
                backgroundColor: 'rgba(255, 255, 224)',
                fill: 2, // Fill to dataset index 2 (+1SD)
                order: 10 
            },
            // 3. Upper Green Zone (Mean to +1SD)
            { 
                label: 'BgUpperGreen', 
                data: Array(labels.length).fill(upper1SD), 
                borderColor: 'transparent', pointRadius: 0, borderWidth: 0, 
                backgroundColor: 'rgba(220, 252, 231, 0.15)',
                fill: 3, // Fill to dataset index 3 (Mean)
                order: 10 
            },
            // 4. Lower Green Zone (-1SD to Mean)
            { 
                label: 'BgLowerGreen', 
                data: Array(labels.length).fill(mean), 
                borderColor: 'rgba(22, 163, 74, 0.5)', pointRadius: 0, borderWidth: 1, borderDash: [5, 5], // Mean Line style
                backgroundColor: 'rgba(220, 252, 231, 0.15)',
                fill: 4, // Fill to dataset index 4 (-1SD)
                order: 10 
            },
            // 5. Lower Yellow Zone (-2SD to -1SD)
            { 
                label: 'BgLowerYellow', 
                data: Array(labels.length).fill(lower1SD), 
                borderColor: 'transparent', pointRadius: 0, borderWidth: 0, 
                backgroundColor: 'rgba(255, 255, 224)',
                fill: 5, // Fill to dataset index 5 (-2SD)
                order: 10 
            },
            // 6. Lower Red Zone (< -2SD)
            { label: 'BgLowerRed', data: Array(labels.length).fill(lower2SD), borderColor: 'transparent', pointRadius: 0, borderWidth: 0, backgroundColor: 'transparent', fill: 9, order: 10 },
            // 7. Bottom Limit
            { 
                label: 'BgBottom', 
                data: Array(labels.length).fill(mean - 6 * sd), // Bottom extreme (e.g. -6SD)
                borderColor: 'transparent', pointRadius: 0, borderWidth: 0, 
                fill: false, 
                order: 10 
            },

            // Control Value and SD Lines (drawn on top)
            { 
                label: 'Control Value', 
                data: ljData, 
                borderColor: '#0d9488', 
                backgroundColor: pointColors,
                pointBackgroundColor: pointColors,
                pointBorderColor: pointColors,
                pointBorderWidth: 2,
                borderWidth: 1,
                tension: 0.1, 
                pointRadius: pointRadiuses, 
                pointHoverRadius: 6,
                order: 1
            },
            // SD Lines for visual reference (without fills, just lines)
            { label: '+3SD', data: Array(labels.length).fill(upper3SD), borderColor:'rgba(220, 38, 38, 0.3)', borderDash:[5,5], pointRadius:0, borderWidth:1, order: 2, fill: false },
            { label: '-3SD', data: Array(labels.length).fill(lower3SD), borderColor:'rgba(220, 38, 38, 0.3)', borderDash:[5,5], pointRadius:0, borderWidth:1, order: 2, fill: false },
            { label: '+2SD', data: Array(labels.length).fill(upper2SD), borderColor:'rgba(220, 38, 38, 0.4)', borderDash:[5,5], pointRadius:0, borderWidth:1, order: 2, fill: false },
            { label: '-2SD', data: Array(labels.length).fill(lower2SD), borderColor:'rgba(220, 38, 38, 0.4)', borderDash:[5,5], pointRadius:0, borderWidth:1, order: 2, fill: false },
            { label: '+1SD', data: Array(labels.length).fill(upper1SD), borderColor:'rgba(245, 158, 11, 0.4)', borderDash:[3,3], pointRadius:0, borderWidth:1, order: 2, fill: false },
            { label: '-1SD', data: Array(labels.length).fill(lower1SD), borderColor:'rgba(245, 158, 11, 0.4)', borderDash:[3,3], pointRadius:0, borderWidth:1, order: 2, fill: false },
            // Mean is already drawn as Dataset 3 (BgLowerGreen border), but we can add a specific Mean line if needed, or rely on Dataset 3's border.
            // Dataset 3 has borderDash [5,5]. Let's make it solid if we want standard mean line.
            // Or just add a dedicated Mean line on top.
            { label: 'Mean', data: Array(labels.length).fill(mean), borderColor:'rgba(22, 163, 74, 0.8)', pointRadius:0, borderWidth:1.5, order: 2, fill: false }
        ];
        
        // ... (drawLJChart fonksiyonunun üst kısımları aynı kalacak) ...

        // ... (drawLJChart fonksiyonunun üst kısımları aynı kalacak) ...

        ljChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                devicePixelRatio: (window.devicePixelRatio || 1),
                layout: {
                    padding: {
                        left: 10,
                        right: 25,
                        top: 25,
                        bottom: 10
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'nearest'
                },
                scales: {
                    x: { 
                        title: { 
                            display: true, 
                            text: 'Observation Number', 
                            font: {weight:'bold'},
                            padding: { top: 10 } // Eksen başlığı ile değerler arasına boşluk
                        },
                        ticks: {
                            display: true,
                            padding: 5
                        },
                        grid: {
                            display: false
                        }
                    },
                    y: { 
                        title: { 
                            display: true, 
                            text: 'Control Value', 
                            font: {weight:'bold'},
                            padding: 12
                        },
                        min: lower3SD - (0.5 * sd),
                        max: upper3SD + (0.5 * sd),
                        ticks: {
                            display: true,
                            autoSkip: true,
                            maxTicksLimit: 6,
                            padding: 8,
                            callback: (val) => Math.round(val)
                        },
                        grid: {
                            drawOnChartArea: true,
                            drawBorder: true,
                            drawTicks: false
                        }
                    }
                },
                plugins: {
                    zoom: {
                        pan: { enabled: true, mode: 'x' },
                        zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'xy' }
                    },
                    ljBgPlugin: { mean, upper1SD, upper2SD, upper3SD, lower1SD, lower2SD, lower3SD },
                    // ChartDataLabels eklentisini bu grafik için kapatıyoruz
                    // Böylece değerler çizgi üzerinde tekrar yazmaz, sadece eksende görünür
                    datalabels: { 
                        display: false 
                    },
                    tooltip: {
                        enabled: true,
                        filter: function(tooltipItem) {
                            const ds = tooltipItem.chart.data.datasets[tooltipItem.datasetIndex];
                            return ds && ds.label === 'Control Value';
                        },
                        callbacks: {
                            label: function(context) {
                                if (context.dataset && context.dataset.label === 'Control Value') {
                                    const val = context.raw;
                                    const sdDiff = (val - mean) / sd;
                                    let sdText = '';
                                    
                                    if (Math.abs(sdDiff) < 0.01) {
                                        sdText = 'Mean (0 SD)';
                                    } else {
                                        const absSD = Math.abs(sdDiff);
                                        const sign = sdDiff > 0 ? '+' : '-';
                                        sdText = `${sign}${absSD.toFixed(2)} SD`;
                                    }
                                    
                                    return `Control Value: ${val.toFixed(2)} (${sdText})`;
                                }
                                return '';
                            }
                        }
                    },
                    legend: {
                        display: true,
                        // ... (legend ayarları aynı kalacak) ...
                        labels: {
                            generateLabels: function(chart) {
                                const defaultLabels = Chart.defaults.plugins.legend.labels.generateLabels.call(this, chart);
                                const groupedLabels = [];
                                const processed = new Set();
                                
                                defaultLabels.forEach((label, idx) => {
                                    if (processed.has(idx)) return;
                                    const text = label.text;
                                    
                                    // Filter out background zones from legend
                                    if (text.startsWith('Bg')) return;
                                    
                                    if (text === '+3SD' || text === '-3SD') {
                                        const plusLabel = defaultLabels.find(l => l.text === '+3SD');
                                        const minusLabel = defaultLabels.find(l => l.text === '-3SD');
                                        if (plusLabel && minusLabel) {
                                            groupedLabels.push({ ...plusLabel, text: '±3SD', datasetIndex: plusLabel.datasetIndex, hidden: plusLabel.hidden || minusLabel.hidden });
                                            processed.add(defaultLabels.indexOf(plusLabel));
                                            processed.add(defaultLabels.indexOf(minusLabel));
                                        }
                                    }
                                    else if (text === '+2SD' || text === '-2SD') {
                                        const plusLabel = defaultLabels.find(l => l.text === '+2SD');
                                        const minusLabel = defaultLabels.find(l => l.text === '-2SD');
                                        if (plusLabel && minusLabel) {
                                            groupedLabels.push({ ...plusLabel, text: '±2SD', datasetIndex: plusLabel.datasetIndex, hidden: plusLabel.hidden || minusLabel.hidden });
                                            processed.add(defaultLabels.indexOf(plusLabel));
                                            processed.add(defaultLabels.indexOf(minusLabel));
                                        }
                                    }
                                    else if (text === '+1SD' || text === '-1SD') {
                                        const plusLabel = defaultLabels.find(l => l.text === '+1SD');
                                        const minusLabel = defaultLabels.find(l => l.text === '-1SD');
                                        if (plusLabel && minusLabel) {
                                            groupedLabels.push({ ...plusLabel, text: '±1SD', datasetIndex: plusLabel.datasetIndex, hidden: plusLabel.hidden || minusLabel.hidden });
                                            processed.add(defaultLabels.indexOf(plusLabel));
                                            processed.add(defaultLabels.indexOf(minusLabel));
                                        }
                                    }
                                    else if (!processed.has(idx)) {
                                        groupedLabels.push(label);
                                        processed.add(idx);
                                    }
                                });
                                return groupedLabels;
                            }
                        },
                        // ... (onClick fonksiyonu aynı kalacak) ...
                        onClick: function(e, legendItem, legend) {
                            const chart = legend.chart;
                            const text = legendItem.text;
                            if (text === '±3SD') {
                                const plusMeta = chart.getDatasetMeta(chart.data.datasets.findIndex(d => d.label === '+3SD'));
                                const minusMeta = chart.getDatasetMeta(chart.data.datasets.findIndex(d => d.label === '-3SD'));
                                const newState = !plusMeta.hidden;
                                plusMeta.hidden = newState; minusMeta.hidden = newState;
                            } else if (text === '±2SD') {
                                const plusMeta = chart.getDatasetMeta(chart.data.datasets.findIndex(d => d.label === '+2SD'));
                                const minusMeta = chart.getDatasetMeta(chart.data.datasets.findIndex(d => d.label === '-2SD'));
                                const newState = !plusMeta.hidden;
                                plusMeta.hidden = newState; minusMeta.hidden = newState;
                            } else if (text === '±1SD') {
                                const plusMeta = chart.getDatasetMeta(chart.data.datasets.findIndex(d => d.label === '+1SD'));
                                const minusMeta = chart.getDatasetMeta(chart.data.datasets.findIndex(d => d.label === '-1SD'));
                                const newState = !plusMeta.hidden;
                                plusMeta.hidden = newState; minusMeta.hidden = newState;
                            } else {
                                const index = legendItem.datasetIndex;
                                const meta = chart.getDatasetMeta(index);
                                meta.hidden = meta.hidden === null ? !chart.data.datasets[index].hidden : null;
                            }
                            chart.update();
                        }
                    }
                }
            }
        });

// ... (Kalan kodlar aynı) ...
    }
    
    function updateLJLimits() {
        // If chart exists, redraw it with new limits
        if (ljChart && ljData.length > 0) {
            const mean = parseFloat(document.getElementById('lj-mean').value);
            const sd = parseFloat(document.getElementById('lj-sd').value);
            if (!isNaN(mean) && !isNaN(sd)) {
                drawLJChart(mean, sd);
            }
        }
    }

    // --- 9. PBRTQC LOGIC ---
    function populateAnalyteSelect() {
        const sel = document.getElementById('pbrtqc-analyte');
        sel.innerHTML = "";
        Object.keys(analyteDB).sort().forEach(k => {
            if(k !== 'Other') {
                const opt = document.createElement('option');
                opt.value = k; opt.text = k;
                sel.add(opt);
            }
        });
        const opt = document.createElement('option');
        opt.value = 'Other'; 
        opt.text = "Other (Custom)";
        sel.add(opt);
    }

    function updatePBRTQCConfig() {
        const analyte = document.getElementById('pbrtqc-analyte').value;
        const unitDiv = document.getElementById('unit-group');
        const unitSel = document.getElementById('pbrtqc-unit');
        const methodSel = document.getElementById('pbrtqc-method');
        const paramModeSel = document.getElementById('param-mode');
        const customParams = document.getElementById('custom-params');

        if (analyte === 'Other') {
            unitDiv.style.display = 'none'; 
            customParams.style.display = 'block'; 
            
            methodSel.querySelector('option[value="auto"]').style.display = 'none';
            methodSel.value = 'ewma';

            paramModeSel.querySelector('option[value="auto"]').style.display = 'none';
            paramModeSel.value = 'manual';
            
        } else {
            unitDiv.style.display = 'none'; // Unit selection hidden
            customParams.style.display = 'none';
            
            methodSel.querySelector('option[value="auto"]').style.display = 'block';
            paramModeSel.querySelector('option[value="auto"]').style.display = 'block';

            // Set default unit (first unit in the list)
            unitSel.innerHTML = "";
            const units = analyteDB[analyte].units;
            const unitKeys = Object.keys(units);
            unitKeys.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u; opt.text = u;
                unitSel.add(opt);
            });
            // Set default to first unit
            if (unitKeys.length > 0) {
                unitSel.value = unitKeys[0];
            }
        }
        togglePBRTQCParams();
    }

    function togglePBRTQCParams() {
        const method = document.getElementById('pbrtqc-method').value;
        const paramContainer = document.getElementById('param-container');
        if(method === 'auto') paramContainer.style.display = 'none';
        else {
            paramContainer.style.display = 'block';
            toggleManualParams();
        }
    }

    function toggleManualParams() {
        const method = document.getElementById('pbrtqc-method').value;
        const mode = document.getElementById('param-mode').value;
        const manualDiv = document.getElementById('manual-params');
        const autoInfo = document.getElementById('auto-param-display');
        
        if (mode === 'manual') {
            manualDiv.style.display = 'grid';
            autoInfo.style.display = 'none';
            const ewmaEls = document.querySelectorAll('.ewma-only');
            const maEls = document.querySelectorAll('.ma-only');
            ewmaEls.forEach(e => e.style.display = method === 'ewma' ? 'block' : 'none');
            maEls.forEach(e => e.style.display = method === 'ma' ? 'block' : 'none');
        } else {
            manualDiv.style.display = 'none';
            autoInfo.style.display = 'block';
            const analyte = document.getElementById('pbrtqc-analyte').value;
            const db = analyteDB[analyte].opt;
            if(method === 'ewma') autoInfo.innerText = `Auto: λ=${db.lam}, L=${db.L}`;
            else if(method === 'ma') autoInfo.innerText = `Auto: w=${db.w || 50}`;
        }
    }

    function triggerExcelInput() {
        const fileInput = document.getElementById('excel-upload');
        if(fileInput) {
            fileInput.value = '';
            fileInput.click();
        }
    }

    function handleExcelUpload(input) {
        if (!input.files || input.files.length === 0) return;

        const file = input.files[0];
        const reader = new FileReader();

        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const json = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                const newValues = json.flat().map(n => parseFloat(n)).filter(n => !isNaN(n));

                if (newValues.length > 0) {
                    pbrtqcData = newValues;
                    const statusSpan = document.getElementById('pbrtqc-upload-status');
                    if(statusSpan) {
                        statusSpan.innerText = `${pbrtqcData.length} data loaded.`;
                        statusSpan.style.display = 'inline';
                        setTimeout(() => { statusSpan.style.display = 'none'; }, 3000);
                    }
                    renderData();
                } else {
                    alert("Error: No valid numeric data found in Excel.");
                }
            } catch (error) {
                console.error(error);
                alert("File read error!");
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function addManualValue() {
        const input = document.getElementById('single-val-input');
        const val = parseFloat(input.value);
        if(!isNaN(val)) {
            pbrtqcData.push(val);
            input.value = ''; input.focus();
            renderData();
        }
    }

    function editManualValue(index) {
        const currentVal = pbrtqcData[index];
        const newVal = prompt("Enter new value:", currentVal);
        if (newVal !== null) {
            const parsed = parseFloat(newVal);
            if (!isNaN(parsed)) {
                pbrtqcData[index] = parsed;
                renderData();
            } else {
                alert("Please enter a valid number.");
            }
        }
    }

    function moveManualValue(index, direction) {
        if (direction === 'up' && index < pbrtqcData.length - 1) {
            [pbrtqcData[index], pbrtqcData[index + 1]] = [pbrtqcData[index + 1], pbrtqcData[index]];
            renderData();
        } else if (direction === 'down' && index > 0) {
            [pbrtqcData[index], pbrtqcData[index - 1]] = [pbrtqcData[index - 1], pbrtqcData[index]];
            renderData();
        }
    }

    function removeManualValue(index) {
        if(confirm("Are you sure you want to delete this value?")) {
            pbrtqcData.splice(index, 1);
            renderData();
        }
    }

    function clearManualData() { 
        if(confirm("Clear all data?")) {
            pbrtqcData=[]; 
            renderData(); 
        }
    }
    
    function renderData() {
        const tbody = document.getElementById('manual-data-tbody');
        tbody.innerHTML = '';
        
        for(let i = pbrtqcData.length - 1; i >= 0; i--) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td contenteditable="true" onkeydown="handleInlineEnter(event)" onblur="commitManualPosition(${i}, this)" style="cursor:text;" title="Sırayı değiştir">${i + 1}</td>
                <td contenteditable="true" onkeydown="handleInlineEnter(event)" onblur="commitManualValue(${i}, this)" style="font-weight:bold; color:var(--primary); cursor:text;" title="Değeri düzenle">${pbrtqcData[i]}</td>
                <td>
                    <div class="action-group">
                        <button class="btn-icon btn-delete" onclick="removeManualValue(${i})" title="Delete"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </td>`;
            tbody.appendChild(tr);
        }
        if (pbrtqcData.length === 0) tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#999; padding:10px;">No data.</td></tr>';
    }
    function commitManualPosition(index, el) {
        const n = pbrtqcData.length;
        const text = (el.innerText || '').trim();
        const newPos = parseInt(text, 10);
        if (isNaN(newPos) || newPos < 1 || newPos > n) { renderData(); return; }
        const to = newPos - 1;
        if (to === index) { renderData(); return; }
        const [item] = pbrtqcData.splice(index, 1);
        pbrtqcData.splice(to, 0, item);
        renderData();
    }
    function commitManualValue(index, el) {
        const text = (el.innerText || '').trim();
        const val = parseFloat(text);
        if (isNaN(val)) { renderData(); return; }
        pbrtqcData[index] = val;
        renderData();
    }

    function downloadTemplate() {
        if (typeof XLSX === 'undefined') return alert("Excel library not loaded.");
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet([["Values"], [10.5], [11.2], [10.8], [9.9], [10.1]]);
        XLSX.utils.book_append_sheet(wb, ws, "Data");
        XLSX.writeFile(wb, "PBRTQC_Template.xlsx");
    }

    function runPBRTQC() {
        if(pbrtqcData.length < 5) return alert("At least 5 data points required.");
        
        const analyte = document.getElementById('pbrtqc-analyte').value;
        const methodVal = document.getElementById('pbrtqc-method').value;
        
        let cvi, cvg, ltl, utl, lambda, L, w, method;

        if (analyte === 'Other') {
            cvi = parseFloat(document.getElementById('cust-cvi').value);
            cvg = parseFloat(document.getElementById('cust-cvg').value);
            ltl = parseFloat(document.getElementById('cust-l').value);
            utl = parseFloat(document.getElementById('cust-u').value);
            method = methodVal; 
            lambda = parseFloat(document.getElementById('manual-lambda').value);
            L = parseFloat(document.getElementById('manual-l').value);
            w = parseInt(document.getElementById('manual-w').value);
        } else {
            const db = analyteDB[analyte];
            cvi = db.cvi; cvg = db.cvg;
            const unitKey = document.getElementById('pbrtqc-unit').value;
            ltl = db.units[unitKey].l; utl = db.units[unitKey].u;
            
            if(methodVal === 'auto') method = db.opt.m; else method = methodVal;
            
            const mode = document.getElementById('param-mode').value;
            if(mode === 'auto') {
                lambda = db.opt.lam; L = db.opt.L; w = db.opt.w || 50;
            } else {
                lambda = parseFloat(document.getElementById('manual-lambda').value);
                L = parseFloat(document.getElementById('manual-l').value);
                w = parseInt(document.getElementById('manual-w').value);
            }
        }

        let data = [...pbrtqcData];
        let logs = `<b>${analyte}</b>`;

        let paramStr = "";
        if(method === 'ewma') paramStr = `EWMA (λ=${lambda}, L=${L})`;
        else paramStr = `MA (w=${w})`;
        logs += `<br><small style="color:var(--text-light)">Used Parameters: ${paramStr}</small><br>`;

        if(document.getElementById('opt-trunc').checked) {
            const mu0 = data.reduce((a,b)=>a+b, 0) / data.length; 
            const term1 = Math.pow(cvg, 2);
            const term2 = 1.25 * Math.pow(cvi, 2);
            const rcvPercent = 2.76 * Math.sqrt(term1 + term2); 

            const low = mu0 * (1 - (rcvPercent / 100));  
            const high = mu0 * (1 + (rcvPercent / 100)); 
            
            const initialCount = data.length; 
            data = data.filter(v => v >= low && v <= high);
            const excludedCount = initialCount - data.length; 
            
            if(excludedCount > 0) {
                logs += `<span style="color:var(--danger)">RCV (%${rcvPercent.toFixed(1)}) Truncation:<br>Limits: ${low.toFixed(2)} - ${high.toFixed(2)}<br><b>${excludedCount} excluded.</b></span><br>`;
            } else {
                logs += `<span style="color:var(--success)">RCV (%${rcvPercent.toFixed(1)}) Truncation: No data loss.</span><br>`;
            }

            if(data.length === 0) return alert("Error: No data left after truncation!");
        }

        let processed = [...data];
        let isLog = false;
        if(document.getElementById('opt-norm').checked) {
            processed = data.map(x => Math.log(x));
            isLog = true;
            logs += "Log Transformation Applied.<br>";
        }

        const mean = processed.reduce((a,b)=>a+b,0)/processed.length;
        const sd = Math.sqrt(processed.reduce((a,b)=>a+Math.pow(b-mean,2),0)/(processed.length-1));
        
        let res=[], ucl=[], lcl=[], cl=[];

        if(method === 'ewma') {
            let z = mean; 
            processed.forEach((val, i) => {
                let t = i+1;
                z = lambda*val + (1-lambda)*z;
                res.push(z);
                let factor = Math.sqrt( (lambda/(2-lambda)) * (1 - Math.pow(1-lambda, 2*t)) );
                ucl.push(mean + L*sd*factor);
                lcl.push(mean - L*sd*factor);
                cl.push(mean);
            });
        } else { // MA
            for(let i=0; i<processed.length; i++) {
                let subset = [];
                let start = Math.max(0, i-w+1);
                for(let k=start; k<=i; k++) subset.push(processed[k]);
                let subMean = subset.reduce((a,b)=>a+b,0)/subset.length;
                res.push(subMean);
                let limit = 3 * (sd/Math.sqrt(subset.length));
                ucl.push(mean+limit); lcl.push(mean-limit); cl.push(mean);
            }
        }

        if(isLog) {
            res = res.map(Math.exp); ucl = ucl.map(Math.exp); lcl = lcl.map(Math.exp); cl = cl.map(Math.exp);
        }

        const xTitle = 'Observation Number';
        const yTitle = method.toUpperCase() === 'EWMA' ? 'EWMA' : 'MA';

        drawQCChart(res, ucl, lcl, cl, method.toUpperCase(), data, xTitle, yTitle);
        
        document.getElementById('qc-result-area').style.display = 'block';
        document.getElementById('qc-stats').innerHTML = logs;
    }

    function drawQCChart(data, ucl, lcl, cl, label, rawData, xTitle, yTitle) {
        const ctx = document.getElementById('qcChart').getContext('2d');
        if(qcChart) qcChart.destroy();
        
        const pointColors = data.map((v, i) => (v > ucl[i] || v < lcl[i]) ? '#dc2626' : '#16a34a');

        qcChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map((_, i) => i+1),
                datasets: [
                    {
                        label: label, 
                        data: data, 
                        borderColor: '#2563eb', 
                        pointBackgroundColor: pointColors,
                        pointBorderColor: pointColors, 
                        pointRadius: 4, 
                        borderWidth: 1.5, 
                        fill: false,
                        datalabels: { display: false }
                    },
                    { label: 'UCL', data: ucl, borderColor: '#dc2626', borderDash: [5,5], pointRadius:0, borderWidth:1, datalabels:{display:false} },
                    { label: 'LCL', data: lcl, borderColor: '#dc2626', borderDash: [5,5], pointRadius:0, borderWidth:1, datalabels:{display:false} },
                    { label: 'CL', data: cl, borderColor: '#16a34a', pointRadius:0, borderWidth:1, datalabels:{display:false} }
                ]
            },
            options: {
                responsive: true, 
                maintainAspectRatio: false,
                devicePixelRatio: (window.devicePixelRatio || 1),
                scales: {
                    x: { title: { display: true, text: xTitle, font: {weight:'bold'} } },
                    y: { title: { display: true, text: yTitle, font: {weight:'bold'} } }
                },
                plugins: {
                    zoom: {
                        pan: { enabled: true, mode: 'x' },
                        zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'xy' }
                    },
                    datalabels: { display: false },
                    tooltip: {
                        enabled: true, 
                        callbacks: {
                            label: function(context) {
                                if(context.datasetIndex === 0) {
                                    return [
                                        `Result: ${context.raw.toFixed(2)}`, 
                                        `Raw Data: ${rawData[context.dataIndex]}`
                                    ];
                                }
                                return context.dataset.label;
                            }
                        }
                    }
                }
            }
        });
    }

    function downloadHighResChart(chartId) {
        const chart = Chart.getChart(chartId);
        if (!chart) {
            alert("Chart not found. Please generate the chart first.");
            return;
        }
        
        try {
            const originalWidth = chart.canvas.width;
            const originalHeight = chart.canvas.height;
            const scaleFactor = 6; 
            
            // Temporarily increase canvas size
            chart.canvas.width = originalWidth * scaleFactor;
            chart.canvas.height = originalHeight * scaleFactor;
            chart.resize();
            chart.update('none'); // Don't animate
            
            // Wait for chart to update
            setTimeout(() => {
                const link = document.createElement('a');
                link.download = `Chart_600DPI_${Date.now()}.png`;
                link.href = chart.canvas.toDataURL('image/png', 1.0);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Restore original size
                chart.canvas.width = originalWidth;
                chart.canvas.height = originalHeight;
                chart.resize();
                chart.update('none');
            }, 100);
        } catch (error) {
            console.error("Error downloading chart:", error);
            alert("Error downloading chart. Please try again.");
        }
    }

    // --- YENİ EKLENEN FONKSİYONLAR ---

    // 1. Akordeon Açma/Kapama Fonksiyonu
    function toggleQC(id, header) {
        const target = document.getElementById(id);
        const isCurrentlyOpen = target.style.display === 'block' || (target.style.display === '' && window.getComputedStyle(target).display === 'block');
        
        // Eğer tıklanan accordion açıksa, onu kapat
        if (isCurrentlyOpen) {
            target.style.display = 'none';
            header.classList.remove('active');
            const chevron = header.querySelector('i.fa-chevron-down');
            if (chevron) chevron.style.transform = 'rotate(0deg)';
        } else {
            // Açıksa, diğerlerini kapat ve bunu aç
            document.querySelectorAll('.qc-body').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.qc-header').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.qc-header i.fa-chevron-down').forEach(el => el.style.transform = 'rotate(0deg)');
            
            target.style.display = 'block';
            header.classList.add('active');
            const chevron = header.querySelector('i.fa-chevron-down');
            if (chevron) chevron.style.transform = 'rotate(180deg)';
        }
    }

    function calculateSigmaMetric() {
        const tea = parseFloat(document.getElementById('sigma-tea').value);
        const cv = parseFloat(document.getElementById('sigma-cv').value);
        const biasInput = parseFloat(document.getElementById('sigma-bias').value);
        const useBias = document.getElementById('sigma-use-bias').checked;
        const resEl = document.getElementById('res-sigma-final');
        
        let bias = useBias ? (isNaN(biasInput) ? 0 : biasInput) : 0;
        document.getElementById('sigma-bias').disabled = !useBias;
        document.getElementById('sigma-bias').parentElement.style.opacity = useBias ? '1' : '0.5';

        if (!isNaN(tea) && !isNaN(cv) && cv !== 0) {
            const sigma = (tea - Math.abs(bias)) / cv;
            let color = '';
            let text = '';
            
            if (sigma >= 6) { color = '#16a34a'; text = 'World Class'; }
            else if (sigma >= 5) { color = '#84cc16'; text = 'Excellent'; }
            else if (sigma >= 4) { color = '#facc15'; text = 'Good'; }
            else if (sigma >= 3) { color = '#f97316'; text = 'Marginal'; }
            else { color = '#dc2626'; text = 'Poor'; }
            
            resEl.innerHTML = `
                <div style="font-size:1.2rem; font-weight:bold; color:${color}">σ = ${sigma.toFixed(2)}</div>
                <div style="color:${color}; font-weight:500;">${text}</div>
            `;
            
            drawSigmaChart(tea, cv, bias);
        } else {
            resEl.innerHTML = '';
            drawSigmaChart(null, null, null); // Clear chart or draw empty grid
        }
    }
    
    function updateSigmaBiasToggle() {
        const useBias = document.getElementById('sigma-use-bias').checked;
        document.getElementById('sigma-bias').disabled = !useBias;
        document.getElementById('sigma-bias').parentElement.style.opacity = useBias ? '1' : '0.5';
    }
    
    function runSigmaMetric() {
        calculateSigmaMetric();
    }
    
    let sigmaChartInstance = null;
    function drawSigmaChart(tea, userCV, userBias) {
        const ctx = document.getElementById('sigmaChart').getContext('2d');
        if (sigmaChartInstance) {
            sigmaChartInstance.destroy();
        }
        
        // If no valid input, just show empty grid or return
        if (tea === null || isNaN(tea)) {
             // Optional: Draw empty grid
             return;
        }

        // Define Chart Limits
        // X-Axis: CV% (0 to TEa/2 usually covers most)
        // Y-Axis: Bias% (0 to TEa)
        // We need to draw lines for Sigma = 2, 3, 4, 5, 6
        // Line Equation: |Bias| = TEa - Sigma * CV  => Y = TEa - Sigma * X
        
        const maxX = tea / 2; // CV usually doesn't go beyond half of TEa for decent methods
        const maxY = tea; 
        
        // Generate line data points
        // For each sigma level, we need 2 points: (0, TEa) and (TEa/Sigma, 0)
        // Actually Y = TEa - Sigma*X. If Y=0, X = TEa/Sigma.
        
        const generateLine = (sigma) => {
            return [
                {x: 0, y: tea},
                {x: tea/sigma, y: 0}
            ];
        };

        const datasets = [
            {
                label: 'Sigma 6 (World Class)',
                data: generateLine(6),
                borderColor: '#16a34a', borderWidth: 2, fill: false, tension:0, pointRadius:0
            },
            {
                label: 'Sigma 5 (Excellent)',
                data: generateLine(5),
                borderColor: '#84cc16', borderWidth: 2, fill: false, tension:0, pointRadius:0
            },
            {
                label: 'Sigma 4 (Good)',
                data: generateLine(4),
                borderColor: '#facc15', borderWidth: 2, fill: false, tension:0, pointRadius:0
            },
            {
                label: 'Sigma 3 (Marginal)',
                data: generateLine(3),
                borderColor: '#f97316', borderWidth: 2, fill: false, tension:0, pointRadius:0
            },
            {
                label: 'Sigma 2 (Poor)',
                data: generateLine(2),
                borderColor: '#dc2626', borderWidth: 2, fill: false, tension:0, pointRadius:0
            }
        ];

        // Add User Point
        if (userCV !== null && userBias !== null) {
            datasets.push({
                label: 'Your Method',
                data: [{x: userCV, y: Math.abs(userBias)}],
                backgroundColor: 'black',
                borderColor: 'black',
                pointRadius: 6,
                pointHoverRadius: 8,
                type: 'scatter'
            });
        }

        sigmaChartInstance = new Chart(ctx, {
            type: 'line',
            data: { datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                devicePixelRatio: (window.devicePixelRatio || 1),
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom',
                        title: { display: true, text: 'CV (%)', font:{weight:'bold'} },
                        min: 0,
                        // max: maxX * 1.1 // Add some padding
                    },
                    y: {
                        type: 'linear',
                        position: 'left',
                        title: { display: true, text: 'Bias (%)', font:{weight:'bold'} },
                        min: 0,
                        max: maxY * 1.1
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { boxWidth: 10, usePointStyle: true }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label;
                            }
                        }
                    },
                    datalabels: { display: false }
                }
            }
        });
    }

    function recalcLJAuto() {
        const meanInput = document.getElementById('lj-mean');
        const sdInput = document.getElementById('lj-sd');
        
        if (ljData.length > 0) {
             const sum = ljData.reduce((a, b) => a + b, 0);
             const avg = sum / ljData.length || 0;
             const variance = ljData.reduce((a, b) => a + Math.pow(b - avg, 2), 0) / (ljData.length - 1 || 1);
             const std = Math.sqrt(variance);
             
             meanInput.value = avg.toFixed(2);
             sdInput.value = std.toFixed(2);
        } else {
            meanInput.value = '';
            sdInput.value = '';
        }
    }

    function toggleLJMode() {
        const mode = document.querySelector('input[name="lj-calc-mode"]:checked').value;
        const meanInput = document.getElementById('lj-mean');
        const sdInput = document.getElementById('lj-sd');
        
        if (mode === 'auto') {
            meanInput.disabled = true;
            sdInput.disabled = true;
            recalcLJAuto();
        } else {
            meanInput.disabled = false;
            sdInput.disabled = false;
        }
    }

    // Levey-Jennings Kuralları
    function checkWestgardRules(data, mean, sd, activeRules) {
        const violations = [];
        const zs = data.map(v => (v - mean) / sd);
        const n = zs.length;
        
        // Helper: Check if rule is active
        const isRuleActive = (r) => activeRules.includes(r);
        
        for (let i = 0; i < n; i++) {
            const z = zs[i];
            const prevZ = i > 0 ? zs[i-1] : null;
            
            // 1-2s (Warning)
            if (isRuleActive('1-2s') && Math.abs(z) > 2) {
                violations.push({ index: i, rule: '1-2s', color: 'orange' });
            }
            
            // 1-3s (Rejection)
            if (isRuleActive('1-3s') && Math.abs(z) > 3) {
                violations.push({ index: i, rule: '1-3s', color: 'red' });
            }
            
            // 2-2s (Rejection) - Two consecutive > 2SD on same side
            if (isRuleActive('2-2s') && i > 0) {
                if (z > 2 && prevZ > 2) violations.push({ index: i, rule: '2-2s', color: 'orange' });
                if (z < -2 && prevZ < -2) violations.push({ index: i, rule: '2-2s', color: 'orange' });
            }
            
            // R-4s (Rejection) - Range > 4SD within run (assuming consecutive points here for simplicity)
            if (isRuleActive('R-4s') && i > 0) {
                if (Math.abs(z - prevZ) > 4) violations.push({ index: i, rule: 'R-4s', color: 'purple' });
            }
            
            // 4-1s (Rejection) - 4 consecutive > 1SD same side
            if (isRuleActive('4-1s') && i >= 3) {
                const last4 = zs.slice(i-3, i+1);
                if (last4.every(val => val > 1)) violations.push({ index: i, rule: '4-1s', color: 'brown' });
                if (last4.every(val => val < -1)) violations.push({ index: i, rule: '4-1s', color: 'brown' });
            }
            
            // 10x (Rejection) - 10 consecutive on same side of mean
            if (isRuleActive('10x') && i >= 9) {
                const last10 = zs.slice(i-9, i+1);
                if (last10.every(val => val > 0)) violations.push({ index: i, rule: '10x', color: 'blue' });
                if (last10.every(val => val < 0)) violations.push({ index: i, rule: '10x', color: 'blue' });
            }
        }
        return violations;
    }

    // 2. Levey-Jennings için Excel ve Template Fonksiyonları
    function triggerLJExcelInput() {
        const fileInput = document.getElementById('lj-excel-upload');
        if(fileInput) {
            fileInput.value = '';
            fileInput.click();
        }
    }

    function downloadLJTemplate() {
        if (typeof XLSX === 'undefined') return alert("Excel library not loaded.");
        const wb = XLSX.utils.book_new();
        // Basit bir şablon, rastgele verilerle
        const ws = XLSX.utils.aoa_to_sheet([["QC_Values"], [98], [102], [99], [101], [100]]);
        XLSX.utils.book_append_sheet(wb, ws, "LJ_Data");
        XLSX.writeFile(wb, "LJ_Template.xlsx");
    }

    function handleLJExcelUpload(input) {
        if (!input.files || input.files.length === 0) return;

        const file = input.files[0];
        const reader = new FileReader();

        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const json = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                
                // İlk satır başlık olabilir diye filtreleyip sadece sayıları alıyoruz
                const newValues = json.flat().map(n => parseFloat(n)).filter(n => !isNaN(n));

                if (newValues.length > 0) {
                    // Mevcut verilerin üzerine mi eklesin yoksa sıfırlasın mı? 
                    // Genelde sıfırdan yüklemek istenir, ama eklemek istersen ljData.push(...newValues) yap.
                    ljData = newValues;
                    renderLJData();
                    const statusSpan = document.getElementById('lj-upload-status');
                    if(statusSpan) {
                        statusSpan.innerText = `${ljData.length} data loaded.`;
                        statusSpan.style.display = 'inline';
                        setTimeout(() => {
                            statusSpan.style.display = 'none';
                        }, 4000);
                    }
                } else {
                    alert("Error: No valid numeric data found in Excel.");
                }
            } catch (error) {
                console.error(error);
                alert("File read error!");
            }
        };
        reader.readAsArrayBuffer(file);
    }
    
    const defaultFavJournals = ['Clinical Chemistry','The Journal of Applied Laboratory Medicine','Laboratory Medicine'];
    const rssMap = {
        'Advances in Laboratory Medicine': 'https://pubmed.ncbi.nlm.nih.gov/rss/search/1z52wgQGrymR2X9hFvtFn2eMNt_ZPOBcHce7z9ZDAilDuOJkxd/?limit=15&utm_campaign=pubmed-2&fc=20260120051449',
        'Annals of Clinical Biochemistry': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/0324055/?limit=15&name=Ann%20Clin%20Biochem&utm_campaign=journals',
        'Annals of Laboratory Medicine': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/101571172/?limit=15&name=Ann%20Lab%20Med&utm_campaign=journals',
        'Biochemia Medica': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/9610305/?limit=15&name=Biochem%20Med%20%28Zagreb%29&utm_campaign=journals',
        'Clinica Chimica Acta': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/1302422/?limit=15&name=Clin%20Chim%20Acta&utm_campaign=journals',
        'Clinical Chemistry and Laboratory Medicine': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/9806306/?limit=15&name=Clin%20Chem%20Lab%20Med&utm_campaign=journals',
        'Clinical Chemistry': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/9421549/?limit=15&name=Clin%20Chem&utm_campaign=journals',
        'American Journal of Clinical Pathology': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/0370470/?limit=15&name=Am%20J%20Clin%20Pathol&utm_campaign=journals',
        'Critical Reviews in Clinical Laboratory Sciences': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/8914816/?limit=15&name=Crit%20Rev%20Clin%20Lab%20Sci&utm_campaign=journals',
        'eJIFCC': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/101092742/?limit=15&name=EJIFCC&utm_campaign=journals',
        'International Journal of Analytical Chemistry': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/101519424/?limit=15&name=Int%20J%20Anal%20Chem&utm_campaign=journals',
        'Journal of Analytical Toxicology': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/7705085/?limit=15&name=J%20Anal%20Toxicol&utm_campaign=journals',
        'Journal of Clinical Laboratory Analysis': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/8801384/?limit=15&name=J%20Clin%20Lab%20Anal&utm_campaign=journals',
        'Laboratory Medicine': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/0250641/?limit=15&name=Lab%20Med&utm_campaign=journals',
        'Clinical Laboratory': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/9705611/?limit=15&name=Clin%20Lab&utm_campaign=journals',
        'Applied Biochemistry and Biotechnology': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/8208561/?limit=15&name=Appl%20Biochem%20Biotechnol&utm_campaign=journals',
        'Indian Journal of Clinical Biochemistry': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/8708303/?limit=15&name=Indian%20J%20Clin%20Biochem&utm_campaign=journals',
        'Journal of Laboratory Automation': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/101558509/?limit=15&name=J%20Lab%20Autom&utm_campaign=journals',
        'Chemistry and Physics of Lipids': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/0067206/?limit=15&name=Chem%20Phys%20Lipids&utm_campaign=journals',
        'Biological Trace Element Research': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/7911509/?limit=15&name=Biol%20Trace%20Elem%20Res&utm_campaign=journals',
        'Clinical and Experimental Medicine': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/100973405/?limit=15&name=Clin%20Exp%20Med&utm_campaign=journals',
        'Annals of Clinical & Laboratory Science': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/0410247/?limit=15&name=Ann%20Clin%20Lab%20Sci&utm_campaign=journals',
        'Practical Laboratory Medicine': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/101690848/?limit=15&name=Pract%20Lab%20Med&utm_campaign=journals',
        'Scandinavian Journal of Clinical and Laboratory Investigation': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/2984789R/?limit=15&name=Scand%20J%20Clin%20Lab%20Invest%20Suppl&utm_campaign=journals',
        'The Journal of Applied Laboratory Medicine': 'https://pubmed.ncbi.nlm.nih.gov/rss/journals/101693884/?limit=15&name=J%20Appl%20Lab%20Med&utm_campaign=journals'
    };
    function initPubMedJournals() {
        const sel = document.getElementById('favJournalSelect');
        if (!sel) return;
        const stored = JSON.parse(localStorage.getItem('favJournals') || '[]');
        const journals = (stored.length ? stored : defaultFavJournals).filter(j => rssMap[j]);
        sel.innerHTML = '';
        journals.forEach(j => {
            const opt = document.createElement('option');
            opt.value = j;
            opt.textContent = j;
            opt.selected = true;
            sel.appendChild(opt);
        });
    }
    function addFavJournal() {
        const inp = document.getElementById('favJournalInput');
        const sel = document.getElementById('favJournalSelect');
        if (!inp || !sel) return;
        const name = (inp.value || '').trim();
        if (!name) return;
        const stored = JSON.parse(localStorage.getItem('favJournals') || '[]');
        if (!stored.includes(name)) stored.push(name);
        localStorage.setItem('favJournals', JSON.stringify(stored));
        initPubMedJournals();
        inp.value = '';
    }
    function deleteFavJournal() {
        const inp = document.getElementById('favJournalInput');
        const sel = document.getElementById('favJournalSelect');
        const name = inp ? (inp.value || '').trim() : '';
        const stored = JSON.parse(localStorage.getItem('favJournals') || '[]');
        const target = name || (sel && sel.selectedOptions.length ? sel.selectedOptions[0].value : '');
        if (!target) return;
        const idx = stored.indexOf(target);
        if (idx > -1) {
            stored.splice(idx,1);
            localStorage.setItem('favJournals', JSON.stringify(stored));
            initPubMedJournals();
        }
    }
    function getFavJournals() {
        return JSON.parse(localStorage.getItem('favJournals') || '[]');
    }
    function setFavJournals(arr) {
        localStorage.setItem('favJournals', JSON.stringify(arr));
    }
    function toggleFav(name, el) {
        const stored = getFavJournals();
        const idx = stored.indexOf(name);
        if (idx > -1) {
            stored.splice(idx,1);
            el.className = 'btn-action btn-secondary';
            el.textContent = '';
        } else {
            stored.push(name);
            el.className = 'btn-action';
            el.textContent = '✓';
        }
        setFavJournals(stored);
        initJournalListTicks();
    }
    function initJournalListTicks() {
        const stored = getFavJournals();
        document.querySelectorAll('button[data-journal]').forEach(btn => {
            const name = btn.getAttribute('data-journal');
            if (stored.includes(name)) {
                btn.className = 'btn-action';
                btn.textContent = '✓';
            } else {
                btn.className = 'btn-action btn-secondary';
                btn.textContent = '';
            }
        });
    }
    function filterJournalLists() {
        const q = (document.getElementById('journalSearchInput') ? document.getElementById('journalSearchInput').value : '').toLowerCase().trim();
        ['rssJournalList','visitJournalList'].forEach(id => {
            const container = document.getElementById(id);
            if (!container) return;
            container.querySelectorAll('div').forEach(row => {
                const t = row.textContent.toLowerCase();
                row.style.display = q ? (t.includes(q) ? '' : 'none') : '';
            });
        });
    }
    function sortJournalLists() {
        ['rssJournalList','visitJournalList'].forEach(id => {
            const container = document.getElementById(id);
            if (!container) return;
            const rows = Array.from(container.children).filter(el => el.tagName && el.tagName.toLowerCase() === 'div');
            rows.sort((a,b) => {
                const ta = (a.textContent || '').trim().toLowerCase();
                const tb = (b.textContent || '').trim().toLowerCase();
                return ta.localeCompare(tb);
            });
            rows.forEach(r => container.appendChild(r));
        });
    }
    function formatXMLDate(node) {
        if (!node) return '';
        const y = node.querySelector('Year') ? node.querySelector('Year').textContent : '';
        const m = node.querySelector('Month') ? node.querySelector('Month').textContent : '';
        const d = node.querySelector('Day') ? node.querySelector('Day').textContent : '';
        const medline = node.querySelector('MedlineDate') ? node.querySelector('MedlineDate').textContent : '';
        if (medline) return medline;
        let s = '';
        if (y) s += y;
        if (m) s += (s ? ' ' : '') + m;
        if (d) s += ' ' + d;
        return s;
    }
    function formatAuthorsFromArticle(article) {
        const arr = Array.from(article.querySelectorAll('AuthorList > Author')).map(a => {
            const collective = a.querySelector('CollectiveName') ? a.querySelector('CollectiveName').textContent : '';
            if (collective) return collective.trim();
            const fore = a.querySelector('ForeName') ? a.querySelector('ForeName').textContent : '';
            const last = a.querySelector('LastName') ? a.querySelector('LastName').textContent : '';
            return (fore + (fore && last ? ' ' : '') + last).trim();
        }).filter(Boolean);
        return arr.join(', ');
    }
    function renderRSS(xmlText, res) {
        const parser = new DOMParser();
        const xml = parser.parseFromString(xmlText, 'application/xml');
        const items = Array.from(xml.querySelectorAll('item'));
        if (!items.length) { res.innerHTML = '<div style="padding:8px; font-size:0.85rem;">No items</div>'; return; }
        const list = document.createElement('div');
        items.forEach(it => {
            const titleEl = it.querySelector('title');
            const linkEl = it.querySelector('link');
            const dateEl = it.querySelector('pubDate');
            const title = titleEl ? titleEl.textContent : '';
            const link = linkEl ? linkEl.textContent : '';
            const date = dateEl ? dateEl.textContent : '';
            const a = document.createElement('a');
            a.href = link;
            a.target = '_blank';
            a.className = 'journal-link';
            a.textContent = title + (date ? ' (' + date + ')' : '');
            list.appendChild(a);
        });
        res.innerHTML = '';
        res.appendChild(list);
    }
    async function fetchTextWithProxy(url) {
        try {
            const r = await fetch(url);
            if (!r.ok) throw new Error('direct');
            return await r.text();
        } catch {
            const r2 = await fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent(url));
            if (!r2.ok) throw new Error('proxy');
            return await r2.text();
        }
    }
    async function testPubMedRSSFeed() {
        const url = 'https://pubmed.ncbi.nlm.nih.gov/rss/search/1pOFSvgtxnzd0l98jKE8j7BmdZn3nF3UMGOYeiTLdv9ZiJWgKr/?limit=15&utm_campaign=pubmed-2&fc=20260120050753';
        const res = document.getElementById('pubmedJournalResults');
        if (!res) return;
        res.innerHTML = '<div style="padding:8px; font-size:0.85rem;">Loading RSS...</div>';
        try {
            const r = await fetch(url);
            if (!r.ok) throw new Error('direct');
            const txt = await r.text();
            if (!txt || !txt.trim()) throw new Error('empty');
            renderRSS(txt, res);
        } catch (e) {
            try {
                const r2 = await fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent(url));
                if (!r2.ok) throw new Error('proxy');
                const txt2 = await r2.text();
                renderRSS(txt2, res);
            } catch {
                res.innerHTML = '<div style="padding:8px; font-size:0.85rem;">Failed to load RSS</div>';
            }
        }
    }
    async function loadPubMedJournalsLatest() {
    const res = document.getElementById('pubmedJournalResults');
    const countSel = document.getElementById('pubmedCountSelect');
    if (!res || !countSel) return;
    
    const storedFavs = JSON.parse(localStorage.getItem('favJournals') || '[]');
    const journals = storedFavs.length ? storedFavs : defaultFavJournals;
    const retmax = parseInt(countSel.value || '10', 10);

    // --- OTOMATİK TEMİZLİK VE ÖNBELLEK KONTROLÜ ---
    const cachePrefix = "pubmed_cache_";
    const currentCacheKey = cachePrefix + journals.join('_') + "_" + retmax;
    const now = new Date().getTime();

    // 1. Otomatik Temizlik: Diğer dergi kombinasyonlarına ait eski cache'leri siler (Hafıza şişmesini önler)
    Object.keys(localStorage).forEach(key => {
        if (key.startsWith(cachePrefix) && key !== currentCacheKey) {
            localStorage.removeItem(key);
        }
    });

    const cachedData = JSON.parse(localStorage.getItem(currentCacheKey));

    // 2. Zaman Kontrolü: Eğer veriler taze ise (30 dakikadan az) direkt hafızadan yükle
    if (cachedData && (now - cachedData.timestamp < 1800000)) {
        renderPubMedList(cachedData.articles, res);
        console.log("Veriler yerel hafızadan (cache) yüklendi.");
        return;
    }

    res.innerHTML = '<div style="padding:8px; font-size:0.85rem;">Fetching latest articles...</div>';

    try {
        // Paralel Veri Çekme (Hız için)
        const journalPromises = journals.map(async (j) => {
            const items = [];
            const rss = rssMap[j];
            try {
                if (rss) {
                    let url = rss.replace(/limit=\d+/i, 'limit=' + retmax);
                    if (!url.includes('limit=')) url += (url.includes('?') ? '&' : '?') + 'limit=' + retmax;
                    
                    const txt = await fetchTextWithProxy(url);
                    const xml = new DOMParser().parseFromString(txt, 'application/xml');
                    
                    Array.from(xml.querySelectorAll('item')).slice(0, retmax).forEach(it => {
                        const link = it.querySelector('link')?.textContent || '';
                        const rawDate = it.querySelector('pubDate')?.textContent || '';
                        
                        // Tarih Sadeleştirme: "Fri, 16 Jan 2026 06:00:00 -0500" -> "16 Jan 2026"
                        const dateParts = rawDate.split(' ');
                        const cleanDate = dateParts.length > 3 ? `${dateParts[1]} ${dateParts[2]} ${dateParts[3]}` : rawDate;

                        items.push({
                            title: it.querySelector('title')?.textContent || '',
                            link: link,
                            journal: j,
                            date: cleanDate,
                            pmid: link.match(/pubmed\.ncbi\.nlm\.nih\.gov\/(\d+)/)?.[1] || it.querySelector('guid')?.textContent?.match(/(\d+)/)?.[1]
                        });
                    });
                } else {
                    // RSS olmayanlar için E-search
                    const term = `"${j}"[jour]`;
                    const s = await fetch(`https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&retmode=json&sort=pub+date&retmax=${retmax}&term=${encodeURIComponent(term)}`);
                    const sjson = await s.json();
                    const ids = sjson.esearchresult?.idlist || [];
                    if (ids.length) {
                        const f = await fetch(`https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=pubmed&retmode=xml&id=${ids.join(',')}`);
                        const xmlText = await f.text();
                        const xml = new DOMParser().parseFromString(xmlText, 'application/xml');
                        Array.from(xml.querySelectorAll('PubmedArticle')).forEach(a => {
                            const pmid = a.querySelector('PMID')?.textContent || '';
                            const pubDateNode = a.querySelector('ArticleDate[DateType="Electronic"]') || a.querySelector('JournalIssue > PubDate');
                            items.push({
                                title: a.querySelector('ArticleTitle')?.textContent || '',
                                link: pmid ? `https://pubmed.ncbi.nlm.nih.gov/${pmid}/` : '',
                                journal: j,
                                date: formatXMLDate(pubDateNode),
                                authors: formatAuthorsFromArticle(a),
                                pmid: pmid
                            });
                        });
                    }
                }
            } catch (e) { console.error(`${j} fetch error:`, e); }
            return items;
        });

        const resultsArray = await Promise.all(journalPromises);
        let allItems = resultsArray.flat();

        // Eksik yazarları toplu çekme
        const pmidsToFetch = Array.from(new Set(allItems.filter(x => !x.authors && x.pmid).map(x => x.pmid)));
        if (pmidsToFetch.length) {
            const f2 = await fetch(`https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=pubmed&retmode=xml&id=${pmidsToFetch.join(',')}`);
            if (f2.ok) {
                const xml2 = new DOMParser().parseFromString(await f2.text(), 'application/xml');
                const authorMap = {};
                Array.from(xml2.querySelectorAll('PubmedArticle')).forEach(a => {
                    const pmid = a.querySelector('PMID')?.textContent;
                    if (pmid) authorMap[pmid] = formatAuthorsFromArticle(a);
                });
                allItems.forEach(it => { if (!it.authors && authorMap[it.pmid]) it.authors = authorMap[it.pmid]; });
            }
        }

        // --- VERİLERİ ÖNBELLEĞE KAYDET ---
        localStorage.setItem(currentCacheKey, JSON.stringify({
            timestamp: now,
            articles: allItems
        }));

        renderPubMedList(allItems, res);

    } catch (err) {
        res.innerHTML = '<div style="padding:8px; font-size:0.85rem;">Failed to load.</div>';
    }
}

// Yardımcı Fonksiyon: Makaleleri Ekrana Basar
function renderPubMedList(articles, container) {
    if (!articles.length) { container.innerHTML = '<div style="padding:8px; font-size:0.85rem;">No items found.</div>'; return; }
    container.innerHTML = '';
    const listDiv = document.createElement('div');
    articles.forEach(it => {
        const a = document.createElement('a');
        a.href = it.link;
        a.target = '_blank';
        a.className = 'journal-link';
        const authorPart = it.authors ? ` — ${it.authors}` : '';
        // Format: Makale Adı — Yazarlar — Tarih — Dergi Adı
        a.textContent = `${it.title}${authorPart} — ${it.date} — ${it.journal}`;
        listDiv.appendChild(a);
    });
    container.appendChild(listDiv);
}

function calculateRCV() {
    const oldVal = parseFloat(document.getElementById('rcv-old').value);
    const newVal = parseFloat(document.getElementById('rcv-new').value);
    const cvi = parseFloat(document.getElementById('rcv-cvi').value);
    const cvg = parseFloat(document.getElementById('rcv-cvg').value);
    const z = parseFloat(document.getElementById('rcv-z').value);
    
    const resultDiv = document.getElementById('rcv-result');
    const percentDiv = document.getElementById('rcv-percent');
    const valueDiv = document.getElementById('rcv-value');
    const iiDiv = document.getElementById('rcv-ii');
    const conclusionDiv = document.getElementById('rcv-conclusion');
    
    // Debug - Konsola yazdır
    console.log('Old:', oldVal, 'New:', newVal, 'CVI:', cvi, 'CVG:', cvg, 'Z:', z);
    
    if (isNaN(oldVal) || isNaN(newVal) || isNaN(cvi) || isNaN(cvg)) {
        alert('Please fill in all required fields!');
        resultDiv.style.display = 'none';
        return;
    }
    
    // Percent difference
    const percentDiff = Math.abs((oldVal - newVal) / oldVal) * 100;
    
    // RCV formula
    const rcv = z * Math.sqrt(2) * Math.sqrt(Math.pow(cvi, 2) + Math.pow(cvg, 2));
    
    // Individuality Index
    const ii = cvi / cvg;
    
    // Conclusion
    const isSignificant = percentDiff > rcv;
    
    percentDiv.innerHTML = `Percent Difference: <strong>${percentDiff.toFixed(2)}%</strong>`;
    valueDiv.innerHTML = `RCV (${z === 1.96 ? 'p<0.05' : 'p<0.01'}): <strong>${rcv.toFixed(2)}%</strong>`;
    iiDiv.innerHTML = `Individuality Index: <strong>${ii.toFixed(2)}</strong>`;
    
    if (isSignificant) {
        conclusionDiv.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> There is a difference between the patient’s previous result and the current result.';
        conclusionDiv.style.backgroundColor = 'rgba(220, 38, 38, 0.15)';
        conclusionDiv.style.color = '#dc2626';
    } else {
        conclusionDiv.innerHTML = '<i class="fa-solid fa-check-circle"></i> There is no difference between the patient’s previous result and the current result.';
        conclusionDiv.style.backgroundColor = 'rgba(22, 163, 74, 0.15)';
        conclusionDiv.style.color = '#16a34a';
    }
    
    resultDiv.style.display = 'block';
}

function calculateII() {
    const cvi = parseFloat(document.getElementById('ii-cvi').value);
    const cvg = parseFloat(document.getElementById('ii-cvg').value);
    
    const resultDiv = document.getElementById('ii-result');
    const valueDiv = document.getElementById('ii-value');
    const interpretDiv = document.getElementById('ii-interpretation');
    
    if (isNaN(cvi) || isNaN(cvg) || cvg === 0) {
        resultDiv.style.display = 'none';
        return;
    }
    
    const ii = cvi / cvg;
    
    valueDiv.innerHTML = `II = ${ii.toFixed(2)}`;
    
    let interpretation = '';
    let bgColor = '';
    let textColor = '';
    
    if (ii < 0.6) {
        interpretation = '<i class="fa-solid fa-user"></i> <strong>High Individuality:</strong> Results should preferably be evaluated against the patient\'s own previous results (serial monitoring recommended).';
        bgColor = 'rgba(59, 130, 246, 0.15)';
        textColor = '#2563eb';
    } else if (ii > 1.4) {
        interpretation = '<i class="fa-solid fa-users"></i> <strong>Low Individuality:</strong> Results should be evaluated against population-based reference intervals.';
        bgColor = 'rgba(139, 92, 246, 0.15)';
        textColor = '#7c3aed';
    } else {
        interpretation = '<i class="fa-solid fa-info-circle"></i> <strong>Moderate Individuality:</strong> Both reference intervals and serial monitoring can be useful for interpretation.';
        bgColor = 'rgba(245, 158, 11, 0.15)';
        textColor = '#d97706';
    }
    
    interpretDiv.innerHTML = interpretation;
    interpretDiv.style.backgroundColor = bgColor;
    interpretDiv.style.color = textColor;
    
    resultDiv.style.display = 'block';
}

function runCarryover() {
    function val(id) { const v = parseFloat(document.getElementById(id).value); return isNaN(v) ? null : v; }
    const L = [val('carry-L1'), val('carry-L2'), val('carry-L3'), val('carry-L4'), val('carry-L5'), val('carry-L6'), val('carry-L7'), val('carry-L8'), val('carry-L9'), val('carry-L10'), val('carry-L11')];
    const tea = parseFloat(document.getElementById('carry-tea').value);
    const groupLL = [L[1], L[2], L[5], L[6], L[7]].filter(x => x !== null);
    const groupLH = [L[3], L[4], L[8], L[9], L[10]].filter(x => x !== null);
    function mean(arr){ if(arr.length===0) return NaN; return arr.reduce((a,b)=>a+b,0)/arr.length; }
    function sd(arr){ if(arr.length<2) return 0; const m=mean(arr); const v=arr.reduce((a,b)=>a+Math.pow(b-m,2),0)/(arr.length-1); return Math.sqrt(v); }
    const mLL = mean(groupLL);
    const sLL = sd(groupLL);
    const mLH = mean(groupLH);
    const sLH = sd(groupLH);
    const diff = mLH - mLL;
    const thr3sd = 3 * sLL;
    const resBox = document.getElementById('carry-result');
    const sumBox = document.getElementById('carry-summary');
    const statBox = document.getElementById('carry-group-stats');
    const conclBox = document.getElementById('carry-conclusion');
    if(!isFinite(mLL) || !isFinite(mLH)) { alert('Please enter values for required L replicates.'); resBox.style.display='none'; return; }
    sumBox.innerHTML = `L after L: mean ${mLL.toFixed(2)}, SD ${sLL.toFixed(2)} | L after H: mean ${mLH.toFixed(2)}, SD ${sLH.toFixed(2)} | Difference: ${diff.toFixed(2)}`;
    const g1 = groupLL.map((v,i)=>`L${[2,3,6,7,8][i]}=${v}`).join(' • ');
    const g2 = groupLH.map((v,i)=>`L${[4,5,9,10,11][i]}=${v}`).join(' • ');
    statBox.innerHTML = `<div style="margin-bottom:6px;">Group A (L after L): ${g1 || 'NA'}</div><div>Group B (L after H): ${g2 || 'NA'}</div><div style="margin-top:8px; font-weight:600; color:var(--primary);">TEa: ${isNaN(tea)?'NA (Please enter TEa value)':tea.toFixed(2)} | 3×SD(L after L): ${thr3sd.toFixed(2)}</div>`;
    const passTEa = !isNaN(tea) ? Math.abs(diff) <= tea : true;
    const pass3sd = Math.abs(diff) <= thr3sd;
    if(passTEa && pass3sd) {
        conclBox.style.backgroundColor = 'rgba(22,163,74,0.15)';
        conclBox.style.color = '#16a34a';
        conclBox.innerHTML = 'No significant carryover detected.';
    } else {
        conclBox.style.backgroundColor = 'rgba(220,38,38,0.15)';
        conclBox.style.color = '#dc2626';
        conclBox.innerHTML = 'Significant carryover suspected.';
    }
    resBox.style.display = 'block';
}
</script>
</body>
</html>
